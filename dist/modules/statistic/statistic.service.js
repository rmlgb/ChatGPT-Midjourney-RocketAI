'use strict';function _0x144a(){const _0x5618b0=['14JxrfxZ','InjectRepository','groupBy','now','chatlog.createdAt\x20>=\x20:startDate','chatLog','StatisticService','select','user.createdAt\x20<\x20:tomorrow','data','setHours','default','5oWWZdJ','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','countOrders','DeductionKey','value','getBaiduVisit','getDate','countUsers','defineProperty','midjourney','midjourneyEntity','chatLog.createdAt\x20<\x20:tomorrow','2277YPPUHq','countNewDrawsToday','formatDate','__param','getRawMany','function','countDraws','chatlog','midjourney.status\x20=\x20:status','&end_date=','chatLog.createdAt\x20>=\x20:today','setDate','countChats','chatLogEntity','push','../../common/constants/balance.constant','M.DD','获取百度统计数据失败','1846wdAvzn','countMjDrawsByTimeRange','result','user.createdAt\x20>=\x20:today','where','../globalConfig/config.entity','HttpException','orderBy','countNewOrdersToday','HttpStatus','countNewChatsToday','getCount','../user/user.entity','OrderEntity','baiduSiteId','MidjourneyEntity','overview/getTimeTrendRpt','configVal','getBaseStatistic','ConfigEntity','map','../chatLog/chatLog.entity','146136rxFxrn','PAINT_TYPE','design:paramtypes','object','createQueryBuilder','midjourney.createdAt\x20<\x20:tomorrow','date','count','Repository','orderEntity','MidjourneyStatusEnum','409817FKxepV','order','userEntity','axios','configEntity','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','&start_date=','configKey','andWhere','__metadata','countNewUsersToday','BAD_REQUEST','11220EVCspo','6592mBZeLZ','ChatLogEntity','&method=','CHAT_TYPE','metadata','countNewMidhourneysToday','countChatsByTimeRange','countDrawsByTimeRange','1719032ZCTxlk','../../common/constants/midjourney.constant','baiduToken','2gKTQnY','3402HzrPmv','1019286JuLAYv','chatLog.type\x20=\x20:type','请先配置百度统计accessToken','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','@nestjs/common','getOwnPropertyDescriptor','getChatStatistic','find','723156aLQHyi','百度授权码过期','YYYYMMDD','@nestjs/typeorm','Injectable','getTime','length','__decorate','decorate'];_0x144a=function(){return _0x5618b0;};return _0x144a();}const _0x2df418=_0x4258;(function(_0x3c1d78,_0x1b182c){const _0xbdef89=_0x4258,_0xbecb5f=_0x3c1d78();while(!![]){try{const _0x1d59f2=parseInt(_0xbdef89(0xd8))/0x1*(parseInt(_0xbdef89(0xf0))/0x2)+parseInt(_0xbdef89(0xfa))/0x3+parseInt(_0xbdef89(0xed))/0x4*(parseInt(_0xbdef89(0x10f))/0x5)+parseInt(_0xbdef89(0xf2))/0x6*(parseInt(_0xbdef89(0x103))/0x7)+parseInt(_0xbdef89(0xe5))/0x8*(parseInt(_0xbdef89(0xf1))/0x9)+parseInt(_0xbdef89(0xe4))/0xa*(parseInt(_0xbdef89(0x11b))/0xb)+parseInt(_0xbdef89(0x143))/0xc*(-parseInt(_0xbdef89(0x12d))/0xd);if(_0x1d59f2===_0x1b182c)break;else _0xbecb5f['push'](_0xbecb5f['shift']());}catch(_0x51d62b){_0xbecb5f['push'](_0xbecb5f['shift']());}}}(_0x144a,0x39557));function _0x4258(_0xaa765b,_0x52f1b0){const _0x144a3f=_0x144a();return _0x4258=function(_0x425897,_0x30515e){_0x425897=_0x425897-0xd2;let _0x55d75a=_0x144a3f[_0x425897];return _0x55d75a;},_0x4258(_0xaa765b,_0x52f1b0);}var __decorate=this&&this[_0x2df418(0x101)]||function(_0x57251c,_0x198a97,_0x8089be,_0x50aafb){const _0x558515=_0x2df418;var _0x2d1fdc=arguments[_0x558515(0x100)],_0x1a681d=_0x2d1fdc<0x3?_0x198a97:_0x50aafb===null?_0x50aafb=Object[_0x558515(0xf7)](_0x198a97,_0x8089be):_0x50aafb,_0xced813;if(typeof Reflect===_0x558515(0x146)&&typeof Reflect[_0x558515(0x102)]===_0x558515(0x120))_0x1a681d=Reflect[_0x558515(0x102)](_0x57251c,_0x198a97,_0x8089be,_0x50aafb);else{for(var _0x1d9dfe=_0x57251c['length']-0x1;_0x1d9dfe>=0x0;_0x1d9dfe--)if(_0xced813=_0x57251c[_0x1d9dfe])_0x1a681d=(_0x2d1fdc<0x3?_0xced813(_0x1a681d):_0x2d1fdc>0x3?_0xced813(_0x198a97,_0x8089be,_0x1a681d):_0xced813(_0x198a97,_0x8089be))||_0x1a681d;}return _0x2d1fdc>0x3&&_0x1a681d&&Object[_0x558515(0x117)](_0x198a97,_0x8089be,_0x1a681d),_0x1a681d;},__metadata=this&&this[_0x2df418(0xe1)]||function(_0xa55496,_0x597c76){const _0x4c1789=_0x2df418;if(typeof Reflect==='object'&&typeof Reflect[_0x4c1789(0xe9)]===_0x4c1789(0x120))return Reflect[_0x4c1789(0xe9)](_0xa55496,_0x597c76);},__param=this&&this[_0x2df418(0x11e)]||function(_0x2a59b0,_0x3c1df6){return function(_0x418bb2,_0x14f95e){_0x3c1df6(_0x418bb2,_0x14f95e,_0x2a59b0);};};Object[_0x2df418(0x117)](exports,'__esModule',{'value':!![]}),exports[_0x2df418(0x109)]=void 0x0;const common_1=require(_0x2df418(0xf6)),typeorm_1=require(_0x2df418(0xfd)),user_entity_1=require(_0x2df418(0x139)),typeorm_2=require('typeorm'),chatLog_entity_1=require(_0x2df418(0x142)),balance_constant_1=require(_0x2df418(0x12a)),date_1=require('../../common/utils/date'),axios_1=require(_0x2df418(0xdb)),config_entity_1=require(_0x2df418(0x132)),order_entity_1=require('../order/order.entity'),midjourney_entity_1=require('../midjourney/midjourney.entity'),midjourney_constant_1=require(_0x2df418(0xee));let StatisticService=class StatisticService{constructor(_0x156710,_0x50f5a0,_0x1274c3,_0xcfb45f,_0x4fe0d5){const _0x5dc302=_0x2df418;this[_0x5dc302(0xda)]=_0x156710,this[_0x5dc302(0x128)]=_0x50f5a0,this[_0x5dc302(0xdc)]=_0x1274c3,this['orderEntity']=_0xcfb45f,this[_0x5dc302(0x119)]=_0x4fe0d5;}async[_0x2df418(0x13f)](){const _0x5d9f01=_0x2df418,_0x3c933c=await this[_0x5d9f01(0x116)](),_0x3b5a41=await this[_0x5d9f01(0xe2)](),_0x2fb5f2=await this[_0x5d9f01(0x127)](),_0xb7b08c=await this[_0x5d9f01(0x137)](),_0x5e5c23=await this[_0x5d9f01(0x121)](),_0x4fd081=await this[_0x5d9f01(0x11c)](),_0x330137=await this[_0x5d9f01(0xea)](),_0x46ab98=await this[_0x5d9f01(0x111)](),_0x168233=await this[_0x5d9f01(0x135)]();return{'userCount':_0x3c933c,'newUserCount':_0x3b5a41,'chatCount':_0x2fb5f2,'newChatCount':_0xb7b08c,'drawCount':_0x5e5c23,'newDrawCount':_0x330137+_0x4fd081,'orderCount':_0x46ab98,'newOrderCount':_0x168233};}async[_0x2df418(0xf8)]({days:days=0x7}){const _0x41eeca=_0x2df418,_0x1bc013=await this[_0x41eeca(0xeb)](days),_0x641d8e=await this['countDrawsByTimeRange'](days),_0x5cab32=await this[_0x41eeca(0x12e)](days);return{'date':_0x1bc013[_0x41eeca(0x141)](_0x43ebdb=>_0x43ebdb[_0x41eeca(0xd3)]),'chat':_0x1bc013['map'](_0x34790d=>_0x34790d[_0x41eeca(0x113)]),'draw':_0x641d8e[_0x41eeca(0x141)]((_0x5b9dc3,_0x2a1099)=>{const _0xa79bac=_0x41eeca;return _0x5b9dc3['value']+_0x5cab32[_0x2a1099][_0xa79bac(0x113)];})};}async[_0x2df418(0x114)]({days:days=0x7}){const _0x386567=await this['getBaiduStatistics'](days);return _0x386567;}async['countUsers'](){const _0x2e8efb=_0x2df418,_0x2c2c71=await this[_0x2e8efb(0xda)][_0x2e8efb(0xd4)]();return _0x2c2c71;}async[_0x2df418(0xe2)](){const _0x29cd26=_0x2df418,_0x2fb23b=new Date();_0x2fb23b[_0x29cd26(0x10d)](0x0,0x0,0x0,0x0);const _0x32bc8a=new Date(_0x2fb23b[_0x29cd26(0xff)]()+0x18*0x3c*0x3c*0x3e8),_0x3b04aa=this['userEntity'][_0x29cd26(0x147)]('user'),_0x7f882e=await _0x3b04aa['where'](_0x29cd26(0x130),{'today':_0x2fb23b})[_0x29cd26(0xe0)](_0x29cd26(0x10b),{'tomorrow':_0x32bc8a})[_0x29cd26(0x138)]();return _0x7f882e;}async[_0x2df418(0x127)](){const _0x202a1e=_0x2df418,_0x20a357=await this[_0x202a1e(0x128)][_0x202a1e(0xd4)]({'where':{'type':balance_constant_1[_0x202a1e(0x112)][_0x202a1e(0xe8)]}});return _0x20a357;}async[_0x2df418(0x137)](){const _0x40452f=_0x2df418,_0x329cff=new Date();_0x329cff['setHours'](0x0,0x0,0x0,0x0);const _0xb890fb=new Date(_0x329cff[_0x40452f(0xff)]()+0x18*0x3c*0x3c*0x3e8),_0x27b3b4=this[_0x40452f(0x128)][_0x40452f(0x147)](_0x40452f(0x108)),_0x4aca51=await _0x27b3b4[_0x40452f(0x131)](_0x40452f(0xf3),{'type':balance_constant_1[_0x40452f(0x112)][_0x40452f(0xe8)]})[_0x40452f(0xe0)](_0x40452f(0x125),{'today':_0x329cff})['andWhere'](_0x40452f(0x11a),{'tomorrow':_0xb890fb})['getCount']();return _0x4aca51;}async['countDraws'](){const _0x398af8=_0x2df418,_0x3ec554=await this[_0x398af8(0x128)][_0x398af8(0xd4)]({'where':{'type':balance_constant_1[_0x398af8(0x112)][_0x398af8(0x144)]}});return _0x3ec554;}async[_0x2df418(0x11c)](){const _0x53f3c6=_0x2df418,_0x146dfb=new Date();_0x146dfb[_0x53f3c6(0x10d)](0x0,0x0,0x0,0x0);const _0x2a99af=new Date(_0x146dfb[_0x53f3c6(0xff)]()+0x18*0x3c*0x3c*0x3e8),_0x2d5548=this[_0x53f3c6(0x128)]['createQueryBuilder']('chatLog'),_0x475ecd=await _0x2d5548[_0x53f3c6(0x131)](_0x53f3c6(0xf3),{'type':balance_constant_1[_0x53f3c6(0x112)]['PAINT_TYPE']})['andWhere']('chatLog.createdAt\x20>=\x20:today',{'today':_0x146dfb})['andWhere'](_0x53f3c6(0x11a),{'tomorrow':_0x2a99af})['getCount']();return _0x475ecd;}async[_0x2df418(0xea)](){const _0x5910f1=_0x2df418,_0x17f0f7=new Date();_0x17f0f7[_0x5910f1(0x10d)](0x0,0x0,0x0,0x0);const _0x23964e=new Date(_0x17f0f7[_0x5910f1(0xff)]()+0x18*0x3c*0x3c*0x3e8),_0x17755b=this['midjourneyEntity'][_0x5910f1(0x147)](_0x5910f1(0x118)),_0x50bbce=await _0x17755b[_0x5910f1(0x131)]('midjourney.createdAt\x20>=\x20:today',{'today':_0x17f0f7})[_0x5910f1(0xe0)](_0x5910f1(0xd2),{'tomorrow':_0x23964e})[_0x5910f1(0x138)]();return _0x50bbce;}async[_0x2df418(0xeb)](_0x3b9d65){const _0x5952dd=_0x2df418;var _0x4fcf07,_0x3f03ef;const _0x152173=new Date();_0x152173[_0x5952dd(0x10d)](0x0,0x0,0x0,0x0);const _0x3fa950=new Date(_0x152173['getTime']()-(_0x3b9d65-0x1)*0x18*0x3c*0x3c*0x3e8),_0x171f46=this[_0x5952dd(0x128)]['createQueryBuilder'](_0x5952dd(0x122)),_0x417efb=await _0x171f46['select'](_0x5952dd(0x110))[_0x5952dd(0x131)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1['DeductionKey'][_0x5952dd(0xe8)]})[_0x5952dd(0xe0)](_0x5952dd(0x107),{'startDate':_0x3fa950})['groupBy']('date')['orderBy']('date')[_0x5952dd(0x11f)](),_0x5f4034=[],_0x47bbc4=_0x3fa950;for(let _0x1aa42b=0x0;_0x1aa42b<_0x3b9d65;_0x1aa42b++){const _0x177137=(0x0,date_1[_0x5952dd(0x11d)])(new Date(_0x47bbc4),_0x5952dd(0x12b)),_0x10253a=(_0x3f03ef=(_0x4fcf07=_0x417efb['find'](_0x142274=>(0x0,date_1['formatDate'])(new Date(_0x142274[_0x5952dd(0xd3)]),_0x5952dd(0x12b))===_0x177137))===null||_0x4fcf07===void 0x0?void 0x0:_0x4fcf07['count'])!==null&&_0x3f03ef!==void 0x0?_0x3f03ef:0x0;_0x10253a>0x0?_0x5f4034[_0x5952dd(0x129)]({'date':_0x177137,'value':Number(_0x10253a)}):_0x5f4034[_0x5952dd(0x129)]({'date':_0x177137,'value':0x0}),_0x47bbc4[_0x5952dd(0x126)](_0x47bbc4[_0x5952dd(0x115)]()+0x1);}return _0x5f4034;}async[_0x2df418(0xec)](_0x29cc72){const _0x4e4f11=_0x2df418;var _0x4041b4,_0x4427b6;const _0x5d2864=new Date();_0x5d2864['setHours'](0x0,0x0,0x0,0x0);const _0x2884fa=new Date(_0x5d2864['getTime']()-(_0x29cc72-0x1)*0x18*0x3c*0x3c*0x3e8),_0x3ef272=this[_0x4e4f11(0x128)]['createQueryBuilder'](_0x4e4f11(0x122)),_0x1b2f83=await _0x3ef272[_0x4e4f11(0x10a)]('DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count')[_0x4e4f11(0x131)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1[_0x4e4f11(0x112)][_0x4e4f11(0x144)]})[_0x4e4f11(0xe0)](_0x4e4f11(0x107),{'startDate':_0x2884fa})[_0x4e4f11(0x105)](_0x4e4f11(0xd3))[_0x4e4f11(0x134)](_0x4e4f11(0xd3))[_0x4e4f11(0x11f)](),_0x5ce2e3=[],_0x5a5fa3=_0x2884fa;for(let _0x23632a=0x0;_0x23632a<_0x29cc72;_0x23632a++){const _0x5598a0=(0x0,date_1['formatDate'])(new Date(_0x5a5fa3),_0x4e4f11(0x12b)),_0x5253cb=(_0x4427b6=(_0x4041b4=_0x1b2f83[_0x4e4f11(0xf9)](_0x49f9e6=>(0x0,date_1['formatDate'])(new Date(_0x49f9e6[_0x4e4f11(0xd3)]),_0x4e4f11(0x12b))===_0x5598a0))===null||_0x4041b4===void 0x0?void 0x0:_0x4041b4['count'])!==null&&_0x4427b6!==void 0x0?_0x4427b6:0x0;_0x5253cb>0x0?_0x5ce2e3[_0x4e4f11(0x129)]({'date':_0x5598a0,'value':Number(_0x5253cb)}):_0x5ce2e3['push']({'date':_0x5598a0,'value':0x0}),_0x5a5fa3[_0x4e4f11(0x126)](_0x5a5fa3[_0x4e4f11(0x115)]()+0x1);}return _0x5ce2e3;}async[_0x2df418(0x12e)](_0x1d91b3){const _0x26399a=_0x2df418;var _0x551d31,_0x2a792a;const _0x204565=new Date();_0x204565[_0x26399a(0x10d)](0x0,0x0,0x0,0x0);const _0x4c88eb=new Date(_0x204565[_0x26399a(0xff)]()-(_0x1d91b3-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2cd7ad=this[_0x26399a(0x119)][_0x26399a(0x147)](_0x26399a(0x118)),_0x1cf04b=await _0x2cd7ad['select'](_0x26399a(0xdd))[_0x26399a(0x131)](_0x26399a(0x123),{'status':midjourney_constant_1[_0x26399a(0xd7)]['DRAWED']})[_0x26399a(0xe0)]('midjourney.createdAt\x20>=\x20:startDate',{'startDate':_0x4c88eb})[_0x26399a(0x105)](_0x26399a(0xd3))[_0x26399a(0x134)]('date')['getRawMany'](),_0x5adb65=[],_0x39d76b=_0x4c88eb;for(let _0x940478=0x0;_0x940478<_0x1d91b3;_0x940478++){const _0x3f0b98=(0x0,date_1[_0x26399a(0x11d)])(new Date(_0x39d76b),_0x26399a(0x12b)),_0x5ddfe4=(_0x2a792a=(_0x551d31=_0x1cf04b[_0x26399a(0xf9)](_0x4d203d=>(0x0,date_1[_0x26399a(0x11d)])(new Date(_0x4d203d['date']),_0x26399a(0x12b))===_0x3f0b98))===null||_0x551d31===void 0x0?void 0x0:_0x551d31['count'])!==null&&_0x2a792a!==void 0x0?_0x2a792a:0x0;_0x5ddfe4>0x0?_0x5adb65[_0x26399a(0x129)]({'date':_0x3f0b98,'value':Number(_0x5ddfe4)}):_0x5adb65[_0x26399a(0x129)]({'date':_0x3f0b98,'value':0x0}),_0x39d76b[_0x26399a(0x126)](_0x39d76b['getDate']()+0x1);}return _0x5adb65;}async['getBaiduStatistics'](_0x16873a){const _0x43bc80=_0x2df418;var _0xb8b0c4,_0x397e72;const _0x2500eb=(0x0,date_1['formatDate'])(new Date(),_0x43bc80(0xfc)),_0x44b1d5=(0x0,date_1[_0x43bc80(0x11d)])(new Date(Date[_0x43bc80(0x106)]()-Number(_0x16873a-0x1)*0x18*0x3c*0x3c*0x3e8),'YYYYMMDD'),_0x2f15df='pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time',_0x565ebe=_0x43bc80(0x13d),_0x3933df=await this[_0x43bc80(0xdc)][_0x43bc80(0xf9)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x43bc80(0xef),_0x43bc80(0x13b)])}}),_0x1f7da1=(_0xb8b0c4=_0x3933df[_0x43bc80(0xf9)](_0x45fa66=>_0x45fa66[_0x43bc80(0xdf)]===_0x43bc80(0x13b)))===null||_0xb8b0c4===void 0x0?void 0x0:_0xb8b0c4[_0x43bc80(0x13e)],_0x41170c=(_0x397e72=_0x3933df[_0x43bc80(0xf9)](_0x4f8bca=>_0x4f8bca['configKey']===_0x43bc80(0xef)))===null||_0x397e72===void 0x0?void 0x0:_0x397e72['configVal'];if(!_0x1f7da1||!_0x41170c)return[];if(!_0x1f7da1)throw new common_1[(_0x43bc80(0x133))]('请先配置百度统计siteId',common_1['HttpStatus'][_0x43bc80(0xe3)]);if(!_0x41170c)throw new common_1[(_0x43bc80(0x133))](_0x43bc80(0xf4),common_1['HttpStatus'][_0x43bc80(0xe3)]);const _0x2fceea=_0x43bc80(0xf5)+_0x41170c+'&site_id='+_0x1f7da1+_0x43bc80(0xe7)+_0x565ebe+_0x43bc80(0xde)+_0x44b1d5+_0x43bc80(0x124)+_0x2500eb+'&metrics='+_0x2f15df,_0x304c14=await axios_1[_0x43bc80(0x10e)]['get'](_0x2fceea),{error_code:_0x185742,message:_0x462bd6}=_0x304c14[_0x43bc80(0x10c)];if(_0x185742===0x6f)throw new common_1['HttpException'](_0x462bd6||_0x43bc80(0xfb),common_1[_0x43bc80(0x136)][_0x43bc80(0xe3)]);if(_0x185742&&_0x185742!==0xc8)throw new common_1['HttpException'](_0x462bd6||_0x43bc80(0x12c),common_1['HttpStatus'][_0x43bc80(0xe3)]);return _0x304c14[_0x43bc80(0x10c)][_0x43bc80(0x12f)];}async[_0x2df418(0x111)](){const _0xb1433c=_0x2df418,_0x55a03a=await this[_0xb1433c(0xd6)][_0xb1433c(0xd4)]();return _0x55a03a;}async[_0x2df418(0x135)](){const _0x5e5458=_0x2df418,_0x17c158=new Date();_0x17c158[_0x5e5458(0x10d)](0x0,0x0,0x0,0x0);const _0x2159bd=new Date(_0x17c158['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x3fb164=this[_0x5e5458(0xd6)][_0x5e5458(0x147)](_0x5e5458(0xd9)),_0x56f126=await _0x3fb164[_0x5e5458(0x131)]('order.createdAt\x20>=\x20:today',{'today':_0x17c158})['andWhere']('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x2159bd})[_0x5e5458(0x138)]();return _0x56f126;}};StatisticService=__decorate([(0x0,common_1[_0x2df418(0xfe)])(),__param(0x0,(0x0,typeorm_1[_0x2df418(0x104)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x2df418(0x104)])(chatLog_entity_1[_0x2df418(0xe6)])),__param(0x2,(0x0,typeorm_1[_0x2df418(0x104)])(config_entity_1[_0x2df418(0x140)])),__param(0x3,(0x0,typeorm_1[_0x2df418(0x104)])(order_entity_1[_0x2df418(0x13a)])),__param(0x4,(0x0,typeorm_1[_0x2df418(0x104)])(midjourney_entity_1[_0x2df418(0x13c)])),__metadata(_0x2df418(0x145),[typeorm_2[_0x2df418(0xd5)],typeorm_2[_0x2df418(0xd5)],typeorm_2[_0x2df418(0xd5)],typeorm_2[_0x2df418(0xd5)],typeorm_2['Repository']])],StatisticService),exports[_0x2df418(0x109)]=StatisticService;