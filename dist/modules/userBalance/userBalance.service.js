'use strict';function _0x3c98(_0x7dad,_0x191160){const _0x4442b0=_0x4442();return _0x3c98=function(_0x3c98f7,_0x1f783d){_0x3c98f7=_0x3c98f7-0x127;let _0x5c6512=_0x4442b0[_0x3c98f7];return _0x5c6512;},_0x3c98(_0x7dad,_0x191160);}const _0x28b856=_0x3c98;(function(_0x3fad60,_0x236d14){const _0x5a8a8f=_0x3c98,_0x369afd=_0x3fad60();while(!![]){try{const _0x190eb1=parseInt(_0x5a8a8f(0x153))/0x1*(parseInt(_0x5a8a8f(0x1d8))/0x2)+-parseInt(_0x5a8a8f(0x1af))/0x3*(parseInt(_0x5a8a8f(0x19c))/0x4)+-parseInt(_0x5a8a8f(0x135))/0x5*(-parseInt(_0x5a8a8f(0x1e0))/0x6)+parseInt(_0x5a8a8f(0x1b1))/0x7+-parseInt(_0x5a8a8f(0x1d5))/0x8*(-parseInt(_0x5a8a8f(0x181))/0x9)+parseInt(_0x5a8a8f(0x17f))/0xa*(parseInt(_0x5a8a8f(0x15a))/0xb)+-parseInt(_0x5a8a8f(0x188))/0xc;if(_0x190eb1===_0x236d14)break;else _0x369afd['push'](_0x369afd['shift']());}catch(_0x441d23){_0x369afd['push'](_0x369afd['shift']());}}}(_0x4442,0xa6f03));var __decorate=this&&this[_0x28b856(0x139)]||function(_0x202baf,_0x9dcf50,_0xc87f2e,_0x36e383){const _0xb4da5=_0x28b856;var _0x5801ff=arguments[_0xb4da5(0x14e)],_0x4c7928=_0x5801ff<0x3?_0x9dcf50:_0x36e383===null?_0x36e383=Object['getOwnPropertyDescriptor'](_0x9dcf50,_0xc87f2e):_0x36e383,_0x4aa029;if(typeof Reflect===_0xb4da5(0x17d)&&typeof Reflect[_0xb4da5(0x1e7)]===_0xb4da5(0x1e6))_0x4c7928=Reflect['decorate'](_0x202baf,_0x9dcf50,_0xc87f2e,_0x36e383);else{for(var _0x171a71=_0x202baf[_0xb4da5(0x14e)]-0x1;_0x171a71>=0x0;_0x171a71--)if(_0x4aa029=_0x202baf[_0x171a71])_0x4c7928=(_0x5801ff<0x3?_0x4aa029(_0x4c7928):_0x5801ff>0x3?_0x4aa029(_0x9dcf50,_0xc87f2e,_0x4c7928):_0x4aa029(_0x9dcf50,_0xc87f2e))||_0x4c7928;}return _0x5801ff>0x3&&_0x4c7928&&Object[_0xb4da5(0x17a)](_0x9dcf50,_0xc87f2e,_0x4c7928),_0x4c7928;},__metadata=this&&this[_0x28b856(0x149)]||function(_0x2cbad3,_0x325135){const _0x1449a8=_0x28b856;if(typeof Reflect===_0x1449a8(0x17d)&&typeof Reflect[_0x1449a8(0x187)]===_0x1449a8(0x1e6))return Reflect[_0x1449a8(0x187)](_0x2cbad3,_0x325135);},__param=this&&this['__param']||function(_0x19a1a0,_0x4c8131){return function(_0x2a1222,_0x5ee277){_0x4c8131(_0x2a1222,_0x5ee277,_0x19a1a0);};};function _0x4442(){const _0xc6d125=['whiteListEntity','defineProperty','days','用户充值失败！','object','saveRecordRechargeLog','1840810wvXojA','您已经升级过了、请勿重复操作！','104400qrQzZH','@nestjs/common','ChatGroupEntity','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','invitedGuestSendDrawMjCount','FingerprintLogEntity','metadata','4636116GJwBOX','globalConfigService','账户信息已经存在、迁移无效','useModel3Count','InjectRepository','fingerprintLogEntity','user','memberDrawMjCount','goodsId','phone','getConfigs','useModel4Token','useModel4Count','headers','REG_GIFT','inviteGiveSendModel3Count','HttpException','UserBalanceEntity','hideString','isUpdatedToday','1461092dkCcnd','退费失败！','queryUserBalance','add','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','accountLogEntity','getVisitorCount','model3','addBalanceToUser','@nestjs/typeorm','GlobalConfigService','MjCount','packageId','debug','design:paramtypes','---','sumModel4Count','drawMjCount','chatLogEntity','9GccEXx','PAYMENT_REQUIRED','3840627HORdlw','CramiPackageEntity','充值失败！','HttpStatus','upgradeBalance','balanceEntity','total','registerSendDrawMjCount','SalesUsersEntity','invitedGuestSendModel3Count','SCAN_PAY','configEntity','__esModule','userId','username','model3Count','queryUserBalanceByIds','addBalanceToNewUser','查询当前用户余额失败！','format','../chatGroup/chatGroup.entity','./balance.entity','typeorm','查询用户账户信息失败！','Logger','save','createRandomUid','registerSendModel4Count','inviteSendStatus','inviteGiveSendDrawMjCount','model4','getDate','BalanceEntity','../chatLog/chatLog.entity','userBalanceEntity','weight','216GTqHcA','validateBalance','>\x20或购买专属套餐\x20！','26miIPOM','非法操作、当前充值套餐暂不存在！','userEntity','chatGroupEntity','../crami/cramiPackage.entity','BalanceService','firstRregisterSendModel3Count','expirationTime','3078rIeyHi','YYYY-MM-DD\x20HH:mm:ss','setConfig','YYYY-MM-DD','invitedGuestSendModel4Count','model4Count','function','decorate','消费余额失败！','rechargeType','day','then','getAccountLog','forEach','mjDraw','充值的工单信息:','writeOldBalanceToNewTable','registerSendModel3Count','firstRregisterSendModel4Count','memberModel3Count','deductFromBalance','inviteGiveSendModel4Count','findAndCount','includes','10170VtEwPI','default','充值失败','inheritVisitorData','__decorate','salesUsersEntity','map','odel3','旧账户信息迁移失败','salesService','status','../sales/salesUsers.entity','count','缺失当前用户账户记录！','expireDateCn','缺失当前套餐ID、充值失败！','memberModel4Count','midjourneyEntity','toFixed','upgradeStatus','__metadata','Repository','super','createBaseUserBalance','update','length','validateVisitorBalance','catch','affected','find','5889uLLpkN','./fingerprint.entity','UserBalanceService','configVal','查询用户账户失败！','commissionAmount','log','11SQbfkA','firstRregisterSendDrawMjCount','./../globalConfig/globalConfig.service','createSalesRecords','visitorMJNum','LessThan','useModel3Token','当前用户不存在,记录充值日志异常','../chatgpt/whiteList.entity','visitor','firstRegisterSendStatus','configKey','../sales/sales.service','avatar','sumDrawMjCount','WhiteListEntity','useDrawMjToken','ChatLogEntity','DESC','BAD_REQUEST','vxNumber','registerSendStatus','REFER_GIFT','../../common/utils','AccountLogEntity','firstRegisterSendRank','findOne','RechargeType','getFullYear','email','error:\x20'];_0x4442=function(){return _0xc6d125;};return _0x4442();}Object[_0x28b856(0x17a)](exports,_0x28b856(0x1bd),{'value':!![]}),exports['UserBalanceService']=void 0x0;const globalConfig_service_1=require(_0x28b856(0x15c)),typeorm_1=require(_0x28b856(0x1a5)),balance_entity_1=require(_0x28b856(0x1c6)),common_1=require(_0x28b856(0x182)),typeorm_2=require(_0x28b856(0x1c7)),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require('./accountLog.entity'),utils_1=require(_0x28b856(0x171)),config_entity_1=require('../globalConfig/config.entity'),cramiPackage_entity_1=require(_0x28b856(0x1dc)),userBalance_entity_1=require('./userBalance.entity'),date_1=require('../../common/utils/date'),user_entity_1=require('../user/user.entity'),salesUsers_entity_1=require(_0x28b856(0x140)),sales_service_1=require(_0x28b856(0x166)),whiteList_entity_1=require(_0x28b856(0x162)),fingerprint_entity_1=require(_0x28b856(0x154)),chatLog_entity_1=require(_0x28b856(0x1d2)),chatGroup_entity_1=require(_0x28b856(0x1c5)),midjourney_entity_1=require('../midjourney/midjourney.entity');let UserBalanceService=class UserBalanceService{constructor(_0x414f91,_0x3c6a5d,_0x23f349,_0x38cb6c,_0x579e84,_0x4e746f,_0x49d6a2,_0x4ef928,_0x459c00,_0x5aef82,_0x134031,_0xa03134,_0x1e9ea7,_0x1d0315){const _0x12d23a=_0x28b856;this[_0x12d23a(0x1b6)]=_0x414f91,this[_0x12d23a(0x1d3)]=_0x3c6a5d,this[_0x12d23a(0x1a1)]=_0x23f349,this['cramiPackageEntity']=_0x38cb6c,this[_0x12d23a(0x1bc)]=_0x579e84,this[_0x12d23a(0x1da)]=_0x4e746f,this['salesUsersEntity']=_0x49d6a2,this[_0x12d23a(0x179)]=_0x4ef928,this[_0x12d23a(0x18d)]=_0x459c00,this[_0x12d23a(0x1db)]=_0x5aef82,this[_0x12d23a(0x1ae)]=_0x134031,this[_0x12d23a(0x146)]=_0xa03134,this[_0x12d23a(0x13e)]=_0x1e9ea7,this[_0x12d23a(0x189)]=_0x1d0315;}async[_0x28b856(0x1c2)](_0x5d6f89,_0x4eaf5c){const _0x420f2f=_0x28b856;try{const _0x6f27bb=await this[_0x420f2f(0x1bc)][_0x420f2f(0x152)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x420f2f(0x16f),'registerSendModel3Count',_0x420f2f(0x1cc),'registerSendDrawMjCount',_0x420f2f(0x164),'firstRegisterSendRank',_0x420f2f(0x1de),_0x420f2f(0x12f),_0x420f2f(0x15b),'inviteSendStatus',_0x420f2f(0x197),_0x420f2f(0x132),_0x420f2f(0x1ce),_0x420f2f(0x1ba),_0x420f2f(0x185),_0x420f2f(0x1e4)])}}),_0x18b0f2=_0x6f27bb['reduce']((_0x3094d6,_0x2e7545)=>{const _0x2d484f=_0x420f2f,_0x97adde=Number(_0x2e7545['configVal']),_0x4189dc=Number['isInteger'](_0x97adde)&&_0x97adde>0x0?_0x97adde:0x0;return _0x3094d6[_0x2e7545[_0x2d484f(0x165)]]=_0x4189dc,_0x3094d6;},{});let _0x4793b5=0x0,_0x25e7ed=0x0,_0x125ef5=0x0;_0x18b0f2[_0x420f2f(0x16f)]===0x1&&(_0x4793b5=_0x4793b5+_0x18b0f2[_0x420f2f(0x12e)],_0x25e7ed=_0x25e7ed+_0x18b0f2[_0x420f2f(0x1cc)],_0x125ef5=_0x125ef5+_0x18b0f2[_0x420f2f(0x1b8)]),_0x18b0f2[_0x420f2f(0x16f)]===0x1&&_0x18b0f2[_0x420f2f(0x164)]===0x1&&_0x5d6f89<=_0x18b0f2[_0x420f2f(0x173)]&&(_0x4793b5=_0x4793b5+_0x18b0f2[_0x420f2f(0x1de)],_0x25e7ed=_0x25e7ed+_0x18b0f2['firstRregisterSendModel4Count'],_0x125ef5=_0x125ef5+_0x18b0f2[_0x420f2f(0x15b)]),await this['saveRecordRechargeLog']({'userId':_0x5d6f89,'rechargeType':balance_constant_1['RechargeType'][_0x420f2f(0x196)],'model3Count':_0x4793b5,'drawMjCount':_0x125ef5,'model4Count':_0x25e7ed}),_0x4eaf5c&&(Number(_0x18b0f2[_0x420f2f(0x1cd)])===0x1&&(_0x4793b5=_0x4793b5+Number(_0x18b0f2[_0x420f2f(0x1ba)]),_0x25e7ed=_0x25e7ed+Number(_0x18b0f2['invitedGuestSendModel4Count']),_0x125ef5=_0x125ef5+Number(_0x18b0f2[_0x420f2f(0x185)]),await this[_0x420f2f(0x17e)]({'userId':_0x5d6f89,'rechargeType':balance_constant_1[_0x420f2f(0x175)]['INVITE_GIFT'],'model3Count':_0x18b0f2[_0x420f2f(0x1ba)],'model4Count':_0x18b0f2['invitedGuestSendModel4Count'],'drawMjCount':_0x18b0f2['invitedGuestSendDrawMjCount']}),await this[_0x420f2f(0x1a4)](_0x4eaf5c,{'model3Count':_0x18b0f2[_0x420f2f(0x197)],'model4Count':_0x18b0f2[_0x420f2f(0x132)],'drawMjCount':_0x18b0f2['inviteGiveSendDrawMjCount']}),await this['saveRecordRechargeLog']({'userId':_0x4eaf5c,'rechargeType':balance_constant_1[_0x420f2f(0x175)][_0x420f2f(0x170)],'model3Count':_0x18b0f2[_0x420f2f(0x197)],'model4Count':_0x18b0f2[_0x420f2f(0x132)],'drawMjCount':_0x18b0f2[_0x420f2f(0x1ce)]}))),await this['userBalanceEntity'][_0x420f2f(0x1ca)]({'userId':_0x5d6f89,'model3Count':_0x4793b5,'model4Count':_0x25e7ed,'drawMjCount':_0x125ef5,'useTokens':0x0});}catch(_0x175bc0){console[_0x420f2f(0x159)](_0x420f2f(0x178),_0x175bc0);throw new common_1[(_0x420f2f(0x198))]('注册赠送失败,请联系管理员！',common_1[_0x420f2f(0x1b4)][_0x420f2f(0x16d)]);}}async[_0x28b856(0x1d6)](_0x51135a,_0x157702,_0x50bd46){const _0x2b1bc4=_0x28b856,{id:_0x5033d8,role:_0x508020}=_0x51135a['user'];let _0x4cd0ee=await this[_0x2b1bc4(0x1d3)][_0x2b1bc4(0x174)]({'where':{'userId':_0x5033d8}});!_0x4cd0ee&&(_0x4cd0ee=await this['createBaseUserBalance'](_0x5033d8));if(_0x508020===_0x2b1bc4(0x163))return this[_0x2b1bc4(0x14f)](_0x51135a,_0x157702,_0x50bd46);const _0x3111d5=await this['configEntity']['findOne']({'where':{'configKey':_0x2b1bc4(0x16e)}}),_0x10b010=_0x3111d5?_0x3111d5[_0x2b1bc4(0x156)]:_0x2b1bc4(0x1ab),_0x42203d=_0x157702===_0x2b1bc4(0x1a3)?_0x2b1bc4(0x130):_0x157702==='model4'?'memberModel4Count':_0x157702==='mjDraw'?_0x2b1bc4(0x18f):null,_0x1b1987=_0x157702==='model3'?_0x2b1bc4(0x1c0):_0x157702===_0x2b1bc4(0x1cf)?_0x2b1bc4(0x1e5):_0x157702===_0x2b1bc4(0x12b)?'drawMjCount':null;if(_0x4cd0ee['packageId']&&_0x4cd0ee[_0x42203d]<_0x50bd46){if(_0x4cd0ee[_0x1b1987]<_0x50bd46)throw new common_1[(_0x2b1bc4(0x198))](_0x2b1bc4(0x1a0)+_0x10b010+_0x2b1bc4(0x1d7),common_1['HttpStatus'][_0x2b1bc4(0x1b0)]);}if(!_0x4cd0ee['packageId']&&_0x4cd0ee[_0x1b1987]<_0x50bd46)throw new common_1[(_0x2b1bc4(0x198))](_0x2b1bc4(0x1a0)+_0x10b010+_0x2b1bc4(0x1d7),common_1[_0x2b1bc4(0x1b4)]['PAYMENT_REQUIRED']);return _0x4cd0ee;}async[_0x28b856(0x14f)](_0x502f33,_0xc7c257,_0x1ec30c){const _0x5c2952=_0x28b856,{id:_0x355114}=_0x502f33[_0x5c2952(0x18e)],_0x2fbcfb=_0xc7c257==='model3'?_0x5c2952(0x1c0):_0xc7c257===_0x5c2952(0x1cf)?_0x5c2952(0x1e5):_0xc7c257==='mjDraw'?_0x5c2952(0x1ad):null,_0x297de8=new Date(),_0x572a9a=await this[_0x5c2952(0x18d)][_0x5c2952(0x174)]({'where':{'fingerprint':_0x355114}}),{visitorModel3Num:_0x4d2f9d,visitorModel4Num:_0x444525,visitorMJNum:_0x5b97d0}=await this[_0x5c2952(0x189)]['getConfigs'](['visitorModel3Num','visitorModel4Num',_0x5c2952(0x15e)]),_0x1d08b4={'model3Count':_0x4d2f9d?Number(_0x4d2f9d):0x0,'model4Count':_0x444525?Number(_0x444525):0x0,'drawMjCount':_0x5b97d0?Number(_0x5b97d0):0x0};if(!_0x572a9a){const _0x4b9f6f={'fingerprint':_0x355114,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x4b9f6f[_0x2fbcfb]=_0x4b9f6f[_0x2fbcfb]+_0x1ec30c;if(_0x4b9f6f[_0x2fbcfb]>_0x1d08b4[_0x2fbcfb])throw new common_1[(_0x5c2952(0x198))](_0x5c2952(0x184),common_1[_0x5c2952(0x1b4)]['PAYMENT_REQUIRED']);else return await this[_0x5c2952(0x18d)][_0x5c2952(0x1ca)](_0x4b9f6f),!![];}else{const {model3Count:_0xd4156a,model4Count:_0xa2ce3e,drawMjCount:_0xd643ea}=_0x572a9a;let _0x96312a={'model3Count':_0xd4156a,'model4Count':_0xa2ce3e,'drawMjCount':_0xd643ea};const _0x417a85=Number(new Date(_0x572a9a['updatedAt'])),_0x5d6eac=this[_0x5c2952(0x19b)](_0x417a85);_0x5d6eac?_0x96312a[_0x2fbcfb]=_0x96312a[_0x2fbcfb]+_0x1ec30c:(_0x96312a={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x96312a[_0x2fbcfb]=_0x96312a[_0x2fbcfb]+_0x1ec30c);if(_0x96312a[_0x2fbcfb]>_0x1d08b4[_0x2fbcfb])throw new common_1[(_0x5c2952(0x198))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1['HttpStatus'][_0x5c2952(0x1b0)]);else return await this[_0x5c2952(0x18d)][_0x5c2952(0x14d)]({'fingerprint':_0x355114},_0x96312a),!![];}}['isUpdatedToday'](_0x5ce2c6){const _0x2e4472=_0x28b856,_0x5c80b6=new Date(),_0x13a90f=new Date(_0x5c80b6[_0x2e4472(0x176)](),_0x5c80b6['getMonth'](),_0x5c80b6[_0x2e4472(0x1d0)]());return _0x5ce2c6>=_0x13a90f;}async[_0x28b856(0x131)](_0x1744a7,_0x129892,_0x3dbfe9,_0x3879e5=0x0){const _0x579b99=_0x28b856,_0x3b61f7=await this[_0x579b99(0x1d3)]['findOne']({'where':{'userId':_0x1744a7}});if(!_0x3b61f7)throw new common_1[(_0x579b99(0x198))](_0x579b99(0x142),common_1[_0x579b99(0x1b4)]['BAD_REQUEST']);const _0x355dcd=_0x129892===_0x579b99(0x1a3)?'memberModel3Count':_0x129892===_0x579b99(0x1cf)?_0x579b99(0x145):_0x129892==='mjDraw'?'memberDrawMjCount':null,_0x198ca4=_0x129892===_0x579b99(0x1a3)?_0x579b99(0x1c0):_0x129892==='model4'?'model4Count':_0x129892===_0x579b99(0x12b)?_0x579b99(0x1ad):null,_0x1e3f5b=_0x3b61f7[_0x579b99(0x1a8)]&&_0x3b61f7[_0x355dcd]<_0x3dbfe9?_0x198ca4:_0x3b61f7[_0x579b99(0x1a8)]?_0x355dcd:_0x198ca4;let _0x2b7ca8=null;_0x1e3f5b[_0x579b99(0x134)](_0x579b99(0x13c))&&(_0x2b7ca8=_0x579b99(0x160));_0x1e3f5b[_0x579b99(0x134)]('odel4')&&(_0x2b7ca8='useModel4Token');_0x1e3f5b[_0x579b99(0x134)](_0x579b99(0x1a7))&&(_0x2b7ca8=_0x579b99(0x16a));const _0x2b14ab={[_0x1e3f5b]:_0x3b61f7[_0x1e3f5b]-_0x3dbfe9<0x0?0x0:_0x3b61f7[_0x1e3f5b]-_0x3dbfe9,[_0x2b7ca8]:Number(_0x3b61f7[_0x2b7ca8])+Number(_0x3879e5)};_0x2b7ca8===_0x579b99(0x160)&&(_0x2b14ab[_0x579b99(0x18b)]=_0x3b61f7['useModel3Count']+0x1),_0x2b7ca8==='useModel4Token'&&(_0x2b14ab[_0x579b99(0x194)]=_0x3b61f7[_0x579b99(0x194)]+0x1);const _0x7841be=await this[_0x579b99(0x1d3)][_0x579b99(0x14d)]({'userId':_0x1744a7},_0x2b14ab);if(_0x7841be[_0x579b99(0x151)]===0x0)throw new common_1[(_0x579b99(0x198))](_0x579b99(0x1e8),common_1['HttpStatus'][_0x579b99(0x16d)]);}async[_0x28b856(0x19e)](_0x4853e6){const _0x5974dc=_0x28b856;try{const _0xa65170=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x4853e6},'select':[_0x5974dc(0x1a8),_0x5974dc(0x1c0),'model4Count',_0x5974dc(0x1ad),_0x5974dc(0x130),_0x5974dc(0x145),_0x5974dc(0x18f),_0x5974dc(0x18b),_0x5974dc(0x194),'useModel3Token',_0x5974dc(0x193),_0x5974dc(0x16a),'expirationTime']});if(!_0xa65170){const _0x87c55f=await this[_0x5974dc(0x14c)](_0x4853e6);if(_0x87c55f)return await this[_0x5974dc(0x19e)](_0x4853e6);else throw new common_1['HttpException'](_0x5974dc(0x1c3),common_1['HttpStatus'][_0x5974dc(0x16d)]);}return _0xa65170['sumModel3Count']=_0xa65170[_0x5974dc(0x1a8)]?_0xa65170[_0x5974dc(0x1c0)]+_0xa65170[_0x5974dc(0x130)]:_0xa65170[_0x5974dc(0x1c0)],_0xa65170[_0x5974dc(0x1ac)]=_0xa65170[_0x5974dc(0x1a8)]?_0xa65170[_0x5974dc(0x1e5)]+_0xa65170[_0x5974dc(0x145)]:_0xa65170[_0x5974dc(0x1e5)],_0xa65170[_0x5974dc(0x168)]=_0xa65170['packageId']?_0xa65170['drawMjCount']+_0xa65170[_0x5974dc(0x18f)]:_0xa65170[_0x5974dc(0x1ad)],_0xa65170['expirationTime']=_0xa65170[_0x5974dc(0x1df)]?(0x0,date_1['formatDate'])(_0xa65170[_0x5974dc(0x1df)],_0x5974dc(0x1e3)):null,_0xa65170;}catch(_0x100814){console[_0x5974dc(0x159)](_0x5974dc(0x178),_0x100814);}}async['saveRecordRechargeLog'](_0x2c0bb2){const _0x271892=_0x28b856,{userId:_0x46b135,rechargeType:_0x21a49f,model3Count:_0x170528,model4Count:_0x358ade,drawMjCount:_0xc35b31,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x2c0bb2;if(!_0x46b135)throw new common_1[(_0x271892(0x198))](_0x271892(0x161),common_1[_0x271892(0x1b4)][_0x271892(0x16d)]);const _0x2e5e24=(0x0,utils_1[_0x271892(0x1cb)])();return await this[_0x271892(0x1a1)][_0x271892(0x1ca)]({'userId':_0x46b135,'rechargeType':_0x21a49f,'model3Count':_0x170528,'model4Count':_0x358ade,'drawMjCount':_0xc35b31,'days':days,'extent':extent,'uid':_0x2e5e24,'pkgName':pkgName});}async[_0x28b856(0x14c)](_0x55cabb,_0x36534e={}){const _0x53da94=_0x28b856,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x36534e,_0x54da09=await this['userBalanceEntity'][_0x53da94(0x174)]({'where':{'userId':_0x55cabb}});if(_0x54da09)throw new common_1[(_0x53da94(0x198))]('当前用户无需创建账户信息！',common_1[_0x53da94(0x1b4)]['BAD_REQUEST']);return await this[_0x53da94(0x1d3)][_0x53da94(0x1ca)]({'userId':_0x55cabb,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async['addBalanceToUser'](_0x5ea000,_0x2e2db2,_0x310ab0=-0x1){const _0x2958b9=_0x28b856;try{const _0x8e7a23=await this['userBalanceEntity'][_0x2958b9(0x174)]({'where':{'userId':_0x5ea000}})||await this['createBaseUserBalance'](_0x5ea000);if(!_0x8e7a23)throw new common_1[(_0x2958b9(0x198))](_0x2958b9(0x1c8),common_1[_0x2958b9(0x1b4)][_0x2958b9(0x16d)]);const {model3Count:_0x570e80,model4Count:_0x17a410,drawMjCount:_0x325ae,memberModel3Count:_0x46e38c,memberModel4Count:_0x7da889,memberDrawMjCount:_0x16659a}=_0x8e7a23;let _0x2c1bff={};if(_0x310ab0>0x0){const {packageId:_0x5390e7}=_0x2e2db2;if(!_0x5390e7)throw new common_1[(_0x2958b9(0x198))](_0x2958b9(0x144),common_1[_0x2958b9(0x1b4)][_0x2958b9(0x16d)]);const _0x115218=await this['cramiPackageEntity'][_0x2958b9(0x174)]({'where':{'id':_0x5390e7}});if(!_0x115218)throw new common_1[(_0x2958b9(0x198))]('当前套餐不存在！',common_1['HttpStatus'][_0x2958b9(0x16d)]);const {weight:_0x4dfcfd}=_0x115218;if(!_0x8e7a23[_0x2958b9(0x1a8)])_0x2c1bff={'memberModel3Count':_0x570e80+_0x2e2db2['model3Count'],'memberModel4Count':_0x17a410+_0x2e2db2[_0x2958b9(0x1e5)],'memberDrawMjCount':_0x325ae+_0x2e2db2[_0x2958b9(0x1ad)],'expirationTime':(0x0,date_1[_0x2958b9(0x136)])()['add'](_0x310ab0>0x0?_0x310ab0:0x0,_0x2958b9(0x127))['format'](_0x2958b9(0x1e1)),'packageId':_0x5390e7};else{const _0x2bfdda=await this['cramiPackageEntity'][_0x2958b9(0x174)]({'where':{'id':_0x8e7a23[_0x2958b9(0x1a8)]}});_0x4dfcfd>=_0x2bfdda['weight']&&(_0x2c1bff={'memberModel3Count':_0x46e38c+_0x2e2db2['model3Count'],'memberModel4Count':_0x7da889+_0x2e2db2[_0x2958b9(0x1e5)],'memberDrawMjCount':_0x16659a+_0x2e2db2['drawMjCount'],'expirationTime':(0x0,date_1[_0x2958b9(0x136)])(_0x8e7a23['expirationTime'])[_0x2958b9(0x19f)](_0x310ab0>0x0?_0x310ab0:0x0,_0x2958b9(0x127))[_0x2958b9(0x1c4)](_0x2958b9(0x1e1)),'packageId':_0x5390e7}),_0x4dfcfd<_0x2bfdda[_0x2958b9(0x1d4)]&&(_0x2c1bff={'memberModel3Count':_0x46e38c+_0x2e2db2[_0x2958b9(0x1c0)],'memberModel4Count':_0x7da889+_0x2e2db2[_0x2958b9(0x1e5)],'memberDrawMjCount':_0x16659a+_0x2e2db2[_0x2958b9(0x1ad)]});}}_0x310ab0<=0x0&&(_0x2c1bff={'model3Count':_0x570e80+_0x2e2db2[_0x2958b9(0x1c0)],'model4Count':_0x17a410+_0x2e2db2['model4Count'],'drawMjCount':_0x325ae+_0x2e2db2[_0x2958b9(0x1ad)]});const _0x3b2be2=await this['userBalanceEntity']['update']({'userId':_0x5ea000},_0x2c1bff);if(_0x3b2be2[_0x2958b9(0x151)]===0x0)throw new common_1[(_0x2958b9(0x198))](_0x5ea000+_0x2958b9(0x137),common_1[_0x2958b9(0x1b4)][_0x2958b9(0x16d)]);}catch(_0x4ab021){console[_0x2958b9(0x159)](_0x2958b9(0x178),_0x4ab021);throw new common_1[(_0x2958b9(0x198))](_0x2958b9(0x17c),common_1[_0x2958b9(0x1b4)][_0x2958b9(0x16d)]);}}async['addBalanceToOrder'](_0x349753){const _0x6212fa=_0x28b856;console['log'](_0x6212fa(0x12c),_0x349753);try{const {userId:_0x19e95c,goodsId:_0x5e3667}=_0x349753,_0x4283d6=await this['cramiPackageEntity'][_0x6212fa(0x174)]({'where':{'id':_0x349753['goodsId'],'status':0x1}});if(!_0x4283d6)throw new common_1['HttpException'](_0x6212fa(0x1d9),common_1[_0x6212fa(0x1b4)][_0x6212fa(0x16d)]);const {model3Count:_0x4b9818,model4Count:_0x1d39d7,drawMjCount:_0x519c4a,days:_0x2f1819,name:_0x20c1c2}=_0x4283d6,_0x2bd372={'model3Count':_0x4b9818,'model4Count':_0x1d39d7,'drawMjCount':_0x519c4a,'days':_0x2f1819,'packageId':_0x349753[_0x6212fa(0x190)]};await this[_0x6212fa(0x1a4)](_0x19e95c,_0x2bd372,_0x2f1819),await this[_0x6212fa(0x17e)]({'userId':_0x19e95c,'rechargeType':balance_constant_1[_0x6212fa(0x175)][_0x6212fa(0x1bb)],'model3Count':_0x4b9818,'model4Count':_0x1d39d7,'drawMjCount':_0x519c4a,'pkgName':_0x20c1c2,'days':_0x2f1819});const _0x4fed34=await this[_0x6212fa(0x1da)][_0x6212fa(0x174)]({'where':{'id':_0x19e95c}}),{invitedBy:_0x5a24a6}=_0x4fed34;if(_0x5a24a6){const _0x1cd794=await this[_0x6212fa(0x1da)][_0x6212fa(0x174)]({'where':{'inviteCode':_0x5a24a6}}),_0x34c697=await this[_0x6212fa(0x13a)][_0x6212fa(0x174)]({'where':{'userId':_0x1cd794['id']}});if(!_0x1cd794)return;const {id:_0x52ab74}=_0x1cd794,{performanceRatio:_0x161316}=_0x34c697,_0x3e707b={'inviterUserId':_0x52ab74,'inviteeUserId':_0x19e95c,'orderId':_0x349753['id'],'orderPrice':_0x349753[_0x6212fa(0x1b7)],'commissionPercentage':_0x161316,'commissionAmount':(_0x349753[_0x6212fa(0x1b7)]*_0x161316/0x64)[_0x6212fa(0x147)](0x2)};await this[_0x6212fa(0x13e)][_0x6212fa(0x15d)](_0x3e707b),await this[_0x6212fa(0x13e)]['saveCommissionAmount'](_0x52ab74,_0x3e707b[_0x6212fa(0x158)]);}}catch(_0x276329){console[_0x6212fa(0x159)](_0x6212fa(0x178),_0x276329);throw new common_1['HttpException'](_0x6212fa(0x1b3),common_1['HttpStatus'][_0x6212fa(0x16d)]);}}async['getRechargeLog'](_0x5dc3e1,_0x39a896){const _0x202352=_0x28b856,{page:page=0x1,size:size=0x14}=_0x39a896,{id:_0x326b0f}=_0x5dc3e1[_0x202352(0x18e)],[_0x535782,_0x24e5d4]=await this['accountLogEntity'][_0x202352(0x133)]({'where':{'userId':_0x326b0f},'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size});return _0x535782[_0x202352(0x12a)](_0x30e6f9=>{const _0x208743=_0x202352;_0x30e6f9[_0x208743(0x143)]=_0x30e6f9[_0x208743(0x17b)]>0x0?_0x30e6f9['days']+'天':'永久';}),{'rows':(0x0,date_1['formatCreateOrUpdateDate'])(_0x535782),'count':_0x24e5d4};}async[_0x28b856(0x129)](_0x5610a0,_0x21376c){const _0x5035f0=_0x28b856;try{const {page:page=0x1,size:size=0xa,userId:_0x5653c0,rechargeType:_0x3fb8f4,packageId:_0x3aa092}=_0x21376c,{role:_0x53254a}=_0x5610a0['user'],_0x320a2b={};_0x3fb8f4&&(_0x320a2b[_0x5035f0(0x1e9)]=_0x3fb8f4),_0x320a2b[_0x5035f0(0x1be)]=_0x5653c0||(0x0,typeorm_2[_0x5035f0(0x15f)])(0x186a0),_0x3aa092&&(_0x320a2b[_0x5035f0(0x1a8)]={'$like':'%'+_0x3aa092+'%'});const [_0x38f7a5,_0x5beac3]=await this[_0x5035f0(0x1a1)][_0x5035f0(0x133)]({'where':_0x320a2b,'order':{'id':_0x5035f0(0x16c)},'skip':(page-0x1)*size,'take':size}),_0x32946e=_0x38f7a5[_0x5035f0(0x13b)](_0x56433c=>_0x56433c[_0x5035f0(0x1be)]),_0x18ef3c=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x32946e)}});return _0x38f7a5[_0x5035f0(0x12a)](_0x286e51=>{const _0x1e8d6a=_0x5035f0,_0x353d5f=_0x18ef3c[_0x1e8d6a(0x152)](_0x5f4df5=>_0x5f4df5['id']===_0x286e51[_0x1e8d6a(0x1be)]);_0x286e51[_0x1e8d6a(0x1bf)]=_0x353d5f===null||_0x353d5f===void 0x0?void 0x0:_0x353d5f['username'],_0x286e51[_0x1e8d6a(0x177)]=_0x353d5f===null||_0x353d5f===void 0x0?void 0x0:_0x353d5f['email'],_0x286e51[_0x1e8d6a(0x191)]=_0x353d5f===null||_0x353d5f===void 0x0?void 0x0:_0x353d5f[_0x1e8d6a(0x191)],_0x286e51['status']=_0x353d5f===null||_0x353d5f===void 0x0?void 0x0:_0x353d5f[_0x1e8d6a(0x13f)],_0x286e51[_0x1e8d6a(0x167)]=_0x353d5f===null||_0x353d5f===void 0x0?void 0x0:_0x353d5f[_0x1e8d6a(0x167)];}),_0x53254a!==_0x5035f0(0x14b)&&_0x38f7a5[_0x5035f0(0x12a)](_0x2a92b6=>{const _0xdc12b2=_0x5035f0;_0x2a92b6['email']=_0x2a92b6[_0xdc12b2(0x177)]?(0x0,utils_1['hideString'])(_0x2a92b6[_0xdc12b2(0x177)]):'',_0x2a92b6[_0xdc12b2(0x191)]=_0x2a92b6[_0xdc12b2(0x191)]?(0x0,utils_1[_0xdc12b2(0x19a)])(_0x2a92b6[_0xdc12b2(0x191)]):'';}),{'rows':_0x38f7a5,'count':_0x5beac3};}catch(_0x36e3c1){console[_0x5035f0(0x159)](_0x5035f0(0x178),_0x36e3c1);throw new common_1[(_0x5035f0(0x198))](_0x5035f0(0x157),common_1[_0x5035f0(0x1b4)][_0x5035f0(0x16d)]);}}async[_0x28b856(0x1c1)](_0x62172e){const _0x4bbfdf=_0x28b856;return await this[_0x4bbfdf(0x1d3)][_0x4bbfdf(0x152)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x62172e)}});}async['refundToBalance'](_0x56ad98,_0x5f4b1f,_0x50bd80,_0x3f7e8b=0x0){const _0x33424f=_0x28b856,_0x35da81=await this[_0x33424f(0x1d3)]['findOne']({'where':{'userId':_0x56ad98}});if(!_0x35da81)throw new common_1[(_0x33424f(0x198))](_0x33424f(0x142),common_1[_0x33424f(0x1b4)][_0x33424f(0x16d)]);const _0x488e67=_0x5f4b1f===_0x33424f(0x1a3)?_0x33424f(0x130):_0x5f4b1f===_0x33424f(0x1cf)?'memberModel4Count':_0x5f4b1f==='mjDraw'?_0x33424f(0x18f):null,_0x35e9d2=_0x5f4b1f===_0x33424f(0x1a3)?_0x33424f(0x1c0):_0x5f4b1f===_0x33424f(0x1cf)?_0x33424f(0x1e5):_0x5f4b1f===_0x33424f(0x12b)?_0x33424f(0x1ad):null,_0x46c9a4=_0x35da81[_0x33424f(0x1a8)]&&_0x35da81[_0x488e67]<_0x50bd80?_0x35e9d2:_0x35da81[_0x33424f(0x1a8)]?_0x488e67:_0x35e9d2;let _0x4e0c20=null;_0x46c9a4[_0x33424f(0x134)](_0x33424f(0x1a3))&&(_0x4e0c20=_0x33424f(0x160));_0x46c9a4[_0x33424f(0x134)](_0x33424f(0x1cf))&&(_0x4e0c20=_0x33424f(0x193));_0x46c9a4[_0x33424f(0x134)](_0x33424f(0x1a7))&&(_0x4e0c20='useDrawMjToken');const _0x2a550f={[_0x46c9a4]:_0x35da81[_0x46c9a4]+_0x50bd80,[_0x4e0c20]:Number(_0x35da81[_0x4e0c20])-Number(_0x3f7e8b)};_0x4e0c20===_0x33424f(0x160)&&(_0x2a550f[_0x33424f(0x18b)]=_0x35da81[_0x33424f(0x18b)]-0x1),_0x4e0c20===_0x33424f(0x193)&&(_0x2a550f[_0x33424f(0x194)]=_0x35da81[_0x33424f(0x194)]-0x1);const _0x244fdd=await this[_0x33424f(0x1d3)][_0x33424f(0x14d)]({'userId':_0x56ad98},_0x2a550f);if(_0x244fdd['affected']===0x0)throw new common_1[(_0x33424f(0x198))](_0x33424f(0x19d),common_1[_0x33424f(0x1b4)][_0x33424f(0x16d)]);}async[_0x28b856(0x1b5)](){const _0x3514cc=_0x28b856,_0x2aaff7=await this[_0x3514cc(0x1da)]['find']();if(!_0x2aaff7[_0x3514cc(0x14e)])return;const _0x15ab2f=await this[_0x3514cc(0x189)][_0x3514cc(0x192)](['upgradeStatus']);if(!_0x15ab2f)await this[_0x3514cc(0x189)][_0x3514cc(0x1e2)]({'settings':[{'configKey':_0x3514cc(0x148),'configVal':'1'}]});else throw new common_1[(_0x3514cc(0x198))](_0x3514cc(0x180),common_1[_0x3514cc(0x1b4)][_0x3514cc(0x16d)]);_0x2aaff7[_0x3514cc(0x12a)](_0xbbc7fb=>{const _0x180cb1=_0x3514cc,{id:_0x4a6b60}=_0xbbc7fb;this[_0x180cb1(0x1b6)]['findOne']({'where':{'userId':_0x4a6b60}})[_0x180cb1(0x128)](_0x93d744=>{const _0x1ffdca=_0x180cb1;if(!_0x93d744)return;this[_0x1ffdca(0x12d)](_0x4a6b60,_0x93d744);});});}async['writeOldBalanceToNewTable'](_0x496d9c,_0x537b3f){const _0x445ea0=_0x28b856,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x537b3f,_0x262277=await this[_0x445ea0(0x179)][_0x445ea0(0x174)]({'where':{'userId':_0x496d9c}}),_0x3e7175={'userId':_0x496d9c,'model3Count':Number(usesLeft),'model4Count':(_0x262277===null||_0x262277===void 0x0?void 0x0:_0x262277[_0x445ea0(0x141)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x262277===null||_0x262277===void 0x0?void 0x0:_0x262277['useCount'])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x55ad76=await this[_0x445ea0(0x1d3)][_0x445ea0(0x174)]({'where':{'userId':_0x496d9c}});_0x55ad76?common_1[_0x445ea0(0x1c9)][_0x445ea0(0x1a9)]('用户'+_0x496d9c+_0x445ea0(0x18a),_0x445ea0(0x1dd)):this[_0x445ea0(0x1d3)][_0x445ea0(0x1ca)](_0x3e7175)['then'](_0x495c4d=>{const _0x29ebba=_0x445ea0;common_1['Logger'][_0x29ebba(0x1a9)]('用户'+_0x496d9c+'旧账户信息迁移成功',_0x29ebba(0x1dd));})[_0x445ea0(0x150)](_0x2de39d=>{const _0x14e69f=_0x445ea0;console[_0x14e69f(0x159)](_0x14e69f(0x178),_0x2de39d),common_1[_0x14e69f(0x1c9)][_0x14e69f(0x1a9)]('用户'+_0x496d9c+_0x14e69f(0x13d),_0x14e69f(0x1dd));});}async[_0x28b856(0x138)](_0x38d8fa){const _0x36c18d=_0x28b856,{fingerprint:_0x504181}=_0x38d8fa[_0x36c18d(0x195)],{id:_0x443861}=_0x38d8fa['user'];return await this[_0x36c18d(0x1ae)][_0x36c18d(0x14d)]({'userId':Number(_0x504181)},{'userId':_0x443861}),await this[_0x36c18d(0x1db)][_0x36c18d(0x14d)]({'userId':Number(_0x504181)},{'userId':_0x443861}),await this[_0x36c18d(0x146)][_0x36c18d(0x14d)]({'userId':Number(_0x504181)},{'userId':_0x443861}),0x1;}async[_0x28b856(0x1a2)](_0x1caca5){const _0x2b0ede=_0x28b856,{fingerprint:_0x3ae9f1}=_0x1caca5[_0x2b0ede(0x195)],_0x194add=await this[_0x2b0ede(0x1ae)][_0x2b0ede(0x141)]({'where':{'userId':_0x3ae9f1}}),_0x1362ec=await this['chatGroupEntity'][_0x2b0ede(0x141)]({'where':{'userId':_0x3ae9f1}}),_0x4ec3c5=await this[_0x2b0ede(0x146)][_0x2b0ede(0x141)]({'where':{'userId':_0x3ae9f1}});return _0x194add||_0x1362ec||_0x4ec3c5||0x0;}};UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(balance_entity_1[_0x28b856(0x1d1)])),__param(0x1,(0x0,typeorm_1[_0x28b856(0x18c)])(userBalance_entity_1[_0x28b856(0x199)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0x28b856(0x172)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x28b856(0x1b2)])),__param(0x4,(0x0,typeorm_1[_0x28b856(0x18c)])(config_entity_1['ConfigEntity'])),__param(0x5,(0x0,typeorm_1[_0x28b856(0x18c)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1[_0x28b856(0x1b9)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x28b856(0x169)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x28b856(0x186)])),__param(0x9,(0x0,typeorm_1[_0x28b856(0x18c)])(chatGroup_entity_1[_0x28b856(0x183)])),__param(0xa,(0x0,typeorm_1[_0x28b856(0x18c)])(chatLog_entity_1[_0x28b856(0x16b)])),__param(0xb,(0x0,typeorm_1[_0x28b856(0x18c)])(midjourney_entity_1['MidjourneyEntity'])),__metadata(_0x28b856(0x1aa),[typeorm_2[_0x28b856(0x14a)],typeorm_2[_0x28b856(0x14a)],typeorm_2['Repository'],typeorm_2[_0x28b856(0x14a)],typeorm_2[_0x28b856(0x14a)],typeorm_2[_0x28b856(0x14a)],typeorm_2[_0x28b856(0x14a)],typeorm_2[_0x28b856(0x14a)],typeorm_2[_0x28b856(0x14a)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2['Repository'],sales_service_1['SalesService'],globalConfig_service_1[_0x28b856(0x1a6)]])],UserBalanceService),exports[_0x28b856(0x155)]=UserBalanceService;