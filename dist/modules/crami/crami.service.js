'use strict';const _0x43cc23=_0x36a7;function _0x36a7(_0x2e2086,_0xeb269f){const _0x2a91b4=_0x2a91();return _0x36a7=function(_0x36a7f1,_0x5f149e){_0x36a7f1=_0x36a7f1-0x1a5;let _0x5b1c40=_0x2a91b4[_0x36a7f1];return _0x5b1c40;},_0x36a7(_0x2e2086,_0xeb269f);}(function(_0x2901c9,_0x560a10){const _0x281df8=_0x36a7,_0x2af36e=_0x2901c9();while(!![]){try{const _0x51bd06=parseInt(_0x281df8(0x1af))/0x1*(parseInt(_0x281df8(0x1b4))/0x2)+parseInt(_0x281df8(0x1f6))/0x3+parseInt(_0x281df8(0x1f4))/0x4*(parseInt(_0x281df8(0x1d7))/0x5)+-parseInt(_0x281df8(0x1e1))/0x6+-parseInt(_0x281df8(0x1ce))/0x7*(parseInt(_0x281df8(0x1c3))/0x8)+parseInt(_0x281df8(0x1d3))/0x9*(-parseInt(_0x281df8(0x1d0))/0xa)+parseInt(_0x281df8(0x1ba))/0xb*(parseInt(_0x281df8(0x1bf))/0xc);if(_0x51bd06===_0x560a10)break;else _0x2af36e['push'](_0x2af36e['shift']());}catch(_0x20827a){_0x2af36e['push'](_0x2af36e['shift']());}}}(_0x2a91,0xf3d26));var __decorate=this&&this['__decorate']||function(_0x229965,_0x4307c1,_0x146eaa,_0x2d6e71){const _0x48ea69=_0x36a7;var _0x258a88=arguments[_0x48ea69(0x1a7)],_0x322e0b=_0x258a88<0x3?_0x4307c1:_0x2d6e71===null?_0x2d6e71=Object['getOwnPropertyDescriptor'](_0x4307c1,_0x146eaa):_0x2d6e71,_0x37a7d4;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x48ea69(0x1ac))_0x322e0b=Reflect[_0x48ea69(0x1fa)](_0x229965,_0x4307c1,_0x146eaa,_0x2d6e71);else{for(var _0x53873a=_0x229965[_0x48ea69(0x1a7)]-0x1;_0x53873a>=0x0;_0x53873a--)if(_0x37a7d4=_0x229965[_0x53873a])_0x322e0b=(_0x258a88<0x3?_0x37a7d4(_0x322e0b):_0x258a88>0x3?_0x37a7d4(_0x4307c1,_0x146eaa,_0x322e0b):_0x37a7d4(_0x4307c1,_0x146eaa))||_0x322e0b;}return _0x258a88>0x3&&_0x322e0b&&Object[_0x48ea69(0x1ad)](_0x4307c1,_0x146eaa,_0x322e0b),_0x322e0b;},__metadata=this&&this[_0x43cc23(0x1c1)]||function(_0x2fb38f,_0x5dde9a){const _0xa81bce=_0x43cc23;if(typeof Reflect==='object'&&typeof Reflect[_0xa81bce(0x1a8)]===_0xa81bce(0x1ac))return Reflect[_0xa81bce(0x1a8)](_0x2fb38f,_0x5dde9a);},__param=this&&this['__param']||function(_0x5a0ed3,_0x2fda94){return function(_0x56d4c8,_0x164a1a){_0x2fda94(_0x56d4c8,_0x164a1a,_0x5a0ed3);};};Object[_0x43cc23(0x1ad)](exports,_0x43cc23(0x1bc),{'value':!![]}),exports['CramiService']=void 0x0;const common_1=require(_0x43cc23(0x1dc)),crami_entity_1=require(_0x43cc23(0x1d1)),typeorm_1=require(_0x43cc23(0x1ab)),typeorm_2=require(_0x43cc23(0x1f8)),cramiPackage_entity_1=require('./cramiPackage.entity'),utils_1=require('../../common/utils'),user_entity_1=require(_0x43cc23(0x1e9)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x43cc23(0x1b9));function _0x2a91(){const _0x23b0c8=['当前卡密已被使用、请确认您输入的卡密是否正确！','super','24EvnNSQ','username','__metadata','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','8rbhYJc','RechargeType','删除卡密成功！','当前套餐不存在、请检查你的输入参数！','update','当前卡密不存在、请确认您输入的卡密是否正确！','CramiPackageEntity','affected','maskCrami','CramiService','email','11430167gcWPnV','error:\x20','95530atreRq','./crami.entity','code','1530ppwCsb','InjectRepository','saveRecordRechargeLog','delete','8571085gjazvk','HttpStatus','updatePackage','cramiPackageEntity','findOne','@nestjs/common','delCrami','log','map','更新套餐失败、请重试！','8563992EUgpGG','套餐名称或套餐等级重复、请检查！','更新套餐成功！','useId','Not','push','find','UserBalanceService','../user/user.entity','userBalanceService','queryOnePackage','BAD_REQUEST','当前套餐不存在、请确认您选择的套餐是否存在！','createCrami','packageId','forEach','Repository','generateCrami','every','4mohipI','cramiEntity','2401185vJYrpS','DESC','typeorm','HttpException','decorate','save','assign','LessThanOrEqual','findAndCount','length','metadata','user','maskEmail','@nestjs/typeorm','function','defineProperty','删除卡密失败、请重试！','383dpChXt','design:paramtypes','userEntity','当前卡密已被使用、已使用的卡密禁止删除！','自定义卡密必须至少一项余额不为0️零！','5398rckhqE','count','PACKAGE_GIFT','CramiEntity','batchDelCrami','../../common/constants/balance.constant','11740234QepjBv','queryAllCrami','__esModule'];_0x2a91=function(){return _0x23b0c8;};return _0x2a91();}let CramiService=class CramiService{constructor(_0x1cd964,_0x4aebc5,_0x215d65,_0x30ca80){const _0x33736c=_0x43cc23;this[_0x33736c(0x1f5)]=_0x1cd964,this[_0x33736c(0x1da)]=_0x4aebc5,this[_0x33736c(0x1b1)]=_0x215d65,this[_0x33736c(0x1ea)]=_0x30ca80;}async[_0x43cc23(0x1eb)](_0x14df08){const _0x38eaf0=_0x43cc23;return await this[_0x38eaf0(0x1da)]['findOne']({'where':{'id':_0x14df08}});}async['queryAllPackage'](_0x2a47e8){const _0x6553b6=_0x43cc23;try{const {page:page=0x1,size:size=0xa,name:_0x18022f,status:_0x18c923,type:_0x43ff30}=_0x2a47e8,_0x20ff12={};_0x18022f&&Object[_0x6553b6(0x1fc)](_0x20ff12,{'name':(0x0,typeorm_2['Like'])('%'+_0x18022f+'%')}),_0x18c923&&Object[_0x6553b6(0x1fc)](_0x20ff12,{'status':_0x18c923});_0x43ff30&&(_0x43ff30>0x0?Object['assign'](_0x20ff12,{'days':(0x0,typeorm_2['MoreThan'])(0x0)}):Object[_0x6553b6(0x1fc)](_0x20ff12,{'days':(0x0,typeorm_2[_0x6553b6(0x1a5)])(0x0)}));const [_0x3833cf,_0x1a89ca]=await this[_0x6553b6(0x1da)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x20ff12,'order':{'order':_0x6553b6(0x1f7)}});return{'rows':_0x3833cf,'count':_0x1a89ca};}catch(_0xa149d2){console[_0x6553b6(0x1de)](_0x6553b6(0x1cf),_0xa149d2);}}async['createPackage'](_0x33af26){const _0x1bd91e=_0x43cc23,{name:_0x3e73b4,weight:_0x1c8cdf}=_0x33af26,_0x3a4dab=await this[_0x1bd91e(0x1da)][_0x1bd91e(0x1db)]({'where':[{'name':_0x3e73b4},{'weight':_0x1c8cdf}]});if(_0x3a4dab)throw new common_1[(_0x1bd91e(0x1f9))](_0x1bd91e(0x1e2),common_1[_0x1bd91e(0x1d8)][_0x1bd91e(0x1ec)]);try{return await this[_0x1bd91e(0x1da)][_0x1bd91e(0x1fb)](_0x33af26);}catch(_0x3e717d){console[_0x1bd91e(0x1de)](_0x1bd91e(0x1cf),_0x3e717d);throw new common_1['HttpException'](_0x3e717d,common_1[_0x1bd91e(0x1d8)]['BAD_REQUEST']);}}async[_0x43cc23(0x1d9)](_0x1815b3){const _0xb41b84=_0x43cc23,{id:_0x51cbcf,name:_0x13c6fd,weight:_0x2b3940}=_0x1815b3,_0x36f4b8=await this['cramiPackageEntity'][_0xb41b84(0x1db)]({'where':{'id':_0x51cbcf}});if(!_0x36f4b8)throw new common_1['HttpException'](_0xb41b84(0x1c6),common_1[_0xb41b84(0x1d8)][_0xb41b84(0x1ec)]);const _0x5573bc=await this[_0xb41b84(0x1da)][_0xb41b84(0x1b5)]({'where':[{'name':_0x13c6fd,'id':(0x0,typeorm_2[_0xb41b84(0x1e5)])(_0x51cbcf)},{'weight':_0x2b3940,'id':(0x0,typeorm_2[_0xb41b84(0x1e5)])(_0x51cbcf)}]});if(_0x5573bc)throw new common_1[(_0xb41b84(0x1f9))](_0xb41b84(0x1e2),common_1[_0xb41b84(0x1d8)][_0xb41b84(0x1ec)]);const _0x1a3656=await this[_0xb41b84(0x1da)][_0xb41b84(0x1c7)]({'id':_0x51cbcf},_0x1815b3);if(_0x1a3656[_0xb41b84(0x1ca)]>0x0)return _0xb41b84(0x1e3);else throw new common_1[(_0xb41b84(0x1f9))](_0xb41b84(0x1e0),common_1['HttpStatus'][_0xb41b84(0x1ec)]);}async['delPackage'](_0x10c57b){const _0x1aae8d=_0x43cc23,{id:_0x44ff58}=_0x10c57b,_0x565a06=await this['cramiEntity'][_0x1aae8d(0x1b5)]({'where':{'packageId':_0x44ff58}});if(_0x565a06)throw new common_1[(_0x1aae8d(0x1f9))](_0x1aae8d(0x1c2),common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x1aae8d(0x1da)][_0x1aae8d(0x1d6)]({'id':_0x44ff58});}async[_0x43cc23(0x1ee)](_0x5de2ee){const _0x149367=_0x43cc23,{packageId:_0xda438a,count:count=0x1}=_0x5de2ee;if(_0xda438a){const _0x434e98=await this[_0x149367(0x1da)][_0x149367(0x1db)]({'where':{'id':_0xda438a}});if(!_0x434e98)throw new common_1[(_0x149367(0x1f9))](_0x149367(0x1ed),common_1[_0x149367(0x1d8)][_0x149367(0x1ec)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x434e98,_0xc11496={'packageId':_0xda438a,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x149367(0x1f2)](_0xc11496,count);}if(!_0xda438a){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x5de2ee;if([model3Count,model4Count,drawMjCount][_0x149367(0x1f3)](_0x5d6221=>!_0x5d6221))throw new common_1[(_0x149367(0x1f9))](_0x149367(0x1b3),common_1[_0x149367(0x1d8)][_0x149367(0x1ec)]);const _0x3ad781={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x149367(0x1f2)](_0x3ad781,count);}}async[_0x43cc23(0x1f2)](_0x508c8a,_0x364aa2){const _0x107f3b=_0x43cc23,_0x40caa2=[];for(let _0x26029c=0x0;_0x26029c<_0x364aa2;_0x26029c++){const _0x5597c7=(0x0,utils_1['generateCramiCode'])(),_0x463af5=this[_0x107f3b(0x1f5)]['create'](Object[_0x107f3b(0x1fc)](Object['assign']({},_0x508c8a),{'code':_0x5597c7}));_0x40caa2[_0x107f3b(0x1e6)](_0x463af5);}return await this['cramiEntity'][_0x107f3b(0x1fb)](_0x40caa2);}async['useCrami'](_0x320761,_0x1ef9c6){const _0x2b58da=_0x43cc23,{id:_0x3c3d29}=_0x320761[_0x2b58da(0x1a9)],_0xcb3814=await this[_0x2b58da(0x1f5)][_0x2b58da(0x1db)]({'where':{'code':_0x1ef9c6[_0x2b58da(0x1d2)]}});if(!_0xcb3814)throw new common_1[(_0x2b58da(0x1f9))](_0x2b58da(0x1c8),common_1[_0x2b58da(0x1d8)][_0x2b58da(0x1ec)]);const {status:_0x163f60,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x459436}=_0xcb3814;if(_0x163f60===0x1)throw new common_1[(_0x2b58da(0x1f9))](_0x2b58da(0x1bd),common_1['HttpStatus'][_0x2b58da(0x1ec)]);const _0x243061={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x459436};return await this[_0x2b58da(0x1ea)]['addBalanceToUser'](_0x3c3d29,Object[_0x2b58da(0x1fc)]({},_0x243061),days),await this[_0x2b58da(0x1ea)][_0x2b58da(0x1d5)]({'userId':_0x3c3d29,'rechargeType':balance_constant_1[_0x2b58da(0x1c4)][_0x2b58da(0x1b6)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x2b58da(0x1f5)][_0x2b58da(0x1c7)]({'code':_0x1ef9c6[_0x2b58da(0x1d2)]},{'useId':_0x3c3d29,'status':0x1}),'使用卡密成功';}async[_0x43cc23(0x1bb)](_0x55636b,_0x1d5eb3){const _0x25bfde=_0x43cc23,{page:page=0x1,size:size=0xa,status:_0x28befc,useId:_0xd4b346}=_0x55636b,_0x7fc66b={};_0x28befc&&Object[_0x25bfde(0x1fc)](_0x7fc66b,{'status':_0x28befc}),_0xd4b346&&Object[_0x25bfde(0x1fc)](_0x7fc66b,{'useId':_0xd4b346});const [_0x1da7d1,_0x3d6c58]=await this[_0x25bfde(0x1f5)][_0x25bfde(0x1a6)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':'DESC'},'where':_0x7fc66b}),_0x7be8e2=_0x1da7d1[_0x25bfde(0x1df)](_0xb6d97f=>_0xb6d97f['useId']),_0x33c731=_0x1da7d1[_0x25bfde(0x1df)](_0x5d1b7c=>_0x5d1b7c[_0x25bfde(0x1ef)]),_0x511124=await this[_0x25bfde(0x1b1)][_0x25bfde(0x1e7)]({'where':{'id':(0x0,typeorm_2['In'])(_0x7be8e2)}}),_0xe97f56=await this['cramiPackageEntity'][_0x25bfde(0x1e7)]({'where':{'id':(0x0,typeorm_2['In'])(_0x33c731)}});return _0x1da7d1['forEach'](_0x300953=>{const _0x4abe8c=_0x25bfde;var _0x57789c,_0x3b88d7,_0x51eca8;_0x300953[_0x4abe8c(0x1c0)]=(_0x57789c=_0x511124['find'](_0x1fdbbb=>_0x1fdbbb['id']===_0x300953['useId']))===null||_0x57789c===void 0x0?void 0x0:_0x57789c[_0x4abe8c(0x1c0)],_0x300953['email']=(_0x3b88d7=_0x511124['find'](_0x4c3683=>_0x4c3683['id']===_0x300953[_0x4abe8c(0x1e4)]))===null||_0x3b88d7===void 0x0?void 0x0:_0x3b88d7[_0x4abe8c(0x1cd)],_0x300953['packageName']=(_0x51eca8=_0xe97f56[_0x4abe8c(0x1e7)](_0x51bfbe=>_0x51bfbe['id']===_0x300953['packageId']))===null||_0x51eca8===void 0x0?void 0x0:_0x51eca8['name'];}),_0x1d5eb3[_0x25bfde(0x1a9)]['role']!==_0x25bfde(0x1be)&&_0x1da7d1[_0x25bfde(0x1f0)](_0xd0e416=>_0xd0e416[_0x25bfde(0x1cd)]=(0x0,utils_1[_0x25bfde(0x1aa)])(_0xd0e416[_0x25bfde(0x1cd)])),_0x1d5eb3[_0x25bfde(0x1a9)]['role']!==_0x25bfde(0x1be)&&_0x1da7d1[_0x25bfde(0x1f0)](_0x17aaf1=>_0x17aaf1['code']=(0x0,utils_1[_0x25bfde(0x1cb)])(_0x17aaf1[_0x25bfde(0x1d2)])),{'rows':_0x1da7d1,'count':_0x3d6c58};}async[_0x43cc23(0x1dd)](_0x561a6c){const _0x5e42a8=_0x43cc23,_0x1a3285=await this['cramiEntity']['findOne']({'where':{'id':_0x561a6c}});if(!_0x1a3285)throw new common_1['HttpException']('当前卡密不存在、请确认您要删除的卡密是否存在！',common_1[_0x5e42a8(0x1d8)][_0x5e42a8(0x1ec)]);if(_0x1a3285['status']===0x1)throw new common_1[(_0x5e42a8(0x1f9))](_0x5e42a8(0x1b2),common_1[_0x5e42a8(0x1d8)]['BAD_REQUEST']);return await this[_0x5e42a8(0x1f5)]['delete']({'id':_0x561a6c});}async[_0x43cc23(0x1b8)](_0x4cbb4){const _0x212c8a=_0x43cc23,{ids:_0x198dd8}=_0x4cbb4,_0x1ea971=await this[_0x212c8a(0x1f5)][_0x212c8a(0x1d6)](_0x198dd8);if(_0x1ea971['affected']>0x0)return _0x212c8a(0x1c5);else throw new common_1[(_0x212c8a(0x1f9))](_0x212c8a(0x1ae),common_1[_0x212c8a(0x1d8)][_0x212c8a(0x1ec)]);}};CramiService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x43cc23(0x1d4)])(crami_entity_1[_0x43cc23(0x1b7)])),__param(0x1,(0x0,typeorm_1[_0x43cc23(0x1d4)])(cramiPackage_entity_1[_0x43cc23(0x1c9)])),__param(0x2,(0x0,typeorm_1[_0x43cc23(0x1d4)])(user_entity_1['UserEntity'])),__metadata(_0x43cc23(0x1b0),[typeorm_2[_0x43cc23(0x1f1)],typeorm_2[_0x43cc23(0x1f1)],typeorm_2[_0x43cc23(0x1f1)],userBalance_service_1[_0x43cc23(0x1e8)]])],CramiService),exports[_0x43cc23(0x1cc)]=CramiService;