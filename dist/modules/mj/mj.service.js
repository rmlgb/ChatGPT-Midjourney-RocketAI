'use strict';const _0x28f84c=_0x8034;(function(_0x17ba4a,_0x1a36aa){const _0x1d91ef=_0x8034,_0x47a917=_0x17ba4a();while(!![]){try{const _0x6a76b9=-parseInt(_0x1d91ef(0x1bb))/0x1*(-parseInt(_0x1d91ef(0x185))/0x2)+-parseInt(_0x1d91ef(0x170))/0x3*(parseInt(_0x1d91ef(0x13b))/0x4)+parseInt(_0x1d91ef(0x197))/0x5*(-parseInt(_0x1d91ef(0x19a))/0x6)+-parseInt(_0x1d91ef(0x16c))/0x7+-parseInt(_0x1d91ef(0x16e))/0x8+-parseInt(_0x1d91ef(0x1a9))/0x9*(parseInt(_0x1d91ef(0x173))/0xa)+parseInt(_0x1d91ef(0x188))/0xb;if(_0x6a76b9===_0x1a36aa)break;else _0x47a917['push'](_0x47a917['shift']());}catch(_0x547b55){_0x47a917['push'](_0x47a917['shift']());}}}(_0x2f80,0xc9ccd));function _0x8034(_0x318338,_0x24d8c6){const _0x2f80ee=_0x2f80();return _0x8034=function(_0x80340b,_0x29f44c){_0x80340b=_0x80340b-0x127;let _0x12c5c5=_0x2f80ee[_0x80340b];return _0x12c5c5;},_0x8034(_0x318338,_0x24d8c6);}var __decorate=this&&this[_0x28f84c(0x16b)]||function(_0x611bd2,_0x412ce6,_0x3f0348,_0xfd5b40){const _0x4a2f19=_0x28f84c;var _0x5ba3bc=arguments['length'],_0x3dc81a=_0x5ba3bc<0x3?_0x412ce6:_0xfd5b40===null?_0xfd5b40=Object['getOwnPropertyDescriptor'](_0x412ce6,_0x3f0348):_0xfd5b40,_0x41c6f2;if(typeof Reflect===_0x4a2f19(0x14c)&&typeof Reflect[_0x4a2f19(0x16d)]===_0x4a2f19(0x1ad))_0x3dc81a=Reflect[_0x4a2f19(0x16d)](_0x611bd2,_0x412ce6,_0x3f0348,_0xfd5b40);else{for(var _0x387750=_0x611bd2[_0x4a2f19(0x132)]-0x1;_0x387750>=0x0;_0x387750--)if(_0x41c6f2=_0x611bd2[_0x387750])_0x3dc81a=(_0x5ba3bc<0x3?_0x41c6f2(_0x3dc81a):_0x5ba3bc>0x3?_0x41c6f2(_0x412ce6,_0x3f0348,_0x3dc81a):_0x41c6f2(_0x412ce6,_0x3f0348))||_0x3dc81a;}return _0x5ba3bc>0x3&&_0x3dc81a&&Object['defineProperty'](_0x412ce6,_0x3f0348,_0x3dc81a),_0x3dc81a;},__metadata=this&&this[_0x28f84c(0x12f)]||function(_0x3ce42f,_0x365684){const _0x40193b=_0x28f84c;if(typeof Reflect===_0x40193b(0x14c)&&typeof Reflect['metadata']===_0x40193b(0x1ad))return Reflect[_0x40193b(0x137)](_0x3ce42f,_0x365684);},__param=this&&this[_0x28f84c(0x165)]||function(_0x1528bd,_0x185a7c){return function(_0x280b77,_0x5d7f67){_0x185a7c(_0x280b77,_0x5d7f67,_0x1528bd);};};Object[_0x28f84c(0x189)](exports,'__esModule',{'value':!![]}),exports[_0x28f84c(0x176)]=void 0x0;const globalConfig_service_1=require(_0x28f84c(0x18e)),upload_service_1=require(_0x28f84c(0x193)),common_1=require('@nestjs/common'),axios_1=require('axios'),chatLog_service_1=require(_0x28f84c(0x17e)),balance_constant_1=require(_0x28f84c(0x183)),utils_1=require(_0x28f84c(0x13f)),chatLog_entity_1=require(_0x28f84c(0x191)),typeorm_1=require(_0x28f84c(0x15d)),typeorm_2=require(_0x28f84c(0x154)),balance_entity_1=require(_0x28f84c(0x1b9)),fanyi_service_1=require(_0x28f84c(0x172)),badwords_service_1=require('../badwords/badwords.service');let MjService=class MjService{constructor(_0x248e29,_0x4f1526,_0x195343,_0x224ecc,_0xd9dd43,_0x42feca,_0x372f59){const _0x5b84ca=_0x28f84c;this[_0x5b84ca(0x18d)]=_0x248e29,this[_0x5b84ca(0x1a7)]=_0x4f1526,this[_0x5b84ca(0x1c3)]=_0x195343,this[_0x5b84ca(0x1c8)]=_0x224ecc,this[_0x5b84ca(0x143)]=_0xd9dd43,this[_0x5b84ca(0x128)]=_0x42feca,this[_0x5b84ca(0x18f)]=_0x372f59,this[_0x5b84ca(0x14a)]={},this[_0x5b84ca(0x12d)]=[],this['enlargeWorking']=[],this[_0x5b84ca(0x182)]=0x0,this[_0x5b84ca(0x1a2)]={};}async['mjDraw'](_0x48556b){const _0x404b5f=_0x28f84c,{jobId:_0x5df5ce,prompt:_0x3c6ce9,startTime:_0x414a81,userId:_0x1772d7}=_0x48556b;return console[_0x404b5f(0x156)]('绘画任务开始','mjservice'),await new Promise(_0x39633d=>setTimeout(_0x39633d,0x1388)),{'a':0x1,'b':0x2};}async[_0x28f84c(0x19f)](_0x2dc603,_0x14864e){const _0x112cba=_0x28f84c;await this[_0x112cba(0x1cf)](_0x14864e),await this[_0x112cba(0x18f)][_0x112cba(0x1bd)](_0x2dc603[_0x112cba(0x1d3)],_0x14864e[_0x112cba(0x1db)]['id']);const _0x5da116=_0x2dc603[_0x112cba(0x1d3)];let _0x2c33aa=_0x2dc603[_0x112cba(0x1d3)];const {baiduFanyiAppId:_0x113a4f,baiduFanyiSecret:_0x1e9a03}=await this[_0x112cba(0x143)][_0x112cba(0x194)]([_0x112cba(0x133),_0x112cba(0x164)]);_0x113a4f&&_0x1e9a03&&(_0x2c33aa=await this[_0x112cba(0x128)][_0x112cba(0x1c6)](_0x5da116));const _0x214267='['+(0x0,utils_1[_0x112cba(0x1d0)])()+']',_0x49ab4e=_0x214267+'\x20'+_0x2c33aa;console['log'](_0x112cba(0x1bc),_0x214267),console[_0x112cba(0x156)](_0x112cba(0x17c),_0x49ab4e);const _0x157eca=this[_0x112cba(0x12d)][_0x112cba(0x149)](_0x3800d4=>_0x3800d4['includes'](_0x2dc603[_0x112cba(0x1d3)]));if(_0x157eca)throw new common_1['HttpException'](_0x112cba(0x1c4),common_1[_0x112cba(0x1d6)]['BAD_REQUEST']);if(this[_0x112cba(0x182)]>=0x3)throw new common_1['HttpException'](_0x112cba(0x141),common_1[_0x112cba(0x1d6)]['BAD_REQUEST']);await this['checkRateLimit'](_0x14864e),this['queueCount']++,console[_0x112cba(0x156)](_0x112cba(0x18b)+_0x14864e['user']['id']+_0x112cba(0x129),this['queueCount']);try{const _0x4a46e3=await this[_0x112cba(0x18d)][_0x112cba(0x149)]({'where':{'prompt':(0x0,typeorm_1[_0x112cba(0x199)])('%'+_0x49ab4e+'%')}}),_0x502f3a=_0x4a46e3[_0x112cba(0x162)](_0x4d108c=>_0x4d108c[_0x112cba(0x15f)]);this[_0x112cba(0x12d)][_0x112cba(0x135)](_0x49ab4e);let _0x18c7a9;const _0x3aeaae=await this[_0x112cba(0x1c5)](_0x49ab4e,_0x502f3a,_0x214267);_0x3aeaae?(console[_0x112cba(0x156)](_0x112cba(0x1ba)),_0x18c7a9=_0x3aeaae):_0x18c7a9=await this[_0x112cba(0x1a4)](_0x49ab4e,_0x502f3a,_0x214267);this[_0x112cba(0x182)]--,this[_0x112cba(0x182)]<0x0&&(this['queueCount']=0x0),console['log']('绘制图片任务结束\x20队列-1:\x20',this['queueCount']);const {id:_0x299b4b,content:_0x48afee,channel_id:_0x3f4e56,attachments:attachments=[],timestamp:_0x3aff73}=_0x18c7a9;if(!attachments[_0x112cba(0x132)]||!attachments[0x0][_0x112cba(0x196)])throw new common_1['HttpException'](_0x112cba(0x18c),common_1[_0x112cba(0x1d6)]['BAD_REQUEST']);const {filename:_0x4d06fd,url:_0x1ce13b,width:_0x240034,height:_0x4e42b3,size:_0x218c81}=attachments[0x0];console[_0x112cba(0x156)](_0x112cba(0x171),_0x1ce13b);const _0x320c90=this[_0x112cba(0x143)][_0x112cba(0x194)]([_0x112cba(0x1c2)]);let _0x4e4f4b='';(!Number(_0x320c90)||Number(_0x320c90)===0x0)&&(_0x4e4f4b=await this[_0x112cba(0x1c3)][_0x112cba(0x127)]({'filename':_0x4d06fd,'url':_0x1ce13b}),console['log'](_0x112cba(0x136),_0x4e4f4b));const _0x2d7062={'curIp':(0x0,utils_1[_0x112cba(0x19c)])(_0x14864e),'userId':_0x14864e['user']['id'],'type':balance_constant_1[_0x112cba(0x1b0)][_0x112cba(0x1a3)],'prompt':_0x49ab4e,'answer':_0x4e4f4b,'model':'mj','extend':this[_0x112cba(0x1a1)](JSON[_0x112cba(0x12e)](_0x18c7a9)),'message_id':_0x299b4b,'variationId':_0x299b4b,'upscaleId':_0x299b4b,'group':0x1,'isSaveImg':!Number(_0x320c90)||Number(_0x320c90)===0x0,'fileInfo':JSON[_0x112cba(0x12e)]({'width':_0x240034,'height':_0x4e42b3,'size':_0x218c81,'filename':_0x4d06fd,'cosUrl':_0x4e4f4b})};return await this[_0x112cba(0x1c8)][_0x112cba(0x192)](_0x2d7062),await this[_0x112cba(0x150)](_0x14864e),this[_0x112cba(0x12d)]=this[_0x112cba(0x12d)][_0x112cba(0x1d2)](_0x13c62f=>_0x13c62f!==_0x2dc603[_0x112cba(0x1d3)]),_0x4e4f4b;}catch(_0x108543){this[_0x112cba(0x182)]--,this[_0x112cba(0x182)]<0x0&&(this[_0x112cba(0x182)]=0x0),console[_0x112cba(0x156)](_0x112cba(0x186),this[_0x112cba(0x182)]),this[_0x112cba(0x12d)]=this['drawWorking'][_0x112cba(0x1d2)](_0x5840d5=>_0x5840d5!==_0x2dc603[_0x112cba(0x1d3)]);throw new common_1['HttpException'](_0x108543['response'],common_1[_0x112cba(0x1d6)][_0x112cba(0x1b1)]);}}async[_0x28f84c(0x178)](_0x3d4c9b,_0x57fcab){const _0x184b9f=_0x28f84c;if(this[_0x184b9f(0x182)]>=0x3)throw new common_1[(_0x184b9f(0x1dc))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x184b9f(0x1d6)][_0x184b9f(0x1b1)]);this[_0x184b9f(0x182)]++,console['log']('用户'+_0x57fcab[_0x184b9f(0x1db)]['id']+_0x184b9f(0x158),this[_0x184b9f(0x182)]);const {message_id:_0x432044,orderId:_0x2f3deb}=_0x3d4c9b;try{const _0x237505=await this[_0x184b9f(0x18d)][_0x184b9f(0x14e)]({'where':{'message_id':_0x432044}});if(!_0x237505)throw new common_1[(_0x184b9f(0x1dc))](_0x184b9f(0x157),common_1[_0x184b9f(0x1d6)][_0x184b9f(0x1b1)]);const _0x317756=await this[_0x184b9f(0x18d)][_0x184b9f(0x14e)]({'where':{'upscaleId':_0x432044,'action':_0x184b9f(0x190),'orderId':_0x2f3deb}});if(_0x317756)throw new common_1[(_0x184b9f(0x1dc))](_0x184b9f(0x1aa),common_1[_0x184b9f(0x1d6)][_0x184b9f(0x1b1)]);const {prompt:_0x1ce995,extend:_0x4e06c0}=_0x237505;let _0xed96b9=null;try{_0xed96b9=JSON[_0x184b9f(0x174)](_0x4e06c0);}catch(_0x4e1ea1){_0xed96b9=[];}const {components:components=[]}=_0xed96b9;if(!components['length'])throw new common_1[(_0x184b9f(0x1dc))](_0x184b9f(0x1b5),common_1[_0x184b9f(0x1d6)][_0x184b9f(0x1b1)]);const _0x3f51f0=components[0x0]['components'][_0x2f3deb-0x1],{custom_id:_0x43a56e}=_0x3f51f0;console[_0x184b9f(0x156)](_0x184b9f(0x187),_0x43a56e);const _0x569738={'message_id':_0x432044,'custom_id':_0x43a56e,'prompt':_0x1ce995,'orderId':_0x2f3deb};await this[_0x184b9f(0x155)](_0x569738),console[_0x184b9f(0x156)](_0x184b9f(0x138));const _0x3f457b=await this[_0x184b9f(0x18d)][_0x184b9f(0x149)]({'where':{'prompt':(0x0,typeorm_1[_0x184b9f(0x199)])('%'+_0x1ce995+'%')}}),_0x6335d4=_0x3f457b[_0x184b9f(0x162)](_0x382fc8=>_0x382fc8[_0x184b9f(0x15f)]);console[_0x184b9f(0x156)]('历史这些id已经被获取过了\x20不能拿了:\x20',_0x6335d4);const _0x275285=await this[_0x184b9f(0x151)](_0x569738,_0x6335d4);this['queueCount']--,this[_0x184b9f(0x182)]<0x0&&(this[_0x184b9f(0x182)]=0x0),console['log']('放大图片任务结束\x20队列-1:\x20',this[_0x184b9f(0x182)]);const {id:_0x7c1233,content:_0x146710,channel_id:_0x51f28c,attachments:attachments=[],timestamp:_0x1f3ca9}=_0x275285;if(!attachments[_0x184b9f(0x132)]||!attachments[0x0]['url'])throw new common_1[(_0x184b9f(0x1dc))](_0x184b9f(0x166),common_1['HttpStatus'][_0x184b9f(0x1b1)]);const {filename:_0x452e87,url:_0x2f3f78,width:_0x4935c4,height:_0x38c87e,size:_0xc8969d}=attachments[0x0],_0x3e7868=this[_0x184b9f(0x143)]['getConfigs'](['mjNotSaveImg']);let _0x5da9e6='';(!Number(_0x3e7868)||Number(_0x3e7868)===0x0)&&(_0x5da9e6=await this[_0x184b9f(0x1c3)][_0x184b9f(0x127)]({'filename':_0x452e87,'url':_0x2f3f78}),console[_0x184b9f(0x156)](_0x184b9f(0x136),_0x5da9e6));const _0x3b3c33={'curIp':(0x0,utils_1[_0x184b9f(0x19c)])(_0x57fcab),'userId':_0x57fcab[_0x184b9f(0x1db)]['id'],'type':balance_constant_1[_0x184b9f(0x1b0)][_0x184b9f(0x1a3)],'prompt':_0x1ce995,'answer':_0x5da9e6,'model':'mj','extend':this[_0x184b9f(0x1a1)](JSON['stringify'](_0x275285)),'message_id':_0x432044,'upscaleId':_0x7c1233,'variationId':_0x7c1233,'action':_0x184b9f(0x190),'orderId':_0x569738[_0x184b9f(0x145)],'isSaveImg':!Number(_0x3e7868)||Number(_0x3e7868)===0x0,'fileInfo':JSON[_0x184b9f(0x12e)]({'width':_0x4935c4,'height':_0x38c87e,'size':_0xc8969d,'filename':_0x452e87,'cosUrl':_0x5da9e6})};return await this[_0x184b9f(0x1c8)][_0x184b9f(0x192)](_0x3b3c33),_0x5da9e6;}catch(_0x3ad6cb){console[_0x184b9f(0x156)]('error:\x20',_0x3ad6cb),this[_0x184b9f(0x182)]--,this['queueCount']<0x0&&(this['queueCount']=0x0),console[_0x184b9f(0x156)](_0x184b9f(0x16a),this['queueCount']);throw new common_1[(_0x184b9f(0x1dc))](_0x3ad6cb[_0x184b9f(0x1d8)],common_1['HttpStatus'][_0x184b9f(0x1b1)]);}}async[_0x28f84c(0x1cc)](_0x3394ea,_0x289179){const _0xcd85f0=_0x28f84c;if(this['queueCount']>=0x3)throw new common_1[(_0xcd85f0(0x1dc))](_0xcd85f0(0x141),common_1['HttpStatus'][_0xcd85f0(0x1b1)]);await this[_0xcd85f0(0x1cf)](_0x289179),await this[_0xcd85f0(0x1af)](_0x289179),this[_0xcd85f0(0x182)]++,console[_0xcd85f0(0x156)]('用户'+_0x289179[_0xcd85f0(0x1db)]['id']+'开始请求变换图片\x20队列+1:\x20',this['queueCount']);const {message_id:_0xfb064f,orderId:_0x4355bf}=_0x3394ea;try{const _0x2a82dd=await this['chatLogEntity'][_0xcd85f0(0x14e)]({'where':{'message_id':_0xfb064f}});if(!_0x2a82dd)throw new common_1[(_0xcd85f0(0x1dc))](_0xcd85f0(0x1d4),common_1[_0xcd85f0(0x1d6)][_0xcd85f0(0x1b1)]);const {prompt:_0x4ad81b,extend:_0x1b4fe8}=_0x2a82dd;let _0x104d89=null;try{_0x104d89=JSON[_0xcd85f0(0x174)](_0x1b4fe8);}catch(_0x205860){_0x104d89=[];}const {components:components=[]}=_0x104d89;if(!components[_0xcd85f0(0x132)])throw new common_1[(_0xcd85f0(0x1dc))](_0xcd85f0(0x161),common_1[_0xcd85f0(0x1d6)]['BAD_REQUEST']);const _0x37e17b=components[0x1][_0xcd85f0(0x17b)][_0x4355bf-0x1],{custom_id:_0x1337bd}=_0x37e17b,_0x47728f=await this['chatLogEntity'][_0xcd85f0(0x149)]({'where':{'variationId':(0x0,typeorm_1['Not'])((0x0,typeorm_1[_0xcd85f0(0x159)])()),'prompt':(0x0,typeorm_1[_0xcd85f0(0x199)])('%'+_0x4ad81b+'%')}}),_0x1d60e3=_0x47728f[_0xcd85f0(0x162)](_0x490c1f=>_0x490c1f[_0xcd85f0(0x195)]),_0x1e180b={'message_id':_0xfb064f,'custom_id':_0x1337bd,'prompt':_0x4ad81b,'orderId':_0x4355bf};await this[_0xcd85f0(0x155)](_0x1e180b);const _0x445d35=await this[_0xcd85f0(0x12b)](_0x1e180b,_0x1d60e3);this[_0xcd85f0(0x182)]--,this[_0xcd85f0(0x182)]<0x0&&(this[_0xcd85f0(0x182)]=0x0),console[_0xcd85f0(0x156)](_0xcd85f0(0x12c),this['queueCount']);const {id:_0xbf71fa,content:_0x8883eb,channel_id:_0x597a2c,attachments:attachments=[],timestamp:_0x13cb71}=_0x445d35;if(!attachments['length']||!attachments[0x0]['url'])throw new common_1[(_0xcd85f0(0x1dc))](_0xcd85f0(0x18a),common_1['HttpStatus'][_0xcd85f0(0x1b1)]);const {filename:_0x3d61b4,url:_0x518dbd,width:_0x510452,height:_0x36240a,size:_0x2ce219}=attachments[0x0],_0x4ebd92=this[_0xcd85f0(0x143)][_0xcd85f0(0x194)]([_0xcd85f0(0x1c2)]);let _0x22f8a6='';(!Number(_0x4ebd92)||Number(_0x4ebd92)===0x0)&&(_0x22f8a6=await this['uploadService']['uploadFileFromUrl']({'filename':_0x3d61b4,'url':_0x518dbd}),console[_0xcd85f0(0x156)](_0xcd85f0(0x136),_0x22f8a6));const _0x3825ee={'curIp':(0x0,utils_1[_0xcd85f0(0x19c)])(_0x289179),'userId':_0x289179['user']['id'],'type':balance_constant_1[_0xcd85f0(0x1b0)]['PAINT_TYPE'],'prompt':_0x4ad81b,'answer':_0x22f8a6,'model':'mj','group':0x1,'extend':this[_0xcd85f0(0x1a1)](JSON[_0xcd85f0(0x12e)](_0x445d35)),'message_id':_0xbf71fa,'upscaleId':_0xbf71fa,'variationId':_0xbf71fa,'action':_0xcd85f0(0x190),'orderId':_0x1e180b['orderId'],'isSaveImg':!Number(_0x4ebd92)||Number(_0x4ebd92)===0x0,'fileInfo':JSON[_0xcd85f0(0x12e)]({'width':_0x510452,'height':_0x36240a,'size':_0x2ce219,'filename':_0x3d61b4,'cosUrl':_0x22f8a6})};return await this[_0xcd85f0(0x1c8)][_0xcd85f0(0x192)](_0x3825ee),_0x22f8a6;}catch(_0x5532be){console[_0xcd85f0(0x156)](_0xcd85f0(0x15a),_0x5532be),this['queueCount']--,this[_0xcd85f0(0x182)]<0x0&&(this[_0xcd85f0(0x182)]=0x0),console['log'](_0xcd85f0(0x14f),this[_0xcd85f0(0x182)]);throw new common_1[(_0xcd85f0(0x1dc))](_0x5532be[_0xcd85f0(0x1d8)],common_1[_0xcd85f0(0x1d6)]['BAD_REQUEST']);}}async['sendSmInteractions'](_0x13aeda){const _0x369c2e=_0x28f84c,{message_id:_0x348163,custom_id:_0x394ca4}=_0x13aeda,{application_id:_0x568729,guild_id:_0x56a97c,channel_id:_0x1224a9,session_id:_0xbf4cb4,version:_0x511661,id:_0x12fbee,authorization:_0x14f9b8,mjProxy:_0x21a9ce}=await this[_0x369c2e(0x1ca)](),_0x1d1fe2=_0x21a9ce==0x1?_0x369c2e(0x140):_0x369c2e(0x1cb),_0x3bfd7f={'authorization':_0x14f9b8},_0x6af1a={'type':0x3,'guild_id':_0x56a97c,'channel_id':_0x1224a9,'message_flags':0x0,'message_id':_0x348163,'application_id':_0x568729,'session_id':_0xbf4cb4,'data':{'component_type':0x2,'custom_id':_0x394ca4}};try{await axios_1['default']['post'](_0x1d1fe2,_0x6af1a,{'headers':_0x3bfd7f}),console[_0x369c2e(0x156)](_0x369c2e(0x179));}catch(_0x41b4da){console['log']('error:\x20',_0x41b4da);throw new common_1[(_0x369c2e(0x1dc))](_0x369c2e(0x1de),common_1['HttpStatus']['BAD_REQUEST']);}}async['pollForUpscaleResult'](_0x8a3b9e,_0x137656){const _0x5df161=_0x28f84c,{message_id:_0x39b821,custom_id:_0x39094f,prompt:_0x5ddd4e,orderId:_0x13fa70}=_0x8a3b9e;let _0x5eab5d=null,_0x3d19cf=0x0;while(!_0x5eab5d&&_0x3d19cf<0xa){try{const _0x1480a9=Date[_0x5df161(0x1d5)](),_0x5947aa=await this[_0x5df161(0x19d)]();console[_0x5df161(0x156)]('第\x20'+(_0x3d19cf+0x1)+_0x5df161(0x1a6)+_0x5947aa[_0x5df161(0x132)]);_0x5947aa&&_0x5947aa['length']&&(_0x5eab5d=await this[_0x5df161(0x147)](_0x5947aa,_0x8a3b9e,_0x137656));const _0x1fac9d=Date['now']()-_0x1480a9,_0x372364=0xbb8;await this[_0x5df161(0x1b8)](Math[_0x5df161(0x1be)](_0x372364-_0x1fac9d,0x0)),_0x3d19cf++;}catch(_0x3b4efc){console['error'](_0x5df161(0x198)+_0x3b4efc[_0x5df161(0x168)]);}}return _0x5eab5d;}async['pollForVariationResult'](_0x4298e0,_0x376d3a){const _0x40c1ae=_0x28f84c,{message_id:_0x333512,custom_id:_0x3c6951,prompt:_0x416432,orderId:_0x134158}=_0x4298e0;console['log'](_0x40c1ae(0x19b));let _0x4c7f3a=null,_0x491797=0x0;while(!_0x4c7f3a&&_0x491797<0xa){try{console[_0x40c1ae(0x156)]('第\x20'+(_0x491797+0x1)+_0x40c1ae(0x184));const _0x529643=Date[_0x40c1ae(0x1d5)](),_0x3986d0=await this[_0x40c1ae(0x19d)]();_0x3986d0&&_0x3986d0['length']&&(_0x4c7f3a=await this['findCurrentVariationImgResult'](_0x3986d0,_0x4298e0,_0x376d3a));const _0x3c4304=Date[_0x40c1ae(0x1d5)]()-_0x529643,_0x47710e=0x1f40;await this[_0x40c1ae(0x1b8)](Math[_0x40c1ae(0x1be)](_0x47710e-_0x3c4304,0x0)),_0x491797++;}catch(_0x38cebb){console['error']('查询期间出现错误：'+_0x38cebb['message']);}}if(!_0x4c7f3a)throw new common_1[(_0x40c1ae(0x1dc))]('变换当前图片超时！',common_1['HttpStatus'][_0x40c1ae(0x1b1)]);return _0x4c7f3a;}async[_0x28f84c(0x147)](_0x4db01e,_0x23783a,_0x293f7a){const _0x42b986=_0x28f84c,{message_id:_0x437140,custom_id:_0x3b908a,prompt:_0x53deaa,orderId:_0x5ede79}=_0x23783a,_0x40793a=_0x53deaa[_0x42b986(0x1bf)](0x0,0xc);console['log']('本次放大图片的id:\x20',_0x40793a);const _0x4464e2=_0x4db01e[_0x42b986(0x149)](_0xd2caa8=>{const _0x17f285=_0x42b986,{content:_0x9b79c2}=_0xd2caa8;if(!this[_0x17f285(0x180)](_0x9b79c2))return![];const {prompt:_0x542fd3,order:_0x13d7a8}=this['extractContent'](_0x9b79c2);return _0x542fd3['includes'](_0x40793a)&&_0x23783a[_0x17f285(0x145)]===_0x13d7a8&&!_0x293f7a['includes'](_0xd2caa8['id']);});return _0x4464e2;}async[_0x28f84c(0x1ae)](_0x5ed624,_0x3c904f,_0xf2ad06){const _0xa75699=_0x28f84c,{message_id:_0x33380a,custom_id:_0x4544ef,prompt:_0x388fc8,orderId:_0x354ab9}=_0x3c904f,_0x1c2faa=_0x388fc8[_0xa75699(0x1bf)](0x0,0xc),_0xe7abcd=_0x5ed624[_0xa75699(0x149)](_0x2693fd=>{const _0x2e8317=_0xa75699,{content:_0x5bc40b}=_0x2693fd,_0x17f35f=_0x5bc40b[_0x2e8317(0x1c1)](/\*\*(.+?)\*\*/),_0x44d099=_0x17f35f?_0x17f35f[0x1]:'';if(!_0x44d099)return![];return _0x44d099[_0x2e8317(0x1d1)](_0x1c2faa)&&!_0xf2ad06[_0x2e8317(0x1d1)](_0x2693fd['id']);});return _0xe7abcd;}async[_0x28f84c(0x1c5)](_0x25d477,_0x53eb43,_0x599759){const _0xe24273=_0x28f84c,_0xe400c7=await this[_0xe24273(0x19d)](),_0x169751=await this[_0xe24273(0x1ab)](_0xe400c7,_0x599759,_0x53eb43);if(_0x169751)return console[_0xe24273(0x156)](_0xe24273(0x1c0),_0x169751),_0x169751;const {application_id:_0x23570c,guild_id:_0x3a8827,channel_id:_0x3e08c8,session_id:_0xbc23da,version:_0x2af2b3,id:_0x3cae9d,authorization:_0x14deed,mjProxy:_0x2e52ca}=await this[_0xe24273(0x1ca)](),_0x28426a={'type':0x2,'application_id':_0x23570c,'guild_id':_0x3a8827,'channel_id':_0x3e08c8,'session_id':_0xbc23da,'data':{'version':_0x2af2b3,'id':_0x3cae9d,'name':_0xe24273(0x12a),'type':0x1,'options':[{'type':0x3,'name':_0xe24273(0x1d3),'value':_0x25d477}],'attachments':[]}};try{const _0x1d40ad=_0x2e52ca==0x1?_0xe24273(0x140):_0xe24273(0x1cb),_0x3b5477={'authorization':_0x14deed},_0x5b0c8d=await axios_1['default'][_0xe24273(0x1da)](_0x1d40ad,_0x28426a,{'headers':_0x3b5477});return console['log'](_0xe24273(0x1b6),_0x5b0c8d[_0xe24273(0x1dd)]),![];}catch(_0x2cc70a){console[_0xe24273(0x156)]('axios:\x20',_0x2cc70a);throw new common_1[(_0xe24273(0x1dc))]('绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...',common_1[_0xe24273(0x1d6)][_0xe24273(0x1b1)]);}}async[_0x28f84c(0x1a4)](_0x7fbf67,_0x42b916,_0xb40c44){const _0x16e0e6=_0x28f84c;console[_0x16e0e6(0x156)](_0x16e0e6(0x134));const _0x58fe44=Date[_0x16e0e6(0x1d5)]();try{const _0xace9d9=0xd,_0x12933e=0x2ee0,_0x11d48c=0x1388,_0x47e409=0x3c*0x3e8;let _0x3a57d5=0x0,_0x41a5e8=![],_0x88723d=null;while(!_0x88723d&&_0x3a57d5<_0xace9d9){console[_0x16e0e6(0x156)]('第\x20'+(_0x3a57d5+0x1)+_0x16e0e6(0x146));Date[_0x16e0e6(0x1d5)]()-_0x58fe44>=_0x47e409&&(_0x41a5e8=!![]);await this[_0x16e0e6(0x1b8)](_0x41a5e8?_0x11d48c:_0x12933e);const _0x57e697=await this[_0x16e0e6(0x19d)]();_0x88723d=await this[_0x16e0e6(0x1ab)](_0x57e697,_0xb40c44,_0x42b916),_0x3a57d5++;}if(!_0x88723d)throw new common_1['HttpException'](_0x16e0e6(0x1d7),common_1[_0x16e0e6(0x1d6)][_0x16e0e6(0x1b1)]);const _0x13d0c5=Date[_0x16e0e6(0x1d5)]();return console[_0x16e0e6(0x156)](_0x16e0e6(0x13a)+Math[_0x16e0e6(0x152)]((_0x13d0c5-_0x58fe44)/0x3e8)+'\x20S'),_0x88723d;}catch(_0x32db35){console[_0x16e0e6(0x1c7)](_0x32db35[_0x16e0e6(0x168)]);throw new common_1[(_0x16e0e6(0x1dc))](_0x16e0e6(0x130),common_1['HttpStatus']['INTERNAL_SERVER_ERROR']);}}async[_0x28f84c(0x1ab)](_0x282d17,_0x276c4f,_0x1a7b08){const _0x3453e3=_0x28f84c;if(!_0x282d17||!_0x282d17['length'])return;console[_0x3453e3(0x156)](_0x3453e3(0x131),_0x276c4f);const _0x4b466b=_0x282d17[_0x3453e3(0x149)](_0x25259a=>{const _0x2e85dc=_0x3453e3,{attachments:attachments=[],content:_0x93477c,edited_timestamp:_0x26b1c4}=_0x25259a;return _0x93477c[_0x2e85dc(0x1d1)](_0x276c4f)&&attachments[_0x2e85dc(0x132)]>0x0&&!_0x26b1c4&&!_0x1a7b08['includes'](_0x25259a['id']);});return _0x4b466b||null;}async[_0x28f84c(0x19d)](){const _0x31db1e=_0x28f84c;try{const {application_id:_0x190af4,guild_id:_0x548608,channel_id:_0x30c379,session_id:_0x54b7ff,version:_0x449eaf,id:_0x24fa5b,authorization:_0x3499a9,mjProxy:_0x244bbd}=await this[_0x31db1e(0x1ca)](),_0x3611ed=_0x244bbd==0x1?_0x31db1e(0x1ac)+_0x30c379:_0x31db1e(0x15e)+_0x30c379+_0x31db1e(0x163),_0x3fafa5={'authorization':_0x3499a9},_0x106664=await axios_1[_0x31db1e(0x14b)][_0x31db1e(0x19e)](_0x3611ed,{'headers':_0x3fafa5});return _0x106664[_0x31db1e(0x1dd)];}catch(_0x3bd2af){console[_0x31db1e(0x156)](_0x31db1e(0x1b4),_0x3bd2af);throw new common_1[(_0x31db1e(0x1dc))]('查询绘制结果失败...',common_1[_0x31db1e(0x1d6)][_0x31db1e(0x1b1)]);}}async[_0x28f84c(0x1b8)](_0xc282){return new Promise(_0x229343=>setTimeout(_0x229343,_0xc282));}[_0x28f84c(0x180)](_0x2050b9){const _0x572c47=_0x28f84c,_0x139862=_0x2050b9[_0x572c47(0x1c1)](/\*\*(.+?)\*\*/),_0x3b0118=_0x2050b9[_0x572c47(0x1c1)](/- Image #(\d+)/);if(!_0x139862||!_0x3b0118)return null;const _0xa80db1=_0x139862[0x1],_0x46bd87=parseInt(_0x3b0118[0x1]);return{'prompt':_0xa80db1,'order':_0x46bd87};}async['getMjDefaultParams'](){const _0x4c3c0a=_0x28f84c,_0x56be10=await this['globalConfigService']['getConfigs']([_0x4c3c0a(0x1b3),'mjApplicationId','mjGuildId',_0x4c3c0a(0x1c9),_0x4c3c0a(0x1ce),_0x4c3c0a(0x169),_0x4c3c0a(0x1b7),_0x4c3c0a(0x17f),_0x4c3c0a(0x148)]),_0x1e74ab={'application_id':_0x56be10[_0x4c3c0a(0x15c)],'guild_id':_0x56be10['mjGuildId'],'channel_id':_0x56be10[_0x4c3c0a(0x1c9)],'session_id':_0x56be10['mjSessionId'],'version':_0x56be10[_0x4c3c0a(0x169)],'id':_0x56be10[_0x4c3c0a(0x1b3)],'authorization':_0x56be10[_0x4c3c0a(0x1b7)],'mjRateLimit':_0x56be10['mjRateLimit'],'mjProxy':_0x56be10['mjProxy']||0x0};return _0x1e74ab;}[_0x28f84c(0x1a1)](_0x12d990){const _0x53b554=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x12d990['replace'](_0x53b554,'');}async['checkAuth'](_0x26355d){const _0x398b33=_0x28f84c,_0x4551b0=await this[_0x398b33(0x1a7)][_0x398b33(0x14e)]({'where':{'userId':_0x26355d[_0x398b33(0x1db)]['id']}}),{id:_0x57893c,balance:_0x41a921}=_0x4551b0;if(!_0x41a921||(_0x4551b0===null||_0x4551b0===void 0x0?void 0x0:_0x4551b0[_0x398b33(0x139)])<0x1)throw new common_1[(_0x398b33(0x1dc))]('您当前暂无MJ绘画余额！！！',common_1[_0x398b33(0x1d6)][_0x398b33(0x1b1)]);}async[_0x28f84c(0x17d)](_0x49ec2c){const _0x1db903=_0x28f84c,{id:_0x11c98e,role:_0x35c3bf}=_0x49ec2c[_0x1db903(0x1db)];!this[_0x1db903(0x1a2)][_0x11c98e]?this['freeQueueUsers'][_0x11c98e]=0x1:this[_0x1db903(0x1a2)][_0x11c98e]=this[_0x1db903(0x1a2)][_0x11c98e]+0x1,console[_0x1db903(0x156)]('当前用户'+_0x11c98e+_0x1db903(0x1cd),this[_0x1db903(0x1a2)][_0x11c98e]);}async['checkRateLimit'](_0x2199f9){const _0x4f42e6=_0x28f84c,{id:_0xc81d3d,role:_0x14a279}=_0x2199f9[_0x4f42e6(0x1db)];if([_0x4f42e6(0x16f),_0x4f42e6(0x13d)][_0x4f42e6(0x1d1)](_0x14a279))return!![];const {mjRateLimit:_0xe77bd6}=await this[_0x4f42e6(0x1ca)]();if(this[_0x4f42e6(0x14a)][_0xc81d3d]){const _0x28cc67=this['rateLimits'][_0xc81d3d];if(_0x28cc67>Date['now']()){console['log'](_0x4f42e6(0x1b2)+_0xc81d3d+_0x4f42e6(0x181));throw new common_1[(_0x4f42e6(0x1dc))](_0x4f42e6(0x13c)+_0xe77bd6+'秒请求一次、请合理使用！',common_1[_0x4f42e6(0x1d6)][_0x4f42e6(0x1b1)]);}else this[_0x4f42e6(0x14a)][_0xc81d3d]=Date[_0x4f42e6(0x1d5)]()+Number(_0xe77bd6)*0x3e8;}else{const _0x4f7abd=Date['now']();this['rateLimits'][_0xc81d3d]=_0x4f7abd+0x3e8*Number(_0xe77bd6);}}async[_0x28f84c(0x150)](_0x2ba316){const _0x307c07=_0x28f84c;await this['balanceEntity'][_0x307c07(0x177)]()[_0x307c07(0x175)](balance_entity_1[_0x307c07(0x13e)])['set']({'balance':()=>_0x307c07(0x1a0)})['where'](_0x307c07(0x160),{'userId':_0x2ba316[_0x307c07(0x1db)]['id']})[_0x307c07(0x144)]();}async[_0x28f84c(0x15b)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x28f84c(0x17a)])(),__param(0x0,(0x0,typeorm_2[_0x28f84c(0x153)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_2[_0x28f84c(0x153)])(balance_entity_1['BalanceEntity'])),__metadata(_0x28f84c(0x14d),[typeorm_1[_0x28f84c(0x1d9)],typeorm_1[_0x28f84c(0x1d9)],upload_service_1[_0x28f84c(0x1a8)],chatLog_service_1['ChatLogService'],globalConfig_service_1[_0x28f84c(0x142)],fanyi_service_1[_0x28f84c(0x1a5)],badwords_service_1[_0x28f84c(0x167)]])],MjService),exports['MjService']=MjService;function _0x2f80(){const _0x299781=['baiduFanyiSecret','__param','放大当前图片失败','BadwordsService','message','mjVersion','放大图片任务异常中断\x20队列-1:\x20','__decorate','6786801FBorRA','decorate','5134824mJIQBq','admin','179037AoVBfs','拿到了远程地址:\x20','../fanyi/fanyi.service','8830130ruhxnA','parse','update','MjService','createQueryBuilder','upscaleSingleImg','绘图指令完成','Injectable','components','prompt\x20-------->\x20\x20','checkFree','../chatLog/chatLog.service','mjRateLimit','extractContent','\x20请求过于频繁！','queueCount','../../common/constants/balance.constant','\x20次开始查询[变换图片]','237946LnEYPu','绘制图片任务异常中断\x20队列-1:\x20','放大custom_id:\x20','39648774ehbUHM','defineProperty','变换当前图片失败','开始请求用户','绘画失败','chatLogEntity','./../globalConfig/globalConfig.service','badwordsService','enlarge','../chatLog/chatLog.entity','saveChatLog','./../upload/upload.service','getConfigs','variationId','url','80qgBaIM','查询期间出现错误：','Like','262230LqEbhH','开始轮询单张变换图片结果','getClientIp','queryMessageList','get','draw','balance\x20-\x201','removeEmoji','freeQueueUsers','PAINT_TYPE','pollForResult','FanyiService','\x20次开始查询\x20=>\x20当前查询结果：','balanceEntity','UploadService','9GHwDtc','当前图片已经放大过了、请勿重复放大!','findCurrentPromptResult','http://172.247.48.137:8000/mj/list?channel_id=','function','findCurrentVariationImgResult','checkRateLimit','DeductionKey','BAD_REQUEST','当前用户\x20','mjId','axios\x20get:\x20','当前图片没有绘画信息、无法放大!','发送绘画指令结果:\x20','mjAuthorization','sleep','../userBalance/balance.entity','历史中存在当前图片、直接获取！','5CyEnJZ','randomId:\x20','checkBadWords','max','substring','有历史信息之间返回:\x20','match','mjNotSaveImg','uploadService','当前提示词已经在任务队列中了、请勿重复提交。。。','sendDrawInteractions','convertToEnglish','error','chatLogService','mjChannelId','getMjDefaultParams','https://discord.com/api/v9/interactions','variationSingleImg','使用的次数：','mjSessionId','checkAuth','createRandomUid','includes','filter','prompt','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','now','HttpStatus','绘画超时，请稍后再试！','response','Repository','post','user','HttpException','data','放大单张图片请求失败...','uploadFileFromUrl','fanyiService','\x20队列+1:\x20','imagine','pollForVariationResult','变换图片任务结束\x20队列-1:\x20','drawWorking','stringify','__metadata','网络连接失败，请稍后再试！','本次比对的随机ID:\x20','length','baiduFanyiAppId','开始查询绘画结果轮询','push','存入图片完成:\x20','metadata','发送放大指令成功','balance','本次绘图耗时:\x20','12QcIMaP','由于速率限制、当前普通用户限制为','super','BalanceEntity','../../common/utils','http://172.247.48.137:8000/mj/draw','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','GlobalConfigService','globalConfigService','execute','orderId','\x20次开始查询','findCurrentEnlargeImgResult','mjProxy','find','rateLimits','default','object','design:paramtypes','findOne','变化图片任务异常中断\x20队列-1:\x20','deductBalance','pollForUpscaleResult','floor','InjectRepository','@nestjs/typeorm','sendSmInteractions','log','历史记录中不存在当前图片、请确认您放大的图片是否存在','开始请求放大图片\x20队列+1:\x20','IsNull','error:\x20','test','mjApplicationId','typeorm','https://discord.com/api/v9/channels/','message_id','userId\x20=\x20:userId','当前图片没有绘画信息、无法变体!','map','/messages?limit=50'];_0x2f80=function(){return _0x299781;};return _0x2f80();}