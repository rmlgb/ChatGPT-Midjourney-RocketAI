'use strict';const _0xa02779=_0x5e54;(function(_0x368ac2,_0x544b02){const _0x415fa1=_0x5e54,_0x4f0b9a=_0x368ac2();while(!![]){try{const _0x353e73=parseInt(_0x415fa1(0x111))/0x1*(parseInt(_0x415fa1(0x11e))/0x2)+parseInt(_0x415fa1(0x11a))/0x3+parseInt(_0x415fa1(0xf5))/0x4+-parseInt(_0x415fa1(0x12f))/0x5*(-parseInt(_0x415fa1(0x117))/0x6)+parseInt(_0x415fa1(0x149))/0x7*(parseInt(_0x415fa1(0xfd))/0x8)+parseInt(_0x415fa1(0x118))/0x9+-parseInt(_0x415fa1(0x106))/0xa;if(_0x353e73===_0x544b02)break;else _0x4f0b9a['push'](_0x4f0b9a['shift']());}catch(_0x5f1134){_0x4f0b9a['push'](_0x4f0b9a['shift']());}}}(_0x545e,0xc3cdf));function _0x5e54(_0x1f2249,_0x1d4b53){const _0x545e4b=_0x545e();return _0x5e54=function(_0x5e5490,_0x70f7e8){_0x5e5490=_0x5e5490-0xf5;let _0x140b27=_0x545e4b[_0x5e5490];return _0x140b27;},_0x5e54(_0x1f2249,_0x1d4b53);}var __decorate=this&&this[_0xa02779(0x104)]||function(_0x4445b7,_0x59226d,_0x55baf6,_0x4acfcc){const _0x3d758b=_0xa02779;var _0x2b96e5=arguments[_0x3d758b(0x124)],_0x4cfef8=_0x2b96e5<0x3?_0x59226d:_0x4acfcc===null?_0x4acfcc=Object[_0x3d758b(0x115)](_0x59226d,_0x55baf6):_0x4acfcc,_0x558db3;if(typeof Reflect===_0x3d758b(0x131)&&typeof Reflect[_0x3d758b(0x140)]===_0x3d758b(0xf9))_0x4cfef8=Reflect['decorate'](_0x4445b7,_0x59226d,_0x55baf6,_0x4acfcc);else{for(var _0x11d9e8=_0x4445b7[_0x3d758b(0x124)]-0x1;_0x11d9e8>=0x0;_0x11d9e8--)if(_0x558db3=_0x4445b7[_0x11d9e8])_0x4cfef8=(_0x2b96e5<0x3?_0x558db3(_0x4cfef8):_0x2b96e5>0x3?_0x558db3(_0x59226d,_0x55baf6,_0x4cfef8):_0x558db3(_0x59226d,_0x55baf6))||_0x4cfef8;}return _0x2b96e5>0x3&&_0x4cfef8&&Object[_0x3d758b(0x125)](_0x59226d,_0x55baf6,_0x4cfef8),_0x4cfef8;},__metadata=this&&this['__metadata']||function(_0x3c884c,_0x32cf97){const _0x51f852=_0xa02779;if(typeof Reflect===_0x51f852(0x131)&&typeof Reflect[_0x51f852(0x11d)]===_0x51f852(0xf9))return Reflect[_0x51f852(0x11d)](_0x3c884c,_0x32cf97);},__param=this&&this['__param']||function(_0x5a605e,_0xaa8a20){return function(_0xfa0222,_0xab85df){_0xaa8a20(_0xfa0222,_0xab85df,_0x5a605e);};};Object[_0xa02779(0x125)](exports,_0xa02779(0x13a),{'value':!![]}),exports['OrderService']=void 0x0;const user_entity_1=require(_0xa02779(0x132)),typeorm_1=require('@nestjs/typeorm'),common_1=require('@nestjs/common'),typeorm_2=require(_0xa02779(0x10d)),order_entity_1=require(_0xa02779(0x144)),cramiPackage_entity_1=require(_0xa02779(0x11c)),utils_1=require(_0xa02779(0x121)),pay_service_1=require(_0xa02779(0x12a)),globalConfig_service_1=require(_0xa02779(0xfa));function _0x545e(){const _0x567370=['440195BInnkX','total_price','object','./../user/user.entity','map','assign','payService','coverImg','BAD_REQUEST','userInfo','userId','__esModule','price','购买失败!','Repository','message','queryAllOrder','decorate','UNAUTHORIZED','des','order:\x20','./order.entity','InjectRepository','userEntity','payPlatform','DESC','25396biUhot','forEach','3815996qsZPNc','pay','HttpException','status','function','../globalConfig/globalConfig.service','find','findOne','3008PuRKMJ','Injectable','create','name','username','goodsId','where','__decorate','套餐不存在!','52445900Lzljsm','order.status\x20=\x20:status','deleteNotPay','buy','total','user','deleteOrder','typeorm','SUM(order.price)','createQueryBuilder','orderId','476513SYhihW','cramiPackageEntity','findAndCount','PayService','getOwnPropertyDescriptor','queryPayType','24qkVxRr','12118986VMFtma','CramiPackageEntity','4659765BXpAIb','OrderService','../crami/cramiPackage.entity','metadata','2CJQtph','goodsInfo','channel','../../common/utils','queryByOrderId','log','length','defineProperty','save','订单不存在!','select','delete','../pay/pay.service','HttpStatus','orderEntity','design:paramtypes','createOrderId'];_0x545e=function(){return _0x567370;};return _0x545e();}let OrderService=class OrderService{constructor(_0xfdca76,_0x195ff1,_0x21350b,_0x357fe0,_0x1eb85f){const _0x40f3d8=_0xa02779;this[_0x40f3d8(0x12c)]=_0xfdca76,this[_0x40f3d8(0x112)]=_0x195ff1,this[_0x40f3d8(0x146)]=_0x21350b,this[_0x40f3d8(0x135)]=_0x357fe0,this['globalConfigService']=_0x1eb85f;}async[_0xa02779(0x109)](_0x5d7923,_0x670140){const _0x5d46f3=_0xa02779;try{const {goodsId:_0x58709a,count:count=0x1,payType:_0x10886e}=_0x5d7923,{id:_0x3242e6}=_0x670140[_0x5d46f3(0x10b)];if(_0x3242e6>0xf4240)throw new common_1[(_0x5d46f3(0xf7))]('请先注册账号后购买商品！',common_1['HttpStatus'][_0x5d46f3(0x141)]);const _0x4d9245=await this[_0x5d46f3(0xff)](_0x3242e6,_0x58709a,count,_0x10886e),_0x1d3948=await this[_0x5d46f3(0x135)][_0x5d46f3(0xf6)](_0x3242e6,_0x4d9245['orderId'],_0x10886e);return Object[_0x5d46f3(0x134)](Object[_0x5d46f3(0x134)]({},_0x1d3948),{'orderId':_0x4d9245[_0x5d46f3(0x110)],'platform':_0x4d9245['payPlatform'],'total':_0x4d9245[_0x5d46f3(0x10a)]});}catch(_0x39cd18){if(_0x39cd18['status']===0x191)throw new common_1[(_0x5d46f3(0xf7))](_0x39cd18[_0x5d46f3(0x13e)],common_1[_0x5d46f3(0x12b)]['UNAUTHORIZED']);throw new common_1[(_0x5d46f3(0xf7))](_0x39cd18[_0x5d46f3(0x13e)]||_0x5d46f3(0x13c),common_1['HttpStatus'][_0x5d46f3(0x137)]);}}async[_0xa02779(0x122)](_0x3289e5,_0x4687e5){const _0x222a52=_0xa02779,{id:_0x24b713}=_0x3289e5[_0x222a52(0x10b)],{orderId:_0x32bf3d}=_0x4687e5,_0x43e2bd=await this[_0x222a52(0x12c)][_0x222a52(0xfc)]({'where':{'userId':_0x24b713,'orderId':_0x32bf3d}});if(!_0x43e2bd)throw new common_1['HttpException']('订单不存在!',common_1[_0x222a52(0x12b)]['BAD_REQUEST']);return _0x43e2bd;}async[_0xa02779(0xff)](_0x5d6e41,_0x25f062,_0x13347a,_0x2e292a){const _0x2d7590=_0xa02779,_0x29e6d9=await this['globalConfigService'][_0x2d7590(0x116)](),_0x5bebf5=await this[_0x2d7590(0x112)][_0x2d7590(0xfc)]({'where':{'id':_0x25f062}});if(!_0x5bebf5)throw new common_1[(_0x2d7590(0xf7))](_0x2d7590(0x105),common_1[_0x2d7590(0x12b)][_0x2d7590(0x137)]);const _0x13fd28={};_0x13fd28['orderId']=(0x0,utils_1[_0x2d7590(0x12e)])(),_0x13fd28[_0x2d7590(0x139)]=_0x5d6e41,_0x13fd28[_0x2d7590(0x102)]=_0x25f062,_0x13fd28[_0x2d7590(0x13b)]=Number(_0x5bebf5[_0x2d7590(0x13b)]),_0x13fd28['count']=_0x13347a,_0x13fd28['total']=Number(_0x5bebf5['price'])*_0x13347a,_0x13fd28[_0x2d7590(0x147)]=_0x29e6d9,_0x13fd28[_0x2d7590(0x120)]=_0x2e292a;const _0x5b0b1a=await this['orderEntity'][_0x2d7590(0x126)](_0x13fd28);return console[_0x2d7590(0x123)](_0x2d7590(0x143),_0x5b0b1a),_0x5b0b1a;}async['query'](_0x2e4e56,_0xf3769e,_0xfc9a73){const _0x4081a2=_0xa02779;return await this[_0x4081a2(0x12c)][_0x4081a2(0x113)]({'where':{'userId':_0x2e4e56},'order':{'id':_0x4081a2(0x148)},'skip':(_0xf3769e-0x1)*_0xfc9a73,'take':_0xfc9a73});}async[_0xa02779(0x13f)](_0x12b734){const _0x5bb90e=_0xa02779,{page:_0x5dd141,size:_0xb562c5,userId:_0x1b25c7,platform:_0x4540e6,status:_0x340192}=_0x12b734,_0x2e4b41={};if(_0x1b25c7)_0x2e4b41[_0x5bb90e(0x139)]=_0x1b25c7;if(_0x4540e6)_0x2e4b41['payPlatform']=_0x4540e6;if(_0x340192)_0x2e4b41[_0x5bb90e(0xf8)]=_0x340192;const [_0x160e8b,_0x2afbe3]=await this[_0x5bb90e(0x12c)][_0x5bb90e(0x113)]({'order':{'id':_0x5bb90e(0x148)},'where':_0x2e4b41,'skip':(_0x5dd141-0x1)*_0xb562c5,'take':_0xb562c5}),_0x4bf110=_0x160e8b[_0x5bb90e(0x133)](_0x1c844f=>_0x1c844f[_0x5bb90e(0x139)]),_0x1a6358=_0x160e8b[_0x5bb90e(0x133)](_0x4ba904=>_0x4ba904[_0x5bb90e(0x102)]),_0x15af84=await this[_0x5bb90e(0x146)][_0x5bb90e(0xfb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4bf110)},'select':['id',_0x5bb90e(0x101),'email']}),_0x1ea6aa=await this[_0x5bb90e(0x112)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x1a6358)},'select':['id',_0x5bb90e(0x100),_0x5bb90e(0x136),_0x5bb90e(0x142)]});_0x160e8b[_0x5bb90e(0x14a)](_0x5053d6=>{const _0x42a4e9=_0x5bb90e;_0x5053d6[_0x42a4e9(0x138)]=_0x15af84[_0x42a4e9(0xfb)](_0xd50b47=>_0xd50b47['id']===_0x5053d6[_0x42a4e9(0x139)]),_0x5053d6[_0x42a4e9(0x11f)]=_0x1ea6aa['find'](_0x3216be=>_0x3216be['id']===_0x5053d6['goodsId']);});const _0x5b01d3=await this['orderEntity'][_0x5bb90e(0x10f)]('order')[_0x5bb90e(0x103)](_0x5bb90e(0x107),{'status':0x1})[_0x5bb90e(0x128)](_0x5bb90e(0x10e),_0x5bb90e(0x130))['getRawOne']();return Object[_0x5bb90e(0x134)]({'rows':_0x160e8b,'count':_0x2afbe3},_0x5b01d3);}async[_0xa02779(0x10c)](_0x52d019){const _0x31da53=_0xa02779,{orderId:_0x3824f3}=_0x52d019,_0x533d05=await this['orderEntity']['findOne']({'where':{'orderId':_0x3824f3}});if(!_0x533d05)throw new common_1[(_0x31da53(0xf7))](_0x31da53(0x127),common_1['HttpStatus'][_0x31da53(0x137)]);return await this[_0x31da53(0x12c)][_0x31da53(0x129)]({'orderId':_0x3824f3});}async[_0xa02779(0x108)](){const _0x1a0fa6=_0xa02779;return await this['orderEntity'][_0x1a0fa6(0x129)]({'status':0x0});}};OrderService=__decorate([(0x0,common_1[_0xa02779(0xfe)])(),__param(0x0,(0x0,typeorm_1[_0xa02779(0x145)])(order_entity_1['OrderEntity'])),__param(0x1,(0x0,typeorm_1[_0xa02779(0x145)])(cramiPackage_entity_1[_0xa02779(0x119)])),__param(0x2,(0x0,typeorm_1[_0xa02779(0x145)])(user_entity_1['UserEntity'])),__metadata(_0xa02779(0x12d),[typeorm_2['Repository'],typeorm_2[_0xa02779(0x13d)],typeorm_2[_0xa02779(0x13d)],pay_service_1[_0xa02779(0x114)],globalConfig_service_1['GlobalConfigService']])],OrderService),exports[_0xa02779(0x11b)]=OrderService;