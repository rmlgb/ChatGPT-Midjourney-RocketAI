'use strict';const _0x4b856d=_0x5b87;(function(_0x431528,_0x613f82){const _0x44b864=_0x5b87,_0x4c689e=_0x431528();while(!![]){try{const _0x38fbc7=parseInt(_0x44b864(0xb7))/0x1+parseInt(_0x44b864(0xd8))/0x2+parseInt(_0x44b864(0xd4))/0x3+parseInt(_0x44b864(0xbe))/0x4+-parseInt(_0x44b864(0xf4))/0x5+-parseInt(_0x44b864(0x107))/0x6+-parseInt(_0x44b864(0x104))/0x7;if(_0x38fbc7===_0x613f82)break;else _0x4c689e['push'](_0x4c689e['shift']());}catch(_0x17f407){_0x4c689e['push'](_0x4c689e['shift']());}}}(_0x5d34,0x463ed));function _0x5b87(_0x5ae9c5,_0x51eb04){const _0x5d34eb=_0x5d34();return _0x5b87=function(_0x5b87ca,_0x5e13e9){_0x5b87ca=_0x5b87ca-0xb0;let _0x572d23=_0x5d34eb[_0x5b87ca];return _0x572d23;},_0x5b87(_0x5ae9c5,_0x51eb04);}var __decorate=this&&this[_0x4b856d(0xdd)]||function(_0x5afb00,_0x4dfb69,_0x48160a,_0x32d298){const _0x3bf739=_0x4b856d;var _0x5e21f2=arguments[_0x3bf739(0xe0)],_0x2fd873=_0x5e21f2<0x3?_0x4dfb69:_0x32d298===null?_0x32d298=Object[_0x3bf739(0xfb)](_0x4dfb69,_0x48160a):_0x32d298,_0x308da9;if(typeof Reflect===_0x3bf739(0xc1)&&typeof Reflect[_0x3bf739(0xf2)]==='function')_0x2fd873=Reflect[_0x3bf739(0xf2)](_0x5afb00,_0x4dfb69,_0x48160a,_0x32d298);else{for(var _0x4db81a=_0x5afb00[_0x3bf739(0xe0)]-0x1;_0x4db81a>=0x0;_0x4db81a--)if(_0x308da9=_0x5afb00[_0x4db81a])_0x2fd873=(_0x5e21f2<0x3?_0x308da9(_0x2fd873):_0x5e21f2>0x3?_0x308da9(_0x4dfb69,_0x48160a,_0x2fd873):_0x308da9(_0x4dfb69,_0x48160a))||_0x2fd873;}return _0x5e21f2>0x3&&_0x2fd873&&Object['defineProperty'](_0x4dfb69,_0x48160a,_0x2fd873),_0x2fd873;},__metadata=this&&this[_0x4b856d(0xd1)]||function(_0xb20dc8,_0x4e98b7){const _0x336a6c=_0x4b856d;if(typeof Reflect===_0x336a6c(0xc1)&&typeof Reflect[_0x336a6c(0x10f)]===_0x336a6c(0xd5))return Reflect[_0x336a6c(0x10f)](_0xb20dc8,_0x4e98b7);},__param=this&&this[_0x4b856d(0xff)]||function(_0x2c68bc,_0x51e6ae){return function(_0x3c39fb,_0x1bd761){_0x51e6ae(_0x3c39fb,_0x1bd761,_0x2c68bc);};};Object[_0x4b856d(0xee)](exports,'__esModule',{'value':!![]}),exports['ModelsService']=void 0x0;function _0x5d34(){const _0x120f7a=['keyType','../../common/constants/status.constant','896334rUqwrs','function','keys','push','356380qPAGDJ','lockKey','getRandomDrawKey','Repository','initCalcKey','__decorate','./modelType.entity','HttpException','length','getCurrentModelKeyInfo','isArbitraryMultimodal','val','getBaseConfig','delete','setModel','log','getRandomItemFromArray','queryModelType','hideString','model','secret','modelsEntity','defineProperty','error:\x20','stringify','forEach','decorate','当前调用模型已经被移除、请重新选择模型！','1990xhliwQ','set','缺失必要参数！','keyList','key','多模态和任意多模态不能同时设置！','values','getOwnPropertyDescriptor','../model_category/category.service','modelCategoryService','findAndCount','__param','当前未指定特殊模型KEY、前往后台模型池设置吧！','modelTypes','ModelsService','delModelType','2793119SyJvqI','super','ModelCategoryService','2542260kMvUAa','from','save','getAccessToken','all','queryModels','keyPoolMap','find','metadata','isMultimodal','HttpStatus','reduce','ModelsTypeEntity','findOne','affected','error','id\x20=\x20:id','refreshBaiduAccesstoken','modelsTypeEntity','@nestjs/typeorm','Injectable','281505IHKIwE','useCount\x20+\x201','modelMaps','typeorm','keyPoolIndexMap','./models.entity','InjectRepository','1409508MEdsMG','delModel','getAllKey','object','update','map','key:\x20','parse','onModuleInit','ModelsEntity','user','BAD_REQUEST','status','createQueryBuilder','keyStatus','modelsList','../../common/utils','saveUseLog','findAll','__metadata'];_0x5d34=function(){return _0x120f7a;};return _0x5d34();}const common_1=require('@nestjs/common'),typeorm_1=require(_0x4b856d(0xb5)),typeorm_2=require(_0x4b856d(0xba)),models_entity_1=require(_0x4b856d(0xbc)),status_constant_1=require(_0x4b856d(0xd3)),baidu_1=require('../chatgpt/baidu'),utils_1=require(_0x4b856d(0xce)),modelType_entity_1=require(_0x4b856d(0xde)),category_service_1=require(_0x4b856d(0xfc));let ModelsService=class ModelsService{constructor(_0x1031fe,_0x5ce788,_0x1cdd0d){const _0xea50f5=_0x4b856d;this[_0xea50f5(0xed)]=_0x1031fe,this[_0xea50f5(0xb4)]=_0x5ce788,this['modelCategoryService']=_0x1cdd0d,this[_0xea50f5(0x101)]=[],this[_0xea50f5(0xb9)]={},this[_0xea50f5(0xf7)]={},this[_0xea50f5(0x10d)]={},this[_0xea50f5(0xbb)]={};}async[_0x4b856d(0xc6)](){await this['initCalcKey'](),this['refreshBaiduAccesstoken']();}async['initCalcKey'](){const _0x5b7bda=_0x4b856d;this['keyPoolMap']={},this[_0x5b7bda(0xbb)]={},this['keyList']={},this['modelMaps']={},this[_0x5b7bda(0x101)]=[];const _0x57631c=await this[_0x5b7bda(0xed)]['find']({'where':{'status':!![]}}),_0x4634b3=_0x57631c[_0x5b7bda(0x112)]((_0x4ebd55,_0x4f2903)=>{const _0x2a6aeb=_0x5b7bda;return!_0x4ebd55[_0x4f2903[_0x2a6aeb(0xd2)]]?_0x4ebd55[_0x4f2903['keyType']]=[_0x4f2903]:_0x4ebd55[_0x4f2903[_0x2a6aeb(0xd2)]][_0x2a6aeb(0xd7)](_0x4f2903),_0x4ebd55;},{});this[_0x5b7bda(0x101)]=Object[_0x5b7bda(0xd6)](_0x4634b3)[_0x5b7bda(0xc3)](_0x1f71a6=>{return{'label':status_constant_1['ModelsMapCn'][_0x1f71a6],'val':_0x1f71a6};}),this[_0x5b7bda(0xb9)]=_0x4634b3,this[_0x5b7bda(0xf7)]={},_0x57631c[_0x5b7bda(0xf1)](_0x413333=>{const _0x30d95b=_0x5b7bda,{keyType:_0x4a4f05,model:_0x5f208e,keyWeight:_0x537407}=_0x413333;if(!this[_0x30d95b(0x10d)][_0x5f208e])this['keyPoolMap'][_0x5f208e]=[];for(let _0x5031eb=0x0;_0x5031eb<_0x537407;_0x5031eb++){this[_0x30d95b(0x10d)][_0x5f208e][_0x30d95b(0xd7)](_0x413333);}if(!this[_0x30d95b(0xbb)][_0x5f208e])this[_0x30d95b(0xbb)][_0x5f208e]=0x0;if(!this['keyList'][_0x4a4f05])this[_0x30d95b(0xf7)][_0x4a4f05]={};if(!this['keyList'][_0x4a4f05][_0x5f208e])this[_0x30d95b(0xf7)][_0x4a4f05][_0x5f208e]=[];this[_0x30d95b(0xf7)][_0x4a4f05][_0x5f208e]['push'](_0x413333);});}async[_0x4b856d(0xd9)](_0x2e78b0,_0x12f228,_0x220899=-0x1){const _0x1f68e2=_0x4b856d,_0x182b4d=await this[_0x1f68e2(0xed)][_0x1f68e2(0xc2)]({'id':_0x2e78b0},{'status':![],'keyStatus':_0x220899,'remark':_0x12f228});common_1['Logger'][_0x1f68e2(0xb1)](_0x1f68e2(0xc4)+_0x2e78b0+'\x20欠费或被官方封禁导致不可用，已被系统自动锁定'),this['initCalcKey']();}async[_0x4b856d(0xe1)](_0x4fb50c){const _0x40be95=_0x4b856d;if(!this[_0x40be95(0x10d)][_0x4fb50c])throw new common_1['HttpException'](_0x40be95(0xf3),common_1[_0x40be95(0x111)]['BAD_REQUEST']);this[_0x40be95(0xbb)][_0x4fb50c]++;const _0x558750=this[_0x40be95(0xbb)][_0x4fb50c];if(_0x558750>=this[_0x40be95(0x10d)][_0x4fb50c]['length'])this[_0x40be95(0xbb)][_0x4fb50c]=0x0;const _0x5da758=this[_0x40be95(0x10d)][_0x4fb50c][this['keyPoolIndexMap'][_0x4fb50c]];return _0x5da758;}async[_0x4b856d(0xe4)](_0x47178a){const _0x17b437=_0x4b856d;if(!this[_0x17b437(0x101)][_0x17b437(0xe0)]||!Object[_0x17b437(0xd6)](this['modelMaps'])[_0x17b437(0xe0)])return;const _0x56972e=_0x47178a?this[_0x17b437(0x101)][_0x17b437(0x10e)](_0x2808c0=>Number(_0x2808c0[_0x17b437(0xe3)])===0x1):this['modelTypes'][0x0];if(!_0x56972e)return;const {keyType:_0x5af623,modelName:_0xc77e9f,model:_0x50dcd9,maxModelTokens:_0x3f5712,maxResponseTokens:_0xf109bc,deductType:_0x1e2eb5,deduct:_0x8174f,maxRounds:_0xe2affe}=this['modelMaps'][_0x56972e['val']][0x0];return{'modelTypeInfo':_0x56972e,'modelInfo':{'keyType':_0x5af623,'modelName':_0xc77e9f,'model':_0x50dcd9,'maxModelTokens':_0x3f5712,'maxResponseTokens':_0xf109bc,'topN':0.8,'systemMessage':'','deductType':_0x1e2eb5,'deduct':_0x8174f,'maxRounds':_0xe2affe,'rounds':0x8}};}async[_0x4b856d(0xe6)](_0x40f3cc){const _0x343e34=_0x4b856d;try{const {id:_0x4f931a}=_0x40f3cc;_0x40f3cc[_0x343e34(0xca)]&&(_0x40f3cc[_0x343e34(0xcc)]=0x1);if(_0x40f3cc[_0x343e34(0x110)]&&_0x40f3cc[_0x343e34(0xe2)])throw new common_1['HttpException'](_0x343e34(0xf9),common_1[_0x343e34(0x111)]['BAD_REQUEST']);if(_0x4f931a){const _0x4fdbe8=await this[_0x343e34(0xed)][_0x343e34(0xc2)]({'id':_0x4f931a},_0x40f3cc);return await this[_0x343e34(0xdc)](),_0x4fdbe8[_0x343e34(0xb0)]>0x0;}else{const {keyType:_0x4525dc,key:_0x422009}=_0x40f3cc;if(Number(_0x4525dc!==0x1)){const _0x31585e=await this[_0x343e34(0xed)][_0x343e34(0x109)](_0x40f3cc);return await this['initCalcKey'](),_0x4525dc===0x2&&this[_0x343e34(0xb3)](),_0x31585e;}else{const _0x196e29=_0x422009[_0x343e34(0xc3)](_0x49dee5=>{const _0x254b89=_0x343e34;try{const _0x297535=JSON[_0x254b89(0xc5)](JSON[_0x254b89(0xf0)](_0x40f3cc));return _0x297535[_0x254b89(0xf8)]=_0x49dee5,_0x297535;}catch(_0x4567c1){console['log']('parse\x20error:\x20',_0x4567c1);}}),_0x44407a=await this[_0x343e34(0xed)][_0x343e34(0x109)](_0x196e29);return await this['initCalcKey'](),_0x44407a;}}}catch(_0x321764){console[_0x343e34(0xe7)](_0x343e34(0xef),_0x321764);}}async[_0x4b856d(0xbf)]({id:_0x5bd321}){const _0x248e80=_0x4b856d;if(!_0x5bd321)throw new common_1[(_0x248e80(0xdf))](_0x248e80(0xf6),common_1[_0x248e80(0x111)][_0x248e80(0xc9)]);const _0x5992cf=await this[_0x248e80(0xed)][_0x248e80(0x114)]({'where':{'id':_0x5bd321}});if(!_0x5992cf)throw new common_1[(_0x248e80(0xdf))]('当前账号不存在！',common_1[_0x248e80(0x111)][_0x248e80(0xc9)]);const _0x133c75=await this[_0x248e80(0xed)][_0x248e80(0xe5)]({'id':_0x5bd321});return await this[_0x248e80(0xdc)](),_0x133c75;}async[_0x4b856d(0x10c)](_0x290519,_0x363483){const _0x3d75a8=_0x4b856d,{role:_0x3301e1}=_0x290519[_0x3d75a8(0xc8)],{keyType:_0x29fbd2,key:_0x5780e2,status:_0x152c3c,model:_0x292e01,page:page=0x1,size:size=0xa}=_0x363483,_0x52845e={};_0x29fbd2&&(_0x52845e[_0x3d75a8(0xd2)]=_0x29fbd2),_0x292e01&&(_0x52845e[_0x3d75a8(0xeb)]=_0x292e01),_0x152c3c&&(_0x52845e['status']=Number(_0x152c3c)===0x1?!![]:![]),_0x5780e2&&(_0x52845e[_0x3d75a8(0xf8)]=(0x0,typeorm_2['Like'])('%'+_0x5780e2+'%'));const [_0x3a211a,_0x5afd5b]=await this[_0x3d75a8(0xed)][_0x3d75a8(0xfe)]({'where':_0x52845e,'skip':(page-0x1)*size,'take':size});return _0x3301e1!==_0x3d75a8(0x105)&&_0x3a211a[_0x3d75a8(0xf1)](_0x27ed4a=>{const _0x2820e9=_0x3d75a8;_0x27ed4a[_0x2820e9(0xf8)]&&(_0x27ed4a[_0x2820e9(0xf8)]=(0x0,utils_1[_0x2820e9(0xea)])(_0x27ed4a[_0x2820e9(0xf8)])),_0x27ed4a['secret']&&(_0x27ed4a[_0x2820e9(0xec)]=(0x0,utils_1[_0x2820e9(0xea)])(_0x27ed4a[_0x2820e9(0xec)]));}),{'rows':_0x3a211a,'count':_0x5afd5b};}async[_0x4b856d(0xcd)](){const _0x213803=_0x4b856d,_0x27d8bc=JSON[_0x213803(0xc5)](JSON[_0x213803(0xf0)](this[_0x213803(0xb9)]));Object[_0x213803(0xd6)](_0x27d8bc)[_0x213803(0xf1)](async _0x6f73d6=>{const _0x45f5d2=_0x213803,_0x2eabaa=_0x27d8bc[_0x6f73d6][_0x45f5d2(0xc3)](async _0x303e3d=>{const {modelName:_0x14e3eb,model:_0x5dcebf,deduct:_0x2cfade,deductType:_0x21fc7d,maxRounds:_0x2c5981,isMultimodal:_0x480a0b,category_id:_0x59e92c,icon:_0x1e4452,maxModelTokens:_0x5c1f22,maxResponseTokens:_0x918f04,isArbitraryMultimodal:_0x149b68}=_0x303e3d;return{'modelName':_0x14e3eb,'model':_0x5dcebf,'deduct':_0x2cfade,'deductType':_0x21fc7d,'maxRounds':_0x2c5981,'isMultimodal':_0x480a0b,'category_id':_0x59e92c,'icon':_0x1e4452,'maxModelTokens':_0x5c1f22,'maxResponseTokens':_0x918f04,'isArbitraryMultimodal':_0x149b68};}),_0x3fcf47=await Promise[_0x45f5d2(0x10b)](_0x2eabaa);_0x27d8bc[_0x6f73d6]=Array[_0x45f5d2(0x108)](_0x3fcf47[_0x45f5d2(0x112)]((_0x413353,_0x293d13)=>_0x413353[_0x45f5d2(0xf5)](_0x293d13['modelName'],_0x293d13),new Map())[_0x45f5d2(0xfa)]());});const _0x2971f3=await this[_0x213803(0xfd)][_0x213803(0xd0)]();return{'modelTypeList':this[_0x213803(0x101)],'modelMaps':_0x27d8bc,'modelCategory':_0x2971f3};}async[_0x4b856d(0xcf)](_0x189c63,_0x3b27bc){const _0x1316ce=_0x4b856d;await this['modelsEntity'][_0x1316ce(0xcb)]()['update'](models_entity_1[_0x1316ce(0xc7)])[_0x1316ce(0xf5)]({'useCount':()=>_0x1316ce(0xb8),'useToken':()=>'useToken\x20+\x20'+_0x3b27bc})['where'](_0x1316ce(0xb2),{'id':_0x189c63})['execute']();}async['refreshBaiduAccesstoken'](){const _0x4749c1=_0x4b856d,_0x51cf83=await this['modelsEntity']['find']({'where':{'keyType':0x2}}),_0x53b5cf={};_0x51cf83['forEach'](_0xebc2e3=>{const _0x5e91c0=_0x5b87,{key:_0x584434,secret:_0x1436eb}=_0xebc2e3;!_0x53b5cf[_0x5e91c0(0xf8)]?_0x53b5cf[_0x584434]=[{'keyInfo':_0xebc2e3}]:_0x53b5cf[_0x584434]['push'](_0xebc2e3);}),Object[_0x4749c1(0xd6)](_0x53b5cf)[_0x4749c1(0xf1)](async _0x2d6423=>{const _0x2f6fcb=_0x4749c1,{secret:_0x46dd59,id:_0x1c84ca}=_0x53b5cf[_0x2d6423][0x0]['keyInfo'],_0x3b345e=await(0x0,baidu_1[_0x2f6fcb(0x10a)])(_0x2d6423,_0x46dd59);await this[_0x2f6fcb(0xed)][_0x2f6fcb(0xc2)]({'key':_0x2d6423},{'accessToken':_0x3b345e});}),setTimeout(()=>{const _0xb4d95c=_0x4749c1;this[_0xb4d95c(0xdc)]();},0x3e8);}async[_0x4b856d(0xda)](){const _0x346d72=_0x4b856d,_0x21f63d=await this[_0x346d72(0xed)]['find']({'where':{'isDraw':!![],'status':!![]}});if(!_0x21f63d[_0x346d72(0xe0)])throw new common_1[(_0x346d72(0xdf))](_0x346d72(0x100),common_1['HttpStatus'][_0x346d72(0xc9)]);return(0x0,utils_1[_0x346d72(0xe8)])(_0x21f63d);}async[_0x4b856d(0xc0)](){const _0x599e6e=_0x4b856d;return await this['modelsEntity'][_0x599e6e(0x10e)]();}async[_0x4b856d(0xe9)](_0x5b4611){}async['setModelType'](_0x4f7c02){}async[_0x4b856d(0x103)](_0x15d6fd){}};ModelsService=__decorate([(0x0,common_1[_0x4b856d(0xb6)])(),__param(0x0,(0x0,typeorm_1[_0x4b856d(0xbd)])(models_entity_1[_0x4b856d(0xc7)])),__param(0x1,(0x0,typeorm_1[_0x4b856d(0xbd)])(modelType_entity_1[_0x4b856d(0x113)])),__metadata('design:paramtypes',[typeorm_2[_0x4b856d(0xdb)],typeorm_2['Repository'],category_service_1[_0x4b856d(0x106)]])],ModelsService),exports[_0x4b856d(0x102)]=ModelsService;