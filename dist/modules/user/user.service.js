'use strict';function _0x4d26(_0xbd724c,_0xb1dead){const _0x1c6fd0=_0x1c6f();return _0x4d26=function(_0x4d26a6,_0x316a2f){_0x4d26a6=_0x4d26a6-0x75;let _0x5a06f7=_0x1c6fd0[_0x4d26a6];return _0x5a06f7;},_0x4d26(_0xbd724c,_0xb1dead);}const _0x3a76c8=_0x4d26;(function(_0x9ae318,_0x5c636a){const _0x32f731=_0x4d26,_0x3394ff=_0x9ae318();while(!![]){try{const _0x190a9c=-parseInt(_0x32f731(0xba))/0x1+parseInt(_0x32f731(0x10b))/0x2+parseInt(_0x32f731(0x8e))/0x3*(parseInt(_0x32f731(0xb9))/0x4)+parseInt(_0x32f731(0x9f))/0x5+parseInt(_0x32f731(0x76))/0x6*(-parseInt(_0x32f731(0xf9))/0x7)+parseInt(_0x32f731(0xd7))/0x8*(-parseInt(_0x32f731(0xad))/0x9)+parseInt(_0x32f731(0xee))/0xa;if(_0x190a9c===_0x5c636a)break;else _0x3394ff['push'](_0x3394ff['shift']());}catch(_0x51f6dc){_0x3394ff['push'](_0x3394ff['shift']());}}}(_0x1c6f,0xf0157));function _0x1c6f(){const _0x259d8f=['isBindWx','reduce','ADMIN_GIFT','maskIpAddress','342538vqgtqm','updateStatus','生成邀请码失败，请重新试一次吧！','没有变更，无需更改！','userEntity','error:\x20','registerBaseUrl','修改用户状态失败！','重置密码失败！','split','修改用户状态成功！','avatar','lodash','UserStatusErrMsg','registerVerifyEmailDesc','password','VerificationService','configEntity','307896nABYWc','../chatgpt/whiteList.entity','已生成过邀请码、请勿重复生成','绑定微信失败、请联系管理员！','verificationService','sendMail','createUserFromOpenId','save','超级管理员不可被操作！','sign','username','./user.entity','queryOne','generateRandomString','用户名已存在！','InjectRepository','createUser','updateInfo','当前绑定用户不存在！','18HFwUBG','getUserInfo','userDefautlAvatar','Like','lastLoginIp','affected','userBalanceService','123456','connection','无效的邀请码！','verifyUserRegisterByPhone','queryUserBalanceByIds','isVerifyEmail','updateUserStatus','status','BAD_REQUEST','compareSync','当前账户不存在！','registerVerifyExpir','getUserFromOpenId','修改密码失败、请重新试试吧。','当前手机号已注册、请勿重复注册！','PENDING','DESC','51niabtx','getUserById','HttpStatus','configKey','getUserStatus','typeorm','mailerService','maskEmail','genInviteCode','ACTIVE','resetUserPass','../globalConfig/config.entity','的账号激活','balanceInfo','当前密码错误！','registerVerifyEmailTitle','forEach','4255605BmYrGr','log','您的账户已被封禁、如有疑问、请联系管理员！','visitor','queryUserInfoById','consecutiveDays','registerIp','修改用户信息成功！','assign','createdAt','./../../common/constants/user.constant','getOwnPropertyDescriptor','userId','HttpException','72CGvopG','qureyUserInfoByInviteCode','UserBalanceService','createRandomUid','__param','@nestjs-modules/mailer','当前用户不存在！','globalConfigService','object','恭喜您绑定成功、后续可直接扫码登录了！','WhiteListEntity','GlobalConfigService','287948eWdfOH','53494wdHoVw','inviteCode','用户不存在！','savaLoginIp','./../globalConfig/globalConfig.service','userRecharge','bindWx','createUserAndVerifycation','不可将用户置为未激活状态！','defineProperty','metadata','saveRecordRechargeLog','map','getOpenIdByUserId','该微信已绑定其他账号！','checkUserStatus','design:paramtypes','hashSync','未激活用户不可手动变更状态！','findAndCount','getInviteRecord','MailerService','当前用户信息失效、请重新登录！','Repository','UNAUTHORIZED','user','UserService','ConfigEntity','@nestjs/common','1339232dGvOpp','Connection','formatCreateOrUpdateDate','length','获取邀请记录失败！','update','__esModule','getConfigs','getSuper','function','updateUserPassword','find','../../common/constants/verification.constant','super','VerificationEnum','phone','registerVerifyEmailFrom','./../verification/verification.service','addBalanceToNewUser','findOne','Injectable','role','UserStatusEnum','2940630OiEAkH','../../common/utils','__decorate','getUserOpenId','email','openId','decorate'];_0x1c6f=function(){return _0x259d8f;};return _0x1c6f();}var __decorate=this&&this[_0x3a76c8(0xf0)]||function(_0x2c83c0,_0x1be2d0,_0x28fc85,_0x385aa7){const _0x5aa938=_0x3a76c8;var _0x1df4ec=arguments[_0x5aa938(0xda)],_0x57ed92=_0x1df4ec<0x3?_0x1be2d0:_0x385aa7===null?_0x385aa7=Object[_0x5aa938(0xaa)](_0x1be2d0,_0x28fc85):_0x385aa7,_0x9c4a20;if(typeof Reflect===_0x5aa938(0xb5)&&typeof Reflect[_0x5aa938(0xf4)]===_0x5aa938(0xe0))_0x57ed92=Reflect['decorate'](_0x2c83c0,_0x1be2d0,_0x28fc85,_0x385aa7);else{for(var _0x501291=_0x2c83c0[_0x5aa938(0xda)]-0x1;_0x501291>=0x0;_0x501291--)if(_0x9c4a20=_0x2c83c0[_0x501291])_0x57ed92=(_0x1df4ec<0x3?_0x9c4a20(_0x57ed92):_0x1df4ec>0x3?_0x9c4a20(_0x1be2d0,_0x28fc85,_0x57ed92):_0x9c4a20(_0x1be2d0,_0x28fc85))||_0x57ed92;}return _0x1df4ec>0x3&&_0x57ed92&&Object[_0x5aa938(0xc3)](_0x1be2d0,_0x28fc85,_0x57ed92),_0x57ed92;},__metadata=this&&this['__metadata']||function(_0x56fe7c,_0x343f6f){const _0x664fa=_0x3a76c8;if(typeof Reflect===_0x664fa(0xb5)&&typeof Reflect['metadata']===_0x664fa(0xe0))return Reflect[_0x664fa(0xc4)](_0x56fe7c,_0x343f6f);},__param=this&&this[_0x3a76c8(0xb1)]||function(_0x44fa48,_0x57c745){return function(_0x40d4f0,_0x386ddd){_0x57c745(_0x40d4f0,_0x386ddd,_0x44fa48);};};Object[_0x3a76c8(0xc3)](exports,_0x3a76c8(0xdd),{'value':!![]}),exports[_0x3a76c8(0xd4)]=void 0x0;const globalConfig_service_1=require(_0x3a76c8(0xbe)),user_constant_1=require(_0x3a76c8(0xa9)),mailer_1=require(_0x3a76c8(0xb2)),verification_service_1=require(_0x3a76c8(0xe8)),common_1=require(_0x3a76c8(0xd6)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x3a76c8(0x93)),user_entity_1=require(_0x3a76c8(0x116)),bcrypt=require('bcryptjs'),_=require(_0x3a76c8(0x105)),verification_constant_1=require(_0x3a76c8(0xe3)),userBalance_service_1=require('../userBalance/userBalance.service'),utils_1=require(_0x3a76c8(0xef)),balance_constant_1=require('../../common/constants/balance.constant'),config_entity_1=require(_0x3a76c8(0x99)),whiteList_entity_1=require(_0x3a76c8(0x10c));let UserService=class UserService{constructor(_0x1aca9a,_0x528a4f,_0x1525f3,_0x58abbf,_0x3d85ca,_0x43d01b,_0x1dec2e,_0x2634df){const _0x1117d4=_0x3a76c8;this[_0x1117d4(0xfd)]=_0x1aca9a,this['whiteListEntity']=_0x528a4f,this[_0x1117d4(0x7e)]=_0x1525f3,this[_0x1117d4(0x10f)]=_0x58abbf,this[_0x1117d4(0x94)]=_0x3d85ca,this['userBalanceService']=_0x43d01b,this[_0x1117d4(0xb4)]=_0x1dec2e,this[_0x1117d4(0x10a)]=_0x2634df;}async[_0x3a76c8(0xc1)](_0x18e3a6,_0x4b1e63){const _0x5b60c7=_0x3a76c8,{username:_0x224a55,email:_0x40f414,password:_0x753e21,invitedBy:_0xe9b09b,client:client=0x0}=_0x18e3a6;if(_0xe9b09b){const _0x36bdd1=await this[_0x5b60c7(0xfd)][_0x5b60c7(0xea)]({'where':{'inviteCode':_0xe9b09b}});if(!_0x36bdd1)throw new common_1['HttpException'](_0x5b60c7(0x7f),common_1[_0x5b60c7(0x90)][_0x5b60c7(0x85)]);}const _0x59cf81=[{'username':_0x224a55},{'email':_0x40f414}],_0x5b2966=await this['userEntity']['findOne']({'where':_0x59cf81});if(_0x5b2966&&_0x5b2966[_0x5b60c7(0x84)]!==user_constant_1[_0x5b60c7(0xed)][_0x5b60c7(0x8c)])throw new common_1[(_0x5b60c7(0xac))]('用户名或者邮箱已被注册！',common_1[_0x5b60c7(0x90)][_0x5b60c7(0x85)]);try{const _0xe0cd5b=_['cloneDeep'](_0x18e3a6),_0xb5d377=bcrypt[_0x5b60c7(0xcb)](_0x753e21,0xa),_0x486bc2=(0x0,utils_1['getClientIp'])(_0x4b1e63);_0xe0cd5b[_0x5b60c7(0x108)]=_0xb5d377,_0xe0cd5b[_0x5b60c7(0xa5)]=_0x486bc2,_0xe0cd5b['client']=client;let _0x54f695;if(!_0x5b2966){const _0x1d3b6f=await this[_0x5b60c7(0xb4)][_0x5b60c7(0xde)]([_0x5b60c7(0x78)]);_0xe0cd5b[_0x5b60c7(0x104)]=_0x1d3b6f,_0x54f695=await this[_0x5b60c7(0xfd)][_0x5b60c7(0x112)](_0xe0cd5b);}else _0x54f695=_0x5b2966;const _0x4bcc02=await this[_0x5b60c7(0x10a)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])(['isVerifyEmail',_0x5b60c7(0xff),_0x5b60c7(0x9d),_0x5b60c7(0x107),_0x5b60c7(0xe7),_0x5b60c7(0x88)])}}),_0x48a526=_0x4bcc02[_0x5b60c7(0xf6)]((_0x3ae17b,_0x38d6bd)=>{const _0x5b60b5=_0x5b60c7;return _0x3ae17b[_0x38d6bd[_0x5b60b5(0x91)]]=_0x38d6bd['configVal'],_0x3ae17b;},{}),_0x17d0b1=_0x48a526[_0x5b60c7(0x82)]?Number(_0x48a526[_0x5b60c7(0x82)]):0x1;if(_0x17d0b1){const _0x5131e0=_0x48a526[_0x5b60c7(0x88)]?Number(_0x48a526[_0x5b60c7(0x88)]):0x1e*0x3c,_0x332b46=await this[_0x5b60c7(0x10f)]['createVerification'](_0x54f695,verification_constant_1[_0x5b60c7(0xe5)]['Registration'],_0x5131e0),{code:_0x144197,email:_0x58c82f,id:_0x164449}=_0x332b46,{registerVerifyEmailFrom:_0x15b380}=_0x48a526;console[_0x5b60c7(0xa0)]('configMap:\x20',_0x48a526);const _0x983693=await this['mailerService'][_0x5b60c7(0x110)]({'to':_0x58c82f,'subject':'来自'+_0x15b380+_0x5b60c7(0x9a),'template':'register','context':Object['assign']({'baseUrl':_0x48a526['registerBaseUrl'],'code':_0x144197,'id':_0x164449},_0x48a526)});console[_0x5b60c7(0xa0)]('email\x20response\x20\x20->\x20:\x20',_0x983693);}else{const {username:_0x1e79b4,email:_0x150415,id:_0x141a4a,invitedBy:_0x1439b6}=_0x54f695;await this['updateUserStatus'](_0x141a4a,user_constant_1['UserStatusEnum'][_0x5b60c7(0x97)]);let _0x407b23;_0x1439b6&&(_0x407b23=await this[_0x5b60c7(0xae)](_0x1439b6)),await this[_0x5b60c7(0x7c)][_0x5b60c7(0xe9)](_0x141a4a,_0x407b23===null||_0x407b23===void 0x0?void 0x0:_0x407b23['id']);}return _0x54f695;}catch(_0x56bcbc){console['log'](_0x5b60c7(0xfe),_0x56bcbc);throw _0x56bcbc;}}async[_0x3a76c8(0xdf)](){const _0x1baaed=_0x3a76c8,_0x451f2b=await this[_0x1baaed(0xfd)]['findOne']({'where':{'role':_0x1baaed(0xe4)}});return _0x451f2b;}async['verifyUserCredentials'](_0x547e04){const _0x402afc=_0x3a76c8,{username:_0x157fa1,password:_0x7125aa,uid:uid=0x0,phone:_0x10533f}=_0x547e04;let _0x603627=null;if(uid>0x0){_0x603627=await this['userEntity']['findOne']({'where':{'id':uid}});if(!_0x603627)throw new common_1[(_0x402afc(0xac))](_0x402afc(0x87),common_1[_0x402afc(0x90)][_0x402afc(0x85)]);if(!bcrypt[_0x402afc(0x86)](_0x7125aa,_0x603627['password']))throw new common_1[(_0x402afc(0xac))](_0x402afc(0x9c),common_1[_0x402afc(0x90)][_0x402afc(0x85)]);}if(_0x157fa1&&_0x7125aa){const _0x4597ee=[{'username':_0x157fa1},{'email':_0x157fa1}];_0x603627=await this[_0x402afc(0xfd)]['findOne']({'where':_0x4597ee});if(!_0x603627)throw new common_1[(_0x402afc(0xac))]('当前账户不存在！',common_1[_0x402afc(0x90)][_0x402afc(0x85)]);if(!bcrypt[_0x402afc(0x86)](_0x7125aa,_0x603627[_0x402afc(0x108)]))throw new common_1[(_0x402afc(0xac))]('当前密码错误！',common_1[_0x402afc(0x90)][_0x402afc(0x85)]);}if(_0x10533f&&_0x7125aa){const _0x184b19=[{'phone':_0x10533f}];_0x603627=await this[_0x402afc(0xfd)]['findOne']({'where':_0x184b19});if(!_0x603627)throw new common_1[(_0x402afc(0xac))]('当前账户不存在！',common_1[_0x402afc(0x90)][_0x402afc(0x85)]);if(!bcrypt[_0x402afc(0x86)](_0x7125aa,_0x603627[_0x402afc(0x108)]))throw new common_1[(_0x402afc(0xac))](_0x402afc(0x9c),common_1[_0x402afc(0x90)][_0x402afc(0x85)]);}if(!_0x603627)throw new common_1[(_0x402afc(0xac))](_0x402afc(0x87),common_1[_0x402afc(0x90)][_0x402afc(0x85)]);if(_0x603627[_0x402afc(0x84)]!==user_constant_1['UserStatusEnum']['ACTIVE'])throw new common_1['HttpException'](user_constant_1[_0x402afc(0x106)][_0x603627[_0x402afc(0x84)]],common_1[_0x402afc(0x90)]['BAD_REQUEST']);return _0x603627;}async['verifyUserPassword'](_0x1ab1be,_0x4b1062){const _0x39f398=_0x3a76c8,_0x12952f=await this[_0x39f398(0xfd)][_0x39f398(0xea)]({'where':{'id':_0x1ab1be}});return bcrypt['compareSync'](_0x4b1062,_0x12952f[_0x39f398(0x108)]);}async[_0x3a76c8(0x83)](_0x194185,_0xe5cf4c){const _0x28070f=_0x3a76c8,_0x50ed8f=await this['userEntity'][_0x28070f(0xdc)]({'id':_0x194185},{'status':_0xe5cf4c});return _0x50ed8f[_0x28070f(0x7b)]>0x0;}async[_0x3a76c8(0x92)](_0x2ef5df){const _0x1b111d=_0x3a76c8,_0x5e3ee2=await this[_0x1b111d(0xfd)][_0x1b111d(0xea)]({'where':{'id':_0x2ef5df}});return _0x5e3ee2[_0x1b111d(0x84)];}async[_0x3a76c8(0xa3)](_0x414118){const _0x3272eb=_0x3a76c8;return await this[_0x3272eb(0xfd)][_0x3272eb(0xea)]({'where':{'id':_0x414118}});}async['queryOneUserInfo'](_0x26b68){return await this['userEntity']['findOne']({'where':{'id':_0x26b68}});}async[_0x3a76c8(0xc9)](_0x45c8e2){const _0x54e738=_0x3a76c8,{id:_0x41f510,role:_0x246ef6}=_0x45c8e2;if(_0x246ef6===_0x54e738(0xa2))return!![];const _0x22a5de=await this['userEntity']['findOne']({'where':{'id':_0x41f510}});if(!_0x22a5de)throw new common_1[(_0x54e738(0xac))](_0x54e738(0xd0),common_1[_0x54e738(0x90)]['UNAUTHORIZED']);if(_0x22a5de[_0x54e738(0x84)]===user_constant_1['UserStatusEnum']['BLACKLISTED'])throw new common_1[(_0x54e738(0xac))]('您的账户已被永久加入黑名单、如有疑问、请联系管理员！',common_1[_0x54e738(0x90)]['BAD_REQUEST']);if(_0x22a5de[_0x54e738(0x84)]===user_constant_1[_0x54e738(0xed)]['LOCKED'])throw new common_1['HttpException'](_0x54e738(0xa1),common_1[_0x54e738(0x90)][_0x54e738(0x85)]);}async[_0x3a76c8(0x77)](_0x5696f4){const _0x298d3f=_0x3a76c8,_0x4b2466=await this['userEntity']['findOne']({'where':{'id':_0x5696f4},'select':[_0x298d3f(0x115),_0x298d3f(0x104),'role',_0x298d3f(0xf2),_0x298d3f(0x114),_0x298d3f(0xbb),_0x298d3f(0xf3),_0x298d3f(0xa4)]});if(!_0x4b2466)throw new common_1[(_0x298d3f(0xac))](_0x298d3f(0xd0),common_1[_0x298d3f(0x90)][_0x298d3f(0xd2)]);_0x4b2466[_0x298d3f(0xf5)]=!!(_0x4b2466===null||_0x4b2466===void 0x0?void 0x0:_0x4b2466[_0x298d3f(0xf3)]),delete _0x4b2466[_0x298d3f(0xf3)];const _0x26084a=await this[_0x298d3f(0x7c)]['queryUserBalance'](_0x5696f4);return{'userInfo':_0x4b2466,'userBalance':Object[_0x298d3f(0xa7)]({},_0x26084a)};}async[_0x3a76c8(0x8f)](_0x14e146){const _0x3a911e=_0x3a76c8;return await this[_0x3a911e(0xfd)][_0x3a911e(0xea)]({'where':{'id':_0x14e146}});}async[_0x3a76c8(0xf1)](_0x1f773c){const _0x25d4de=_0x3a76c8;return await this[_0x25d4de(0xfd)][_0x25d4de(0xea)]({'where':{'openId':_0x1f773c}});}async[_0x3a76c8(0x11c)](_0x35c74f,_0x6fe145){const _0x1c5349=_0x3a76c8,{id:_0xe2dd2c}=_0x6fe145[_0x1c5349(0xd3)],_0x17bb59=await this[_0x1c5349(0xfd)][_0x1c5349(0xea)]({'where':{'id':_0xe2dd2c}});if(!_0x17bb59)throw new common_1[(_0x1c5349(0xac))](_0x1c5349(0xb3),common_1[_0x1c5349(0x90)]['BAD_REQUEST']);if(_0x35c74f[_0x1c5349(0x115)]&&_0x17bb59['username']===_0x35c74f[_0x1c5349(0x115)])throw new common_1['HttpException'](_0x1c5349(0xfc),common_1[_0x1c5349(0x90)][_0x1c5349(0x85)]);if(_0x35c74f['username']){const _0x208e17=await this[_0x1c5349(0xfd)][_0x1c5349(0xea)]({'where':{'username':_0x35c74f[_0x1c5349(0x115)],'id':(0x0,typeorm_2['Not'])(_0xe2dd2c)}});if(_0x208e17)throw new common_1['HttpException'](_0x1c5349(0x119),common_1['HttpStatus'][_0x1c5349(0x85)]);}const _0x1837da=await this['userEntity'][_0x1c5349(0xdc)]({'id':_0xe2dd2c},_0x35c74f);if(_0x1837da[_0x1c5349(0x7b)]<=0x0)throw new common_1[(_0x1c5349(0xac))]('修改用户信息失败！',common_1[_0x1c5349(0x90)][_0x1c5349(0x85)]);return _0x1c5349(0xa6);}async[_0x3a76c8(0xe1)](_0x5bec46,_0x3110e6){const _0x3bc5cd=_0x3a76c8,_0x4b59ca=bcrypt[_0x3bc5cd(0xcb)](_0x3110e6,0xa),_0x35d1e1=await this[_0x3bc5cd(0xfd)][_0x3bc5cd(0xdc)]({'id':_0x5bec46},{'password':_0x4b59ca});if(_0x35d1e1[_0x3bc5cd(0x7b)]<=0x0)throw new common_1[(_0x3bc5cd(0xac))](_0x3bc5cd(0x8a),common_1[_0x3bc5cd(0x90)][_0x3bc5cd(0x85)]);}async[_0x3a76c8(0x96)](_0x1412b7){const _0x279165=_0x3a76c8,{id:_0x3c74b9}=_0x1412b7[_0x279165(0xd3)],_0x22276c=await this[_0x279165(0xfd)][_0x279165(0xea)]({'where':{'id':_0x3c74b9}});if(!_0x22276c||_0x22276c[_0x279165(0xbb)])throw new common_1[(_0x279165(0xac))](_0x279165(0x10d),common_1[_0x279165(0x90)]['BAD_REQUEST']);const _0x45c836=(0x0,utils_1[_0x279165(0x118)])(),_0x4107bd=await this[_0x279165(0xfd)]['findOne']({'where':{'inviteCode':_0x45c836}});if(_0x4107bd)throw new common_1[(_0x279165(0xac))](_0x279165(0xfb),common_1[_0x279165(0x90)][_0x279165(0x85)]);const _0x5b6731=await this[_0x279165(0xfd)]['update']({'id':_0x3c74b9},{'inviteCode':_0x45c836});if(_0x5b6731[_0x279165(0x7b)]<=0x0)throw new common_1[(_0x279165(0xac))](_0x279165(0xfb),common_1[_0x279165(0x90)]['BAD_REQUEST']);return _0x45c836;}async[_0x3a76c8(0xce)](_0x337186,_0x2aa4ad){const _0x502038=_0x3a76c8;try{const {id:_0x1face1}=_0x337186[_0x502038(0xd3)],{page:page=0x1,size:size=0xa}=_0x2aa4ad,_0x3c8402=await this[_0x502038(0xfd)][_0x502038(0xea)]({'where':{'id':_0x1face1}}),{inviteCode:_0x9ad854}=_0x3c8402;if(!_0x9ad854)return[];const [_0x552a1e,_0x2c0da3]=await this['userEntity']['findAndCount']({'where':{'inviteCode':_0x9ad854},'order':{'id':'DESC'},'select':['username',_0x502038(0xf2),_0x502038(0xa8),_0x502038(0x84),'avatar'],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x502038(0xd9)])(_0x552a1e)[_0x502038(0xc6)](_0x52be31=>{const _0x8e1909=_0x502038;return _0x52be31[_0x8e1909(0xf2)]=(0x0,utils_1['maskEmail'])(_0x52be31['email']),_0x52be31;}),{'rows':_0x552a1e,'count':_0x2c0da3};}catch(_0x76729c){console['log']('error:\x20',_0x76729c);throw new common_1[(_0x502038(0xac))](_0x502038(0xdb),common_1['HttpStatus'][_0x502038(0x85)]);}}async['inviteLink'](_0x259289){const _0x9af0e5=_0x3a76c8,_0x1eeeb5=await this[_0x9af0e5(0xfd)][_0x9af0e5(0xea)]({'where':{'inviteCode':_0x259289}});if(!_0x1eeeb5)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x1eeeb5,_0x5768aa=await this[_0x9af0e5(0xfd)][_0x9af0e5(0xdc)]({'inviteCode':_0x259289},{'inviteLinkCount':inviteLinkCount+0x1});return _0x5768aa['affected']?0x1:0x0;}async[_0x3a76c8(0xae)](_0x30ae58){const _0x40fe4e=_0x3a76c8;return await this['userEntity'][_0x40fe4e(0xea)]({'where':{'inviteCode':_0x30ae58}});}async[_0x3a76c8(0xbf)](_0x57af67){const _0x17bb4a=_0x3a76c8,{userId:_0x35f770,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x57af67;await this[_0x17bb4a(0x7c)]['addBalanceToUser'](_0x35f770,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x4c2ac9=await this[_0x17bb4a(0x7c)][_0x17bb4a(0xc5)]({'userId':_0x35f770,'rechargeType':balance_constant_1['RechargeType'][_0x17bb4a(0xf7)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x4c2ac9;}async['queryAll'](_0x13021f,_0x3abcbe){const _0x198c04=_0x3a76c8,{page:page=0x1,size:size=0xa,username:_0x39b8d2,email:_0x1737d1,status:_0x464cfc,keyword:_0x37316f,phone:_0x5ae9dd}=_0x13021f;let _0xe0e1e0={};_0x39b8d2&&Object[_0x198c04(0xa7)](_0xe0e1e0,{'username':(0x0,typeorm_2['Like'])('%'+_0x39b8d2+'%')}),_0x1737d1&&Object['assign'](_0xe0e1e0,{'email':(0x0,typeorm_2[_0x198c04(0x79)])('%'+_0x1737d1+'%')}),_0x5ae9dd&&Object[_0x198c04(0xa7)](_0xe0e1e0,{'phone':(0x0,typeorm_2[_0x198c04(0x79)])('%'+_0x5ae9dd+'%')}),_0x464cfc&&Object[_0x198c04(0xa7)](_0xe0e1e0,{'status':_0x464cfc});_0x37316f&&(_0xe0e1e0=[{'username':(0x0,typeorm_2[_0x198c04(0x79)])('%'+_0x37316f+'%')},{'email':(0x0,typeorm_2[_0x198c04(0x79)])('%'+_0x37316f+'%')},{'phone':(0x0,typeorm_2['Like'])('%'+_0x37316f+'%')}]);const [_0xcf7300,_0x47aa37]=await this[_0x198c04(0xfd)][_0x198c04(0xcd)]({'skip':(page-0x1)*size,'where':_0xe0e1e0,'take':size,'order':{'createdAt':_0x198c04(0x8d)},'cache':!![],'select':[_0x198c04(0x115),_0x198c04(0x104),_0x198c04(0xbb),_0x198c04(0xec),'sign',_0x198c04(0x84),'id',_0x198c04(0xf2),'createdAt','lastLoginIp','phone']}),_0x5c3eb9=_0xcf7300[_0x198c04(0xc6)](_0x225a8a=>_0x225a8a['id']),_0x159273=await this[_0x198c04(0x7c)][_0x198c04(0x81)](_0x5c3eb9);return _0xcf7300[_0x198c04(0x9e)](_0xf86477=>_0xf86477[_0x198c04(0x9b)]=_0x159273[_0x198c04(0xe2)](_0x4f4145=>_0x4f4145[_0x198c04(0xab)]===_0xf86477['id'])),_0x3abcbe[_0x198c04(0xd3)][_0x198c04(0xec)]!==_0x198c04(0xe4)&&_0xcf7300[_0x198c04(0x9e)](_0x5b0454=>_0x5b0454['email']=(0x0,utils_1[_0x198c04(0x95)])(_0x5b0454[_0x198c04(0xf2)])),_0x3abcbe[_0x198c04(0xd3)][_0x198c04(0xec)]!==_0x198c04(0xe4)&&_0xcf7300[_0x198c04(0x9e)](_0x6d60b9=>_0x6d60b9[_0x198c04(0x7a)]=(0x0,utils_1[_0x198c04(0xf8)])(_0x6d60b9[_0x198c04(0x7a)])),_0x3abcbe[_0x198c04(0xd3)]['role']!=='super'&&_0xcf7300[_0x198c04(0x9e)](_0x1bffbf=>_0x1bffbf[_0x198c04(0xe6)]=(0x0,utils_1[_0x198c04(0xf8)])(_0x1bffbf['phone'])),{'rows':_0xcf7300,'count':_0x47aa37};}async[_0x3a76c8(0x117)]({id:_0xe9290c}){const _0xbcf777=_0x3a76c8;return await this[_0xbcf777(0xfd)][_0xbcf777(0xea)]({'where':{'id':_0xe9290c},'select':['username','avatar',_0xbcf777(0xbb),_0xbcf777(0xec),_0xbcf777(0x114),'status']});}async[_0x3a76c8(0xfa)](_0x1a67d7){const _0x285c48=_0x3a76c8,{id:_0x4c8d39,status:_0x5493a5}=_0x1a67d7,_0x234468=await this[_0x285c48(0xfd)][_0x285c48(0xea)]({'where':{'id':_0x4c8d39}});if(!_0x234468)throw new common_1['HttpException'](_0x285c48(0xbc),common_1[_0x285c48(0x90)][_0x285c48(0x85)]);if(_0x234468['role']===_0x285c48(0xe4))throw new common_1['HttpException'](_0x285c48(0x113),common_1[_0x285c48(0x90)]['BAD_REQUEST']);if(_0x234468[_0x285c48(0x84)]===user_constant_1[_0x285c48(0xed)][_0x285c48(0x8c)])throw new common_1[(_0x285c48(0xac))](_0x285c48(0xcc),common_1[_0x285c48(0x90)][_0x285c48(0x85)]);if(_0x234468['role']===_0x285c48(0xe4))throw new common_1[(_0x285c48(0xac))](_0x285c48(0x113),common_1[_0x285c48(0x90)][_0x285c48(0x85)]);if(_0x5493a5===user_constant_1[_0x285c48(0xed)][_0x285c48(0x8c)])throw new common_1[(_0x285c48(0xac))](_0x285c48(0xc2),common_1[_0x285c48(0x90)][_0x285c48(0x85)]);const _0x99b9d3=await this[_0x285c48(0xfd)][_0x285c48(0xdc)]({'id':_0x4c8d39},{'status':_0x5493a5});if(_0x99b9d3[_0x285c48(0x7b)]<=0x0)throw new common_1[(_0x285c48(0xac))](_0x285c48(0x100),common_1['HttpStatus'][_0x285c48(0x85)]);return _0x285c48(0x103);}async[_0x3a76c8(0x98)](_0x23cc82){const _0x4baa69=_0x3a76c8,{id:_0x45a82f}=_0x23cc82,_0x3b8a2f=await this[_0x4baa69(0xfd)][_0x4baa69(0xea)]({'where':{'id':_0x45a82f}});if(!_0x3b8a2f)throw new common_1[(_0x4baa69(0xac))](_0x4baa69(0xbc),common_1[_0x4baa69(0x90)][_0x4baa69(0x85)]);const _0x24def5=_0x4baa69(0x7d),_0x5ac8f1=bcrypt[_0x4baa69(0xcb)](_0x24def5,0xa),_0x4bc5dc=await this[_0x4baa69(0xfd)][_0x4baa69(0xdc)]({'id':_0x45a82f},{'password':_0x5ac8f1});if(_0x4bc5dc[_0x4baa69(0x7b)]<=0x0)throw new common_1['HttpException'](_0x4baa69(0x101),common_1['HttpStatus'][_0x4baa69(0x85)]);return'密码重置为['+_0x24def5+']成功!';}async[_0x3a76c8(0xbd)](_0x25631f,_0x4cb957){const _0xb7b1c5=_0x3a76c8;return await this[_0xb7b1c5(0xfd)][_0xb7b1c5(0xdc)]({'id':_0x25631f},{'lastLoginIp':_0x4cb957});}async[_0x3a76c8(0x89)](_0x1aaba1,_0x27f2ed){const _0x41decc=_0x3a76c8,_0x16aaf8=await this[_0x41decc(0xfd)][_0x41decc(0xea)]({'where':{'openId':_0x1aaba1}});if(!_0x16aaf8){const _0x4267b3=_0x27f2ed?_0x27f2ed[_0x41decc(0x102)](':')[0x1]:'',_0xc50bad=await this[_0x41decc(0xae)](_0x4267b3),_0x5ee091=await this[_0x41decc(0x111)](_0x1aaba1,_0x4267b3);return await this[_0x41decc(0x7c)][_0x41decc(0xe9)](_0x5ee091['id'],_0x4267b3?_0xc50bad===null||_0xc50bad===void 0x0?void 0x0:_0xc50bad['id']:null),_0x5ee091;}return _0x16aaf8;}async[_0x3a76c8(0x111)](_0xb71857,_0x41fcf8){const _0xb52fb=_0x3a76c8,_0x32ff18=await this['globalConfigService'][_0xb52fb(0xde)]([_0xb52fb(0x78)]),_0x29a2fe={'avatar':_0x32ff18,'username':'用户'+(0x0,utils_1[_0xb52fb(0xb0)])(),'status':user_constant_1['UserStatusEnum'][_0xb52fb(0x97)],'sex':0x0,'email':(0x0,utils_1[_0xb52fb(0xb0)])()+'@default.com','invitedBy':_0x41fcf8,'openId':_0xb71857},_0x44b15a=await this[_0xb52fb(0xfd)][_0xb52fb(0x112)](_0x29a2fe);return _0x44b15a;}async[_0x3a76c8(0xc0)](_0x43c9d3,_0x2377c2){const _0x5104f0=_0x3a76c8;try{const _0x518f06=await this[_0x5104f0(0xfd)][_0x5104f0(0xea)]({'where':{'id':_0x2377c2}});if(!_0x518f06)return{'status':![],'msg':_0x5104f0(0x75)};const _0x4106b6=await this[_0x5104f0(0xfd)][_0x5104f0(0xea)]({'where':{'openId':_0x43c9d3}});if(_0x4106b6)return{'status':![],'msg':_0x5104f0(0xc8)};const _0x5836b2=await this[_0x5104f0(0xfd)]['update']({'id':_0x2377c2},{'openId':_0x43c9d3});if(_0x5836b2[_0x5104f0(0x7b)]<=0x0)return{'status':![],'msg':_0x5104f0(0x10e)};return{'status':!![],'msg':_0x5104f0(0xb6)};}catch(_0x467c9e){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async[_0x3a76c8(0xc7)](_0x1698c3){const _0x5b88b2=_0x3a76c8,_0x12ec5e=await this['userEntity'][_0x5b88b2(0xea)]({'where':{'id':_0x1698c3}});return _0x12ec5e===null||_0x12ec5e===void 0x0?void 0x0:_0x12ec5e[_0x5b88b2(0xf3)];}async[_0x3a76c8(0x80)](_0x461591){const _0xfb1db=_0x3a76c8,{username:_0x3c2287,password:_0x1c7a19,phone:_0x5d6081,phoneCode:_0x15aa30}=_0x461591,_0x30f88b=await this[_0xfb1db(0xfd)]['findOne']({'where':[{'username':_0x3c2287},{'phone':_0x5d6081}]});if(_0x30f88b&&_0x30f88b[_0xfb1db(0x115)]===_0x3c2287)throw new common_1[(_0xfb1db(0xac))]('用户名已存在、请更换用户名！',common_1[_0xfb1db(0x90)]['BAD_REQUEST']);if(_0x30f88b&&_0x30f88b['phone']===_0x5d6081)throw new common_1['HttpException'](_0xfb1db(0x8b),common_1[_0xfb1db(0x90)][_0xfb1db(0x85)]);}async[_0x3a76c8(0x11b)](_0x4c50b4){const _0xdd9142=_0x3a76c8;return await this[_0xdd9142(0xfd)][_0xdd9142(0x112)](_0x4c50b4);}};UserService=__decorate([(0x0,common_1[_0x3a76c8(0xeb)])(),__param(0x0,(0x0,typeorm_1[_0x3a76c8(0x11a)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x3a76c8(0x11a)])(whiteList_entity_1[_0x3a76c8(0xb7)])),__param(0x7,(0x0,typeorm_1[_0x3a76c8(0x11a)])(config_entity_1[_0x3a76c8(0xd5)])),__metadata(_0x3a76c8(0xca),[typeorm_2[_0x3a76c8(0xd1)],typeorm_2['Repository'],typeorm_2[_0x3a76c8(0xd8)],verification_service_1[_0x3a76c8(0x109)],mailer_1[_0x3a76c8(0xcf)],userBalance_service_1[_0x3a76c8(0xaf)],globalConfig_service_1[_0x3a76c8(0xb8)],typeorm_2[_0x3a76c8(0xd1)]])],UserService),exports[_0x3a76c8(0xd4)]=UserService;