'use strict';function _0x9ab9(_0x10fee5,_0x575206){const _0x159093=_0x1590();return _0x9ab9=function(_0x9ab9aa,_0x46b32a){_0x9ab9aa=_0x9ab9aa-0x111;let _0x438ddc=_0x159093[_0x9ab9aa];return _0x438ddc;},_0x9ab9(_0x10fee5,_0x575206);}const _0x1a305d=_0x9ab9;(function(_0x173558,_0x3ce5cd){const _0xebcdd9=_0x9ab9,_0x175da1=_0x173558();while(!![]){try{const _0x49bfe4=parseInt(_0xebcdd9(0x113))/0x1+-parseInt(_0xebcdd9(0x14c))/0x2+parseInt(_0xebcdd9(0x129))/0x3+-parseInt(_0xebcdd9(0x138))/0x4+parseInt(_0xebcdd9(0x124))/0x5*(-parseInt(_0xebcdd9(0x145))/0x6)+parseInt(_0xebcdd9(0x139))/0x7*(parseInt(_0xebcdd9(0x130))/0x8)+parseInt(_0xebcdd9(0x142))/0x9*(-parseInt(_0xebcdd9(0x11e))/0xa);if(_0x49bfe4===_0x3ce5cd)break;else _0x175da1['push'](_0x175da1['shift']());}catch(_0x56df3f){_0x175da1['push'](_0x175da1['shift']());}}}(_0x1590,0x931f2));var __decorate=this&&this[_0x1a305d(0x111)]||function(_0x2700c2,_0x2765b5,_0x595de3,_0x23f6bc){const _0xfdd504=_0x1a305d;var _0x49a3e1=arguments[_0xfdd504(0x15c)],_0x6d13b2=_0x49a3e1<0x3?_0x2765b5:_0x23f6bc===null?_0x23f6bc=Object[_0xfdd504(0x15d)](_0x2765b5,_0x595de3):_0x23f6bc,_0x7dac1a;if(typeof Reflect===_0xfdd504(0x117)&&typeof Reflect[_0xfdd504(0x11a)]===_0xfdd504(0x135))_0x6d13b2=Reflect[_0xfdd504(0x11a)](_0x2700c2,_0x2765b5,_0x595de3,_0x23f6bc);else{for(var _0x214561=_0x2700c2[_0xfdd504(0x15c)]-0x1;_0x214561>=0x0;_0x214561--)if(_0x7dac1a=_0x2700c2[_0x214561])_0x6d13b2=(_0x49a3e1<0x3?_0x7dac1a(_0x6d13b2):_0x49a3e1>0x3?_0x7dac1a(_0x2765b5,_0x595de3,_0x6d13b2):_0x7dac1a(_0x2765b5,_0x595de3))||_0x6d13b2;}return _0x49a3e1>0x3&&_0x6d13b2&&Object[_0xfdd504(0x151)](_0x2765b5,_0x595de3,_0x6d13b2),_0x6d13b2;},__metadata=this&&this['__metadata']||function(_0x395f55,_0x431af2){const _0x4817ad=_0x1a305d;if(typeof Reflect===_0x4817ad(0x117)&&typeof Reflect[_0x4817ad(0x15e)]===_0x4817ad(0x135))return Reflect['metadata'](_0x395f55,_0x431af2);};Object[_0x1a305d(0x151)](exports,_0x1a305d(0x13a),{'value':!![]}),exports[_0x1a305d(0x12d)]=void 0x0;const common_1=require(_0x1a305d(0x121)),axios_1=require(_0x1a305d(0x147)),config_1=require(_0x1a305d(0x158)),chatgpt_service_1=require('../chatgpt/chatgpt.service'),prompt_1=require(_0x1a305d(0x148)),globalConfig_service_1=require(_0x1a305d(0x15b)),searxng_1=require(_0x1a305d(0x14d));function _0x1590(){const _0x1e8baa=['RagQueryPrompt','defineProperty','DeepQueryPrompt','value','getConfigs','debug',']]\x20','chatProcess','./config','[SearchService]\x20进入下一步','answer','../globalConfig/globalConfig.service','length','getOwnPropertyDescriptor','metadata','string','__decorate','related','1088364bntRFu','simple','chatgptService','write','object','user','[SearchService]\x20开始写入answer','decorate','ChatgptService','join','design:paramtypes','10MIDqfi','bing,images','splice','@nestjs/common','searchController','ESearXNGCategory','965LrsZrx','webPages','message','BING_SEARCH_V7_ENDPOINT','get','3354531YZKvft','retry:\x2030000\x0a','error','snippet','SearchService','[SearchService]\x20开始写入叙述的问题','log','24784JPuBVR','event:\x20customEvent\x0a','Injectable','searchPlatformUrl','globalConfigService','function','random','cb379c66059d4c6a8db7adebe08ee45c','1709768PwKBgE','2653vdZAoz','__esModule','deep','end','[SearchService\x20成功获取到父ID]:\x20','searchWithBing','stringify','replace','default','6676011SvCxOZ','id:\x20','sendStreamData','30306RabVdt','GlobalConfigService','axios','./config/prompt','IMAGES','paramsFormatter','Logger','1268018cTNNYt','./common/searxng','[SearchService\x20text]:\x20','slice'];_0x1590=function(){return _0x1e8baa;};return _0x1590();}let SearchService=class SearchService{constructor(_0x6c1f2f,_0x3c6056){const _0x3c7035=_0x1a305d;this['chatgptService']=_0x6c1f2f,this['globalConfigService']=_0x3c6056,this[_0x3c7035(0x13e)]=async _0x4dfb96=>{const _0x5a16f4=_0x3c7035;var _0x197175;try{const _0x45ceae=_0x5a16f4(0x137),_0x3b3070=(await(0x0,axios_1[_0x5a16f4(0x141)])({'url':config_1[_0x5a16f4(0x127)],'timeout':0x3e8*0xa,'method':_0x5a16f4(0x128),'params':{'q':_0x4dfb96,'mkt':'en-US'},'headers':{'Ocp-Apim-Subscription-Key':_0x5a16f4(0x137)}}))['data'],_0x3587a3=((_0x197175=_0x3b3070===null||_0x3b3070===void 0x0?void 0x0:_0x3b3070[_0x5a16f4(0x125)])===null||_0x197175===void 0x0?void 0x0:_0x197175[_0x5a16f4(0x153)])||[];return _0x3587a3['map']((_0x22f30b,_0x2590cf)=>{return{'id':_0x2590cf+0x1,'name':_0x22f30b['name'],'url':_0x22f30b['url'],'snippet':_0x22f30b['snippet']};});}catch(_0xf4f993){return common_1['Logger'][_0x5a16f4(0x12b)]('[Bing\x20Search\x20Error]:\x20'+(_0xf4f993[_0x5a16f4(0x126)]||_0xf4f993)),[];}};}async[_0x1a305d(0x122)](_0x13b6fe,_0x2f5f22,_0x45ee03){const _0x32b6bc=_0x1a305d;_0x45ee03['on']('close',()=>{const _0x30a923=_0x9ab9;common_1[_0x30a923(0x14b)][_0x30a923(0x155)]('[SearchService]\x20流关闭'),_0x45ee03[_0x30a923(0x13c)]();});let {prompt:_0x7eba17,model:_0x231bf6,mode:_0x416c8a,parentMessageId:_0x1bff9c}=_0x13b6fe;if(_0x1bff9c){const _0x33c9e1=await this['chatgptService']['chatProcess']({'prompt':_0x7eba17,'model':_0x231bf6,'options':{'model':_0x231bf6,'parentMessageId':_0x1bff9c,'usingNetwork':!![]}},_0x2f5f22,undefined,_0x50b435=>{const _0x2a4cd0=_0x9ab9;common_1['Logger'][_0x2a4cd0(0x155)](_0x2a4cd0(0x14e)+_0x50b435);const _0x355bed=JSON['stringify']({'chat':_0x50b435});_0x45ee03[_0x2a4cd0(0x116)]('\x0a'+_0x355bed);});_0x45ee03['write']('\x0a'+JSON['stringify']({'parentMessageId':_0x33c9e1['id']}));}else{const _0x54b1cb=await(0x0,searxng_1['default'])(await this[_0x32b6bc(0x134)][_0x32b6bc(0x154)]([_0x32b6bc(0x133)]),{'q':_0x7eba17}),_0x33046a=JSON[_0x32b6bc(0x13f)]({'context':_0x54b1cb[_0x32b6bc(0x120)](0x0,0x14)});_0x45ee03[_0x32b6bc(0x116)](''+_0x33046a);const _0x233622=await(0x0,searxng_1[_0x32b6bc(0x141)])(await this[_0x32b6bc(0x134)][_0x32b6bc(0x154)]([_0x32b6bc(0x133)]),{'q':_0x7eba17,'categories':[searxng_1[_0x32b6bc(0x123)][_0x32b6bc(0x149)]],'engines':_0x32b6bc(0x11f)}),_0x39a96a=JSON['stringify']({'images':_0x233622['splice'](0x0,0x14)});_0x45ee03[_0x32b6bc(0x116)]('\x0a'+_0x39a96a),common_1[_0x32b6bc(0x14b)][_0x32b6bc(0x155)](_0x32b6bc(0x159));const _0x8c1d12=_0x54b1cb[_0x32b6bc(0x14f)](0x0,+0x8);common_1[_0x32b6bc(0x14b)][_0x32b6bc(0x155)](_0x32b6bc(0x119));let _0x3c9728=![],_0x57da0b='';const _0x3f7889=this[_0x32b6bc(0x14a)](_0x7eba17,_0x416c8a,_0x8c1d12,_0x32b6bc(0x15a));try{const _0x24d141=await this[_0x32b6bc(0x115)][_0x32b6bc(0x157)]({'prompt':typeof _0x3f7889==_0x32b6bc(0x15f)?_0x3f7889:JSON[_0x32b6bc(0x13f)](_0x3f7889),'options':{'model':_0x231bf6,'parentMessageId':_0x1bff9c,'usingNetwork':!![]},'model':_0x231bf6},_0x2f5f22,undefined,_0x4d6878=>{const _0x49561d=_0x32b6bc,_0x38143d=JSON[_0x49561d(0x13f)]({'answer':JSON[_0x49561d(0x13f)](_0x4d6878)});_0x45ee03[_0x49561d(0x116)]('\x0a'+_0x38143d),_0x57da0b=_0x4d6878,_0x3c9728=![];});try{_0x1bff9c=_0x24d141['id'],_0x1bff9c&&common_1[_0x32b6bc(0x14b)][_0x32b6bc(0x12f)](_0x32b6bc(0x13d)+_0x1bff9c);}catch(_0x25aff4){}common_1[_0x32b6bc(0x14b)][_0x32b6bc(0x155)](_0x32b6bc(0x12e)),_0x3c9728=![],_0x57da0b='';let _0x18a07f=this[_0x32b6bc(0x14a)](_0x7eba17,_0x416c8a,_0x8c1d12,_0x32b6bc(0x112));await this[_0x32b6bc(0x115)][_0x32b6bc(0x157)]({'prompt':typeof _0x18a07f==_0x32b6bc(0x15f)?_0x18a07f:JSON[_0x32b6bc(0x13f)](_0x18a07f),'options':{'model':_0x231bf6,'usingNetwork':!![]},'model':_0x231bf6},_0x2f5f22,undefined,_0x5915bb=>{const _0x31b98d=_0x32b6bc,_0x2c292f=JSON[_0x31b98d(0x13f)]({'related':_0x5915bb});_0x45ee03[_0x31b98d(0x116)]('\x0a'+_0x2c292f),_0x57da0b=_0x5915bb,_0x3c9728=![];}),_0x45ee03[_0x32b6bc(0x116)]('\x0a'+JSON[_0x32b6bc(0x13f)]({'parentMessageId':_0x1bff9c}));}catch(_0xbf7d2c){_0x45ee03[_0x32b6bc(0x116)]('\x0a'+JSON[_0x32b6bc(0x13f)]({'error':_0xbf7d2c[_0x32b6bc(0x126)]||_0xbf7d2c}));}}_0x45ee03['end']();}[_0x1a305d(0x14a)](_0x3b6abd,_0x46599e=_0x1a305d(0x114),_0xf6fa95,_0x57c1f3){const _0x341d79=_0x1a305d;try{const _0x5c0d97=_0xf6fa95['map']((_0x1b47e1,_0x15f86f)=>'[[citation:'+(_0x15f86f+0x1)+_0x341d79(0x156)+_0x1b47e1[_0x341d79(0x12c)])[_0x341d79(0x11c)]('\x0a\x0a');let _0x57abf0=_0x57c1f3===_0x341d79(0x15a)?prompt_1[_0x341d79(0x150)]:prompt_1['MoreQuestionsPrompt'];_0x46599e===_0x341d79(0x13b)&&_0x57c1f3===_0x341d79(0x15a)&&(_0x57abf0=prompt_1[_0x341d79(0x152)]);const _0x22bc5=_0x57abf0[_0x341d79(0x140)]('%s',_0x5c0d97),_0x2db16c=[{'role':_0x341d79(0x118),'content':_0x22bc5+'\x20'+_0x3b6abd}];return _0x2db16c;}catch(_0x190328){return common_1[_0x341d79(0x14b)][_0x341d79(0x12b)]('[SearchService\x20paramsFormatter\x20Error]:\x20'+(_0x190328[_0x341d79(0x126)]||_0x190328)),[];}}async[_0x1a305d(0x144)](_0x461f3f,_0x3a05b6){const _0x4d8d56=_0x1a305d;_0x3a05b6=typeof _0x3a05b6===_0x4d8d56(0x15f)?_0x3a05b6:JSON['stringify'](_0x3a05b6),_0x461f3f[_0x4d8d56(0x116)](_0x4d8d56(0x131)),_0x461f3f[_0x4d8d56(0x116)](_0x4d8d56(0x143)+(+new Date()+Math[_0x4d8d56(0x136)]())+'\x0a'),_0x461f3f[_0x4d8d56(0x116)](_0x4d8d56(0x12a)),_0x461f3f[_0x4d8d56(0x116)]('data:\x20'+_0x3a05b6+'\x0a\x0a');}};SearchService=__decorate([(0x0,common_1[_0x1a305d(0x132)])(),__metadata(_0x1a305d(0x11d),[chatgpt_service_1[_0x1a305d(0x11b)],globalConfig_service_1[_0x1a305d(0x146)]])],SearchService),exports['SearchService']=SearchService;