'use strict';const _0x334754=_0x24f3;(function(_0x5bc2a0,_0x551000){const _0x4125fd=_0x24f3,_0x18e3c7=_0x5bc2a0();while(!![]){try{const _0x5e2070=parseInt(_0x4125fd(0xab))/0x1*(-parseInt(_0x4125fd(0xef))/0x2)+parseInt(_0x4125fd(0x100))/0x3+parseInt(_0x4125fd(0xa5))/0x4+parseInt(_0x4125fd(0xae))/0x5+-parseInt(_0x4125fd(0xec))/0x6*(-parseInt(_0x4125fd(0xa1))/0x7)+parseInt(_0x4125fd(0xda))/0x8+-parseInt(_0x4125fd(0xa4))/0x9;if(_0x5e2070===_0x551000)break;else _0x18e3c7['push'](_0x18e3c7['shift']());}catch(_0x3602ba){_0x18e3c7['push'](_0x18e3c7['shift']());}}}(_0x3495,0x8f25a));var __decorate=this&&this[_0x334754(0x102)]||function(_0x45c5fb,_0x40f44a,_0x7458db,_0x5740be){const _0x4f2a24=_0x334754;var _0x3953c9=arguments['length'],_0xa11003=_0x3953c9<0x3?_0x40f44a:_0x5740be===null?_0x5740be=Object[_0x4f2a24(0xb4)](_0x40f44a,_0x7458db):_0x5740be,_0x370ad9;if(typeof Reflect===_0x4f2a24(0x9a)&&typeof Reflect[_0x4f2a24(0xc6)]==='function')_0xa11003=Reflect[_0x4f2a24(0xc6)](_0x45c5fb,_0x40f44a,_0x7458db,_0x5740be);else{for(var _0x5f071d=_0x45c5fb[_0x4f2a24(0x9d)]-0x1;_0x5f071d>=0x0;_0x5f071d--)if(_0x370ad9=_0x45c5fb[_0x5f071d])_0xa11003=(_0x3953c9<0x3?_0x370ad9(_0xa11003):_0x3953c9>0x3?_0x370ad9(_0x40f44a,_0x7458db,_0xa11003):_0x370ad9(_0x40f44a,_0x7458db))||_0xa11003;}return _0x3953c9>0x3&&_0xa11003&&Object['defineProperty'](_0x40f44a,_0x7458db,_0xa11003),_0xa11003;},__metadata=this&&this[_0x334754(0xb8)]||function(_0x43de23,_0x485716){const _0x567e4c=_0x334754;if(typeof Reflect===_0x567e4c(0x9a)&&typeof Reflect[_0x567e4c(0xa8)]===_0x567e4c(0xa3))return Reflect[_0x567e4c(0xa8)](_0x43de23,_0x485716);},__param=this&&this[_0x334754(0xa0)]||function(_0x4f5b6f,_0x5c1ce3){return function(_0x5518a2,_0x15aa00){_0x5c1ce3(_0x5518a2,_0x15aa00,_0x4f5b6f);};};function _0x3495(){const _0x431daa=['?imageView2/1/w/','log','includes','你删除的对话记录不存在、请检查！','map','Repository','parse','thumbImg','UserEntity','5006152gawKZf','typeorm','isGroup','Workbook','?x-oss-process=image/resize,w_','answer','InjectRepository','Like','ChatLogService','assign','/q/55','setHeader','design:paramtypes','saveChatLog','find','deleteChatLog','default','CHAT_TYPE','6TSiOsE','createdAt','你操作的图片不存在、请检查！','42XKfRGc','findAndCount','取消推荐','chatGroupEntity','attachment;\x20filename=','提问时间','Content-Disposition','recDrawImg','assistant','count','end','email','components','type','defineProperty','提问问题','prompt','2726034KYqTdu','querAllDrawLog','__decorate','ali','model','当前页面已经没有东西可以删除了！','username','../chatGroup/chatGroup.entity','chatLogEntity','object','chatList','user','length','rec','BAD_REQUEST','__param','1953623zWZrVi','Content-Type','function','10259361yTSzxR','499836ztKlOo','../../common/constants/balance.constant','group','metadata','../user/user.entity','exportExcel','44349veEmWL','dall-e-3','图片成功！','3595465kpQVTi','DESC','byAppId','./chatLog.entity','fileInfo','userEntity','getOwnPropertyDescriptor','write','paintCount','@nestjs/typeorm','__metadata','回答答案','cos','Not','update','userId','HttpException','extend','formatDate','affected','tencent','findOne','forEach','columns','decorate','../../common/utils','DeductionKey','maskEmail','message_id','querAllChatLog','chat.xlsx','HttpStatus','DALL-E2','exceljs','PAINT_TYPE'];_0x3495=function(){return _0x431daa;};return _0x3495();}Object[_0x334754(0xfd)](exports,'__esModule',{'value':!![]}),exports[_0x334754(0xe2)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x334754(0xb7)),chatLog_entity_1=require(_0x334754(0xb1)),typeorm_2=require(_0x334754(0xdb)),balance_constant_1=require(_0x334754(0xa6)),user_entity_1=require(_0x334754(0xa9)),utils_1=require(_0x334754(0xc7)),exceljs_1=require(_0x334754(0xcf)),chatGroup_entity_1=require(_0x334754(0x98));function _0x24f3(_0x5bb5cd,_0x5692ea){const _0x3495f5=_0x3495();return _0x24f3=function(_0x24f3f2,_0x4f040c){_0x24f3f2=_0x24f3f2-0x96;let _0x821381=_0x3495f5[_0x24f3f2];return _0x821381;},_0x24f3(_0x5bb5cd,_0x5692ea);}let ChatLogService=class ChatLogService{constructor(_0x5f0b40,_0x2eac40,_0x255b3b){const _0x4212cd=_0x334754;this[_0x4212cd(0x99)]=_0x5f0b40,this[_0x4212cd(0xb3)]=_0x2eac40,this[_0x4212cd(0xf2)]=_0x255b3b;}async[_0x334754(0xe7)](_0x3667d1){const _0xaa471=_0x334754;return await this[_0xaa471(0x99)]['save'](_0x3667d1);}async['querDrawLog'](_0x2d7e86,_0x131d5e){const _0x14da9d=_0x334754,{id:_0x504db2}=_0x2d7e86[_0x14da9d(0x9c)],{model:_0x93765e}=_0x131d5e,_0x82fff3={'userId':_0x504db2,'type':balance_constant_1['DeductionKey'][_0x14da9d(0xd0)]};_0x93765e&&(_0x82fff3[_0x14da9d(0x104)]=_0x93765e,_0x93765e===_0x14da9d(0xce)&&(_0x82fff3[_0x14da9d(0x104)]=(0x0,typeorm_2['In'])(['DALL-E2',_0x14da9d(0xac)])));const _0x32c8b5=await this[_0x14da9d(0x99)][_0x14da9d(0xe8)]({'where':_0x82fff3,'order':{'id':_0x14da9d(0xaf)},'select':['id',_0x14da9d(0xdf),_0x14da9d(0xff),_0x14da9d(0xca),_0x14da9d(0xa7),'model',_0x14da9d(0xbf),_0x14da9d(0xfc),'fileInfo']});return _0x32c8b5[_0x14da9d(0xc4)](_0x50c4ad=>{const _0x25aa02=_0x14da9d;if(_0x50c4ad[_0x25aa02(0xfc)]===_0x25aa02(0xb6)){const _0x4557f7=_0x50c4ad[_0x25aa02(0x104)]==='mj'?0x136:0xa0,_0x3f25c0=_0x50c4ad['answer'][_0x25aa02(0xd3)]('cos')?_0x25aa02(0xc2):_0x25aa02(0x103),_0x1cdd1d=_0x3f25c0==='tencent'?_0x25aa02(0xd1)+_0x4557f7+_0x25aa02(0xe4):_0x25aa02(0xde)+_0x4557f7;_0x50c4ad[_0x25aa02(0xd8)]=_0x50c4ad[_0x25aa02(0xdf)]+_0x1cdd1d;try{_0x50c4ad[_0x25aa02(0xb2)]=_0x50c4ad[_0x25aa02(0xb2)]?JSON[_0x25aa02(0xd7)](_0x50c4ad[_0x25aa02(0xb2)]):null;}catch(_0x530dd0){_0x50c4ad[_0x25aa02(0xb2)]={};}}}),_0x32c8b5;}async[_0x334754(0x101)](_0x5007c9){const _0x641c57=_0x334754,{page:page=0x1,size:size=0x14,rec:_0x1d2166,userId:_0x53cfa2,model:_0x565e89}=_0x5007c9,_0x4ed0e6={'type':balance_constant_1[_0x641c57(0xc8)][_0x641c57(0xd0)],'prompt':(0x0,typeorm_2[_0x641c57(0xbb)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x1d2166&&Object['assign'](_0x4ed0e6,{'rec':_0x1d2166}),_0x53cfa2&&Object[_0x641c57(0xe3)](_0x4ed0e6,{'userId':_0x53cfa2});_0x565e89&&(_0x4ed0e6[_0x641c57(0x104)]=_0x565e89,_0x565e89===_0x641c57(0xce)&&(_0x4ed0e6[_0x641c57(0x104)]=(0x0,typeorm_2['In'])([_0x641c57(0xce),_0x641c57(0xac)])));const [_0x3297c0,_0x50223b]=await this[_0x641c57(0x99)]['findAndCount']({'order':{'id':_0x641c57(0xaf)},'skip':(page-0x1)*size,'take':size,'where':_0x4ed0e6});return _0x3297c0[_0x641c57(0xc4)](_0xeb044d=>{const _0x4e271e=_0x641c57;var _0x54b029;if(_0xeb044d[_0x4e271e(0xfc)]===_0x4e271e(0xb6)){const _0x148304=_0xeb044d['model']==='mj'?0x136:0xa0,_0x3c04d7=_0xeb044d[_0x4e271e(0xdf)][_0x4e271e(0xd3)](_0x4e271e(0xba))?_0x4e271e(0xc2):_0x4e271e(0x103),_0x28b73e=_0x3c04d7==='tencent'?_0x4e271e(0xd1)+_0x148304+_0x4e271e(0xe4):_0x4e271e(0xde)+_0x148304;_0xeb044d[_0x4e271e(0xd8)]=_0xeb044d[_0x4e271e(0xdf)]+_0x28b73e;try{const _0x4a6294=_0xeb044d[_0x4e271e(0xbf)]?JSON[_0x4e271e(0xd7)](_0xeb044d['extend']):null;_0x4a6294&&(_0x4a6294?_0xeb044d[_0x4e271e(0xdc)]=((_0x54b029=_0x4a6294===null||_0x4a6294===void 0x0?void 0x0:_0x4a6294[_0x4e271e(0xfb)][0x0])===null||_0x54b029===void 0x0?void 0x0:_0x54b029[_0x4e271e(0xfb)][_0x4e271e(0x9d)])===0x5:_0xeb044d[_0x4e271e(0xdc)]=![]);}catch(_0x52f578){console[_0x4e271e(0xd2)]('querAllDrawLog\x20Json\x20parse\x20error',_0x52f578);}}}),{'rows':_0x3297c0,'count':_0x50223b};}async[_0x334754(0xf6)](_0x4ba193){const _0x3ec41b=_0x334754,{id:_0xe4afb6}=_0x4ba193,_0x277b30=await this['chatLogEntity'][_0x3ec41b(0xc3)]({'where':{'id':_0xe4afb6,'type':balance_constant_1[_0x3ec41b(0xc8)]['PAINT_TYPE']}});if(!_0x277b30)throw new common_1[(_0x3ec41b(0xbe))]('你推荐的图片不存在、请检查！',common_1[_0x3ec41b(0xcd)]['BAD_REQUEST']);const _0x12c924=_0x277b30[_0x3ec41b(0x9e)]===0x1?0x0:0x1,_0x48f1eb=await this['chatLogEntity'][_0x3ec41b(0xbc)]({'id':_0xe4afb6},{'rec':_0x12c924});if(_0x48f1eb['affected']>0x0)return(_0x12c924?'推荐':_0x3ec41b(0xf1))+_0x3ec41b(0xad);throw new common_1[(_0x3ec41b(0xbe))](_0x3ec41b(0xee),common_1[_0x3ec41b(0xcd)][_0x3ec41b(0x9f)]);}async[_0x334754(0xaa)](_0x1bbe47,_0x10cc74){const _0x55afd0=_0x334754,_0x132eba={'type':balance_constant_1['DeductionKey'][_0x55afd0(0xeb)]},{page:page=0x1,size:size=0x1e,prompt:_0x6795b0,email:_0x370a50}=_0x1bbe47;_0x6795b0&&Object[_0x55afd0(0xe3)](_0x132eba,{'prompt':(0x0,typeorm_2[_0x55afd0(0xe1)])('%'+_0x6795b0+'%')});if(_0x370a50){const _0x1d966f=await this[_0x55afd0(0xb3)][_0x55afd0(0xc3)]({'where':{'email':_0x370a50}});(_0x1d966f===null||_0x1d966f===void 0x0?void 0x0:_0x1d966f['id'])&&Object['assign'](_0x132eba,{'userId':_0x1d966f['id']});}const [_0x45777f,_0x3a23eb]=await this[_0x55afd0(0x99)]['findAndCount']({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x132eba}),_0x27f018=_0x45777f[_0x55afd0(0xd5)](_0x417891=>_0x417891['userId']),_0x1a7c98=await this[_0x55afd0(0xb3)][_0x55afd0(0xe8)]({'where':{'id':(0x0,typeorm_2['In'])(_0x27f018)}}),_0x556006=_0x45777f[_0x55afd0(0xd5)](_0x5ae5a8=>{const _0x17907f=_0x55afd0,_0x1a30f0=_0x1a7c98[_0x17907f(0xe8)](_0x10b0ac=>_0x10b0ac['id']===_0x5ae5a8[_0x17907f(0xbd)]);return{'username':_0x1a30f0?_0x1a30f0[_0x17907f(0x97)]:'','email':_0x1a30f0?_0x1a30f0['email']:'','prompt':_0x5ae5a8['prompt'],'answer':_0x5ae5a8[_0x17907f(0xdf)],'createdAt':(0x0,utils_1[_0x17907f(0xc0)])(_0x5ae5a8[_0x17907f(0xed)])};}),_0x2f14b9=new exceljs_1[(_0x55afd0(0xea))][(_0x55afd0(0xdd))](),_0xba1677=_0x2f14b9['addWorksheet']('chatlog');_0xba1677[_0x55afd0(0xc5)]=[{'header':'用户名','key':'username','width':0x14},{'header':'用户邮箱','key':_0x55afd0(0xfa),'width':0x14},{'header':_0x55afd0(0xf4),'key':'createdAt','width':0x14},{'header':_0x55afd0(0xfe),'key':_0x55afd0(0xff),'width':0x50},{'header':_0x55afd0(0xb9),'key':_0x55afd0(0xdf),'width':0x96}],_0x556006[_0x55afd0(0xc4)](_0xc40432=>_0xba1677['addRow'](_0xc40432)),_0x10cc74['setHeader'](_0x55afd0(0xa2),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x10cc74[_0x55afd0(0xe5)](_0x55afd0(0xf5),_0x55afd0(0xf3)+_0x55afd0(0xcc)),await _0x2f14b9['xlsx'][_0x55afd0(0xb5)](_0x10cc74),_0x10cc74[_0x55afd0(0xf9)]();}async[_0x334754(0xcb)](_0x346189,_0xefe5a5){const _0x546685=_0x334754,{page:page=0x1,size:size=0x14,userId:_0x186194,prompt:_0x42d6c9}=_0x346189,_0x2b9b31={'type':balance_constant_1[_0x546685(0xc8)][_0x546685(0xeb)],'prompt':(0x0,typeorm_2['Not'])('')};_0x186194&&Object[_0x546685(0xe3)](_0x2b9b31,{'userId':_0x186194}),_0x42d6c9&&Object[_0x546685(0xe3)](_0x2b9b31,{'prompt':(0x0,typeorm_2[_0x546685(0xe1)])('%'+_0x42d6c9+'%')});const [_0xa8e283,_0x2f34bf]=await this['chatLogEntity'][_0x546685(0xf0)]({'order':{'id':_0x546685(0xaf)},'skip':(page-0x1)*size,'take':size,'where':_0x2b9b31}),_0x176647=_0xa8e283[_0x546685(0xd5)](_0x402cda=>_0x402cda[_0x546685(0xbd)]),_0x5df8c3=await this[_0x546685(0xb3)][_0x546685(0xe8)]({'where':{'id':(0x0,typeorm_2['In'])(_0x176647)},'select':['id',_0x546685(0x97),_0x546685(0xfa)]});return _0xa8e283[_0x546685(0xc4)](_0x2c0a61=>{const _0x5c6e04=_0x546685,{username:_0x583da6,email:_0x252d59}=_0x5df8c3[_0x5c6e04(0xe8)](_0x275619=>_0x275619['id']===_0x2c0a61[_0x5c6e04(0xbd)])||{};_0x2c0a61[_0x5c6e04(0x97)]=_0x583da6,_0x2c0a61[_0x5c6e04(0xfa)]=_0x252d59;}),_0xefe5a5[_0x546685(0x9c)]['role']!=='super'&&_0xa8e283[_0x546685(0xc4)](_0x5f5d0f=>_0x5f5d0f[_0x546685(0xfa)]=(0x0,utils_1[_0x546685(0xc9)])(_0x5f5d0f[_0x546685(0xfa)])),_0xa8e283['forEach'](_0x17c3df=>{const _0x374a25=_0x546685;!_0x17c3df[_0x374a25(0xfa)]&&(_0x17c3df[_0x374a25(0xfa)]=(_0x17c3df===null||_0x17c3df===void 0x0?void 0x0:_0x17c3df[_0x374a25(0xbd)])+'@rocket.com'),!_0x17c3df['username']&&(_0x17c3df[_0x374a25(0x97)]='游客'+(_0x17c3df===null||_0x17c3df===void 0x0?void 0x0:_0x17c3df[_0x374a25(0xbd)]));}),{'rows':_0xa8e283,'count':_0x2f34bf};}async[_0x334754(0x9b)](_0x5a8669,_0x17596a){const _0x831c39=_0x334754,{id:_0x1821d1}=_0x5a8669[_0x831c39(0x9c)],{groupId:_0x3b4b34}=_0x17596a,_0x4a16e7={'userId':_0x1821d1,'isDelete':![]};_0x3b4b34&&Object[_0x831c39(0xe3)](_0x4a16e7,{'groupId':_0x3b4b34});if(_0x3b4b34){const _0x578619=await this['chatGroupEntity'][_0x831c39(0xf8)]({'where':{'isDelete':![]}});if(_0x578619===0x0)return[];}const _0x52afc8=await this['chatLogEntity'][_0x831c39(0xe8)]({'where':_0x4a16e7});return _0x52afc8[_0x831c39(0xd5)](_0x5b5223=>{const _0x3aaa90=_0x831c39,{prompt:_0x5f1da5,role:_0x4cd259,answer:_0x676ce8,createdAt:_0x341097,model:_0x4ccd1a,conversationOptions:_0x5ad66b,requestOptions:_0x828403,id:_0x442b2b,fileType:_0x1027eb,fileContent:_0x65f8f1}=_0x5b5223;let _0x9b54fd=null,_0x5614be=null;try{_0x9b54fd=JSON[_0x3aaa90(0xd7)](_0x5ad66b),_0x5614be=JSON['parse'](_0x828403);}catch(_0x48d07f){}return{'chatId':_0x442b2b,'dateTime':(0x0,utils_1[_0x3aaa90(0xc0)])(_0x341097),'text':_0x4cd259==='user'?_0x5f1da5:_0x676ce8,'inversion':_0x4cd259===_0x3aaa90(0x9c),'error':![],'conversationOptions':_0x9b54fd,'requestOptions':_0x5614be,'fileType':_0x1027eb,'fileContent':_0x65f8f1};});}async[_0x334754(0xe9)](_0x5de07e,_0x117cff){const _0x267367=_0x334754,{id:_0x16cc3b}=_0x5de07e['user'],{id:_0x52f741}=_0x117cff,_0x1ce8a1=await this[_0x267367(0x99)]['findOne']({'where':{'id':_0x52f741,'userId':_0x16cc3b}});if(!_0x1ce8a1)throw new common_1[(_0x267367(0xbe))](_0x267367(0xd4),common_1[_0x267367(0xcd)][_0x267367(0x9f)]);const _0x4cebb2=await this[_0x267367(0x99)]['update']({'id':_0x52f741},{'isDelete':!![]});if(_0x4cebb2[_0x267367(0xc1)]>0x0)return'删除对话记录成功！';else throw new common_1[(_0x267367(0xbe))](_0x267367(0xd4),common_1[_0x267367(0xcd)][_0x267367(0x9f)]);}async['delByGroupId'](_0x112cb2,_0x50cfa5){const _0x963d7a=_0x334754,{groupId:_0x227741}=_0x50cfa5,{id:_0x158e57}=_0x112cb2[_0x963d7a(0x9c)],_0x742fe9=await this[_0x963d7a(0xf2)][_0x963d7a(0xc3)]({'where':{'id':_0x227741,'userId':_0x158e57}});if(!_0x742fe9)throw new common_1[(_0x963d7a(0xbe))]('你删除的对话记录不存在、请检查！',common_1[_0x963d7a(0xcd)][_0x963d7a(0x9f)]);const _0xb3c4fd=await this[_0x963d7a(0x99)][_0x963d7a(0xbc)]({'groupId':_0x227741},{'isDelete':!![]});if(_0xb3c4fd[_0x963d7a(0xc1)]>0x0)return'删除对话记录成功！';if(_0xb3c4fd[_0x963d7a(0xc1)]===0x0)throw new common_1[(_0x963d7a(0xbe))](_0x963d7a(0x96),common_1[_0x963d7a(0xcd)][_0x963d7a(0x9f)]);}async[_0x334754(0xb0)](_0x2a89c4,_0x2d92ea){const _0x1eecde=_0x334754,{id:_0x97f63d}=_0x2a89c4[_0x1eecde(0x9c)],{appId:_0xc7ca6e,page:page=0x1,size:size=0xa}=_0x2d92ea,[_0x494455,_0x24b3b2]=await this[_0x1eecde(0x99)][_0x1eecde(0xf0)]({'where':{'userId':_0x97f63d,'appId':_0xc7ca6e,'role':_0x1eecde(0xf7)},'order':{'id':_0x1eecde(0xaf)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x494455,'count':_0x24b3b2};}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x334754(0xe0)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x334754(0xe0)])(user_entity_1[_0x334754(0xd9)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1['ChatGroupEntity'])),__metadata(_0x334754(0xe6),[typeorm_2[_0x334754(0xd6)],typeorm_2['Repository'],typeorm_2['Repository']])],ChatLogService),exports['ChatLogService']=ChatLogService;