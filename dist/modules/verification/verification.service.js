'use strict';const _0xe01597=_0x47b1;(function(_0x104f10,_0x35f7fb){const _0x50fdc3=_0x47b1,_0x17aabf=_0x104f10();while(!![]){try{const _0x1a7c50=parseInt(_0x50fdc3(0x180))/0x1+parseInt(_0x50fdc3(0x186))/0x2+parseInt(_0x50fdc3(0x1a9))/0x3*(parseInt(_0x50fdc3(0x19f))/0x4)+-parseInt(_0x50fdc3(0x1c0))/0x5+parseInt(_0x50fdc3(0x17a))/0x6+parseInt(_0x50fdc3(0x1a5))/0x7*(-parseInt(_0x50fdc3(0x19b))/0x8)+-parseInt(_0x50fdc3(0x1b2))/0x9;if(_0x1a7c50===_0x35f7fb)break;else _0x17aabf['push'](_0x17aabf['shift']());}catch(_0x3b9c14){_0x17aabf['push'](_0x17aabf['shift']());}}}(_0x17a4,0x9917a));function _0x17a4(){const _0x2fe1c4=['smsBaoPassword','Message','SendSms','短信发送成功','USED','createHash','176320pXtzuK','https://api.smsbao.com/sms?','decorate','now','128pqrZLg','getPhoneVerifyConfig','data','账户不存在','IP地址限制','getNamespace','161MRXUUb','verifycationEntity','__decorate','参数不全','113115FoZIiU','确实必要参数错误！','账户已过期','design:paramtypes','VerificationUseStatusEnum','@nestjs/common','createVerification','VerificationService','\x20，该验证码5分钟内有效，请勿泄露于他人。','10825884WWpjZt','length','verifyCode','S内不得重新发送','__param','sendSMS','您的验证码为\x20','密码错误','验证码发送失败！','save','Code','createdAt','md5','request','3235835LanBxk','axios','内容含有敏感字','../redisCache/redisCache.service','VerifycationEntity','code','default','getOwnPropertyDescriptor','@alicloud/pop-core','object','stringify','__metadata','metadata','createRandomCode','hex','HttpException','digest','1473678inmHRv','./../../common/constants/status.constant','__esModule','ceil','BAD_REQUEST','redisCacheService','1118776DlFXep','当前验证码已被使用！','服务器空间不支持','querystring','expiresAt','2017-05-25','826160YSvEuo','DESC','update','验证码已过期','globalConfigService','getTime','HttpStatus','get','POST','typeorm','RedisCacheService','function','log','findOne','getConfigs'];_0x17a4=function(){return _0x2fe1c4;};return _0x17a4();}var __decorate=this&&this[_0xe01597(0x1a7)]||function(_0x34d1b4,_0x40eaad,_0x42714b,_0x2f0f62){const _0x2016b7=_0xe01597;var _0xb5a176=arguments[_0x2016b7(0x1b3)],_0x3ee0fe=_0xb5a176<0x3?_0x40eaad:_0x2f0f62===null?_0x2f0f62=Object[_0x2016b7(0x1c7)](_0x40eaad,_0x42714b):_0x2f0f62,_0x40e1fc;if(typeof Reflect===_0x2016b7(0x1c9)&&typeof Reflect[_0x2016b7(0x19d)]===_0x2016b7(0x191))_0x3ee0fe=Reflect['decorate'](_0x34d1b4,_0x40eaad,_0x42714b,_0x2f0f62);else{for(var _0x2903c6=_0x34d1b4['length']-0x1;_0x2903c6>=0x0;_0x2903c6--)if(_0x40e1fc=_0x34d1b4[_0x2903c6])_0x3ee0fe=(_0xb5a176<0x3?_0x40e1fc(_0x3ee0fe):_0xb5a176>0x3?_0x40e1fc(_0x40eaad,_0x42714b,_0x3ee0fe):_0x40e1fc(_0x40eaad,_0x42714b))||_0x3ee0fe;}return _0xb5a176>0x3&&_0x3ee0fe&&Object['defineProperty'](_0x40eaad,_0x42714b,_0x3ee0fe),_0x3ee0fe;},__metadata=this&&this[_0xe01597(0x1cb)]||function(_0x5eac8f,_0x4ac218){const _0x16a6fc=_0xe01597;if(typeof Reflect===_0x16a6fc(0x1c9)&&typeof Reflect[_0x16a6fc(0x1cc)]===_0x16a6fc(0x191))return Reflect[_0x16a6fc(0x1cc)](_0x5eac8f,_0x4ac218);},__param=this&&this[_0xe01597(0x1b6)]||function(_0x5160eb,_0x442d60){return function(_0x4413cb,_0x1c3b0e){_0x442d60(_0x4413cb,_0x1c3b0e,_0x5160eb);};};Object['defineProperty'](exports,_0xe01597(0x17c),{'value':!![]}),exports[_0xe01597(0x1b0)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),status_constant_1=require(_0xe01597(0x17b)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0xe01597(0x18f)),verifycation_entity_1=require('./verifycation.entity'),common_1=require(_0xe01597(0x1ae)),utils_1=require('../../common/utils'),redisCache_service_1=require(_0xe01597(0x1c3)),crypto=require('crypto'),Core=require(_0xe01597(0x1c8)),axios_1=require(_0xe01597(0x1c1)),querystring=require(_0xe01597(0x183));function _0x47b1(_0x53265e,_0x56460c){const _0x17a4b8=_0x17a4();return _0x47b1=function(_0x47b1c1,_0x3ee9cd){_0x47b1c1=_0x47b1c1-0x176;let _0x58f616=_0x17a4b8[_0x47b1c1];return _0x58f616;},_0x47b1(_0x53265e,_0x56460c);}let VerificationService=class VerificationService{constructor(_0xa59147,_0x5c8d2e,_0x4ee360){const _0x1e1398=_0xe01597;this[_0x1e1398(0x1a6)]=_0xa59147,this['globalConfigService']=_0x5c8d2e,this[_0x1e1398(0x17f)]=_0x4ee360;}async[_0xe01597(0x1af)](_0x3fd533,_0x3b8211,_0x2889b7=0x1e*0x3c){const _0x2daddf=_0xe01597,_0x4e1e1b=await this['verifycationEntity'][_0x2daddf(0x193)]({'where':{'userId':_0x3fd533['id'],'type':_0x3b8211},'order':{'createdAt':_0x2daddf(0x187)}});if(_0x4e1e1b&&_0x4e1e1b['createdAt']['getTime']()+0x1*0x3c*0x3e8>Date['now']()){const _0x433e3f=Math[_0x2daddf(0x17d)]((_0x4e1e1b[_0x2daddf(0x1bd)][_0x2daddf(0x18b)]()+0x1*0x3c*0x3e8-Date[_0x2daddf(0x19e)]())/0x3e8);throw new common_1['HttpException'](_0x433e3f+_0x2daddf(0x1b5),common_1[_0x2daddf(0x18c)][_0x2daddf(0x17e)]);}const _0x451501=(0x0,utils_1[_0x2daddf(0x176)])(),_0x5952a8=new Date(Date['now']()+_0x2889b7*0x3e8),{id:_0x361201,email:_0x46e1ba}=_0x3fd533,_0x449621={'userId':_0x361201,'type':_0x3b8211,'code':_0x451501,'expiresAt':_0x5952a8,'email':_0x46e1ba};return await this[_0x2daddf(0x1a6)][_0x2daddf(0x1bb)](_0x449621);}async[_0xe01597(0x1b4)]({code:_0x1b9bbe,id:_0x4e78aa},_0x1880bc){const _0xee3880=_0xe01597,_0x1b7d58=await this[_0xee3880(0x1a6)][_0xee3880(0x193)]({'where':{'id':_0x4e78aa,'type':_0x1880bc},'order':{'createdAt':_0xee3880(0x187)}});if(!_0x1b7d58)throw new common_1[(_0xee3880(0x178))]('验证码不存在',common_1['HttpStatus'][_0xee3880(0x17e)]);if(_0x1b7d58['used']===status_constant_1['VerificationUseStatusEnum'][_0xee3880(0x199)])throw new common_1[(_0xee3880(0x178))](_0xee3880(0x181),common_1[_0xee3880(0x18c)][_0xee3880(0x17e)]);else _0x1b7d58['used']=status_constant_1[_0xee3880(0x1ad)][_0xee3880(0x199)],await this[_0xee3880(0x1a6)][_0xee3880(0x188)]({'id':_0x4e78aa},_0x1b7d58);if(Number(_0x1b7d58[_0xee3880(0x1c5)])!==Number(_0x1b9bbe))throw new common_1[(_0xee3880(0x178))]('验证码错误',common_1['HttpStatus']['BAD_REQUEST']);if(_0x1b7d58[_0xee3880(0x184)]<new Date())throw new common_1[(_0xee3880(0x178))](_0xee3880(0x189),common_1[_0xee3880(0x18c)][_0xee3880(0x17e)]);return _0x1b7d58;}async['verifyCaptcha'](_0x443539){const _0x14bab3=_0xe01597,{captchaId:_0xd1dfca,captchaCode:_0x30cac7}=_0x443539,_0x504f3e=await this['globalConfigService'][_0x14bab3(0x1a4)](),_0x41bd00=_0x504f3e+':CAPTCHA:'+_0xd1dfca,_0x65d788=await this[_0x14bab3(0x17f)][_0x14bab3(0x18d)]({'key':_0x41bd00});await this[_0x14bab3(0x17f)]['del']({'key':_0x41bd00});if(!_0x65d788)throw new common_1['HttpException']('图形验证码已过期、请重新输入!',common_1[_0x14bab3(0x18c)]['BAD_REQUEST']);if(!_0x65d788||_0x65d788!==_0x30cac7)throw new common_1[(_0x14bab3(0x178))]('图形验证码错误、请检查填写!',common_1[_0x14bab3(0x18c)][_0x14bab3(0x17e)]);}async['sendPhoneCode'](_0x2abb61){const _0x9f433b=_0xe01597;var _0x4ac156;const {accessKeyId:_0x5baced,accessKeySecret:_0x5985da,SignName:_0x18e035,TemplateCode:_0x8be2fc}=await this['globalConfigService'][_0x9f433b(0x1a0)](),{phone:_0x3742a0,code:_0x408620}=_0x2abb61;if(!_0x3742a0||!_0x408620)throw new common_1[(_0x9f433b(0x178))](_0x9f433b(0x1aa),common_1[_0x9f433b(0x18c)][_0x9f433b(0x17e)]);const _0x2a7c78=new Core({'accessKeyId':_0x5baced,'accessKeySecret':_0x5985da,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x9f433b(0x185)}),_0x4d950d={'PhoneNumbers':_0x3742a0,'SignName':_0x18e035,'TemplateCode':_0x8be2fc,'TemplateParam':JSON['stringify']({'code':_0x408620})},_0x2f4d94={'method':_0x9f433b(0x18e),'formatParams':![]};try{const _0x16a7dc=await _0x2a7c78[_0x9f433b(0x1bf)](_0x9f433b(0x197),_0x4d950d,_0x2f4d94);if(_0x16a7dc[_0x9f433b(0x1bc)]==='OK')return!![];else throw new common_1[(_0x9f433b(0x178))](_0x16a7dc[_0x9f433b(0x196)]||'验证码发送失败！',common_1[_0x9f433b(0x18c)][_0x9f433b(0x17e)]);}catch(_0x46a553){throw new common_1[(_0x9f433b(0x178))](((_0x4ac156=_0x46a553===null||_0x46a553===void 0x0?void 0x0:_0x46a553[_0x9f433b(0x1a1)])===null||_0x4ac156===void 0x0?void 0x0:_0x4ac156[_0x9f433b(0x196)])||_0x9f433b(0x1ba),common_1[_0x9f433b(0x18c)][_0x9f433b(0x17e)]);}}async[_0xe01597(0x1b7)](_0x5ab18a){const _0x49c45a=_0xe01597;try{const {smsBaoPassword:_0x55af98,smsBaoUser:_0x244c6a}=await this[_0x49c45a(0x18a)][_0x49c45a(0x194)](['smsBaoUser',_0x49c45a(0x195)]),{phone:_0x2e0095,code:_0x113038}=_0x5ab18a,_0x468f6f=crypto[_0x49c45a(0x19a)](_0x49c45a(0x1be)),_0x1e8b45=_0x468f6f[_0x49c45a(0x188)](_0x55af98)[_0x49c45a(0x179)](_0x49c45a(0x177)),_0x2f88f8=_0x49c45a(0x1b8)+_0x113038+_0x49c45a(0x1b1),_0x29b171=querystring[_0x49c45a(0x1ca)]({'u':_0x244c6a,'p':_0x1e8b45,'m':_0x2e0095,'c':_0x2f88f8}),_0x526b89=_0x49c45a(0x19c)+_0x29b171,_0x54cb5c=await axios_1[_0x49c45a(0x1c6)][_0x49c45a(0x18d)](_0x526b89),_0x1f62f1=_0x54cb5c[_0x49c45a(0x1a1)];if(_0x1f62f1==0x0)return!![];else{const _0x254503={'0':_0x49c45a(0x198),'-1':_0x49c45a(0x1a8),'-2':_0x49c45a(0x182),'30':_0x49c45a(0x1b9),'40':_0x49c45a(0x1a2),'41':'余额不足','42':_0x49c45a(0x1ab),'43':_0x49c45a(0x1a3),'50':_0x49c45a(0x1c2)};throw new common_1[(_0x49c45a(0x178))](_0x254503[_0x1f62f1]||_0x49c45a(0x1ba),common_1[_0x49c45a(0x18c)][_0x49c45a(0x17e)]);}}catch(_0x51162c){console[_0x49c45a(0x192)](_0x51162c);throw new common_1['HttpException']((_0x51162c===null||_0x51162c===void 0x0?void 0x0:_0x51162c[_0x49c45a(0x1a1)])||_0x49c45a(0x1ba),common_1[_0x49c45a(0x18c)]['BAD_REQUEST']);}}};VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(verifycation_entity_1[_0xe01597(0x1c4)])),__metadata(_0xe01597(0x1ac),[typeorm_2['Repository'],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0xe01597(0x190)]])],VerificationService),exports[_0xe01597(0x1b0)]=VerificationService;