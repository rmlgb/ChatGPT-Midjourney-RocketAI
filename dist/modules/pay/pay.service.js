'use strict';const _0x1b5332=_0x4d95;(function(_0x410155,_0x46aadb){const _0x4da579=_0x4d95,_0x14c643=_0x410155();while(!![]){try{const _0x2f46bc=parseInt(_0x4da579(0x22e))/0x1+-parseInt(_0x4da579(0x1cf))/0x2*(-parseInt(_0x4da579(0x20d))/0x3)+parseInt(_0x4da579(0x1b4))/0x4+parseInt(_0x4da579(0x1e1))/0x5+-parseInt(_0x4da579(0x206))/0x6+-parseInt(_0x4da579(0x1b0))/0x7+parseInt(_0x4da579(0x215))/0x8*(-parseInt(_0x4da579(0x1f7))/0x9);if(_0x2f46bc===_0x46aadb)break;else _0x14c643['push'](_0x14c643['shift']());}catch(_0x3795b7){_0x14c643['push'](_0x14c643['shift']());}}}(_0x280c,0x2eb87));function _0x280c(){const _0x1efd21=['本次支付类型:\x20','payWeChatSecret','nonce_str','__decorate','notifyEpay','appid','1602769txoYKO','affected','订单不存在!','CramiPackageEntity','904000JCLntj','__metadata','device','payMpayNotifyUrl','hupi','../order/order.entity','orderEntity','decorate','payHupiNotifyUrl','wechatpay-node-v3','map','includes','微信H5支付失败！','TRANSACTION.SUCCESS','money','payMpay','toString','status:\x20','payEpaySecret','payWeChat','payHupiSecret','native','failed','HttpException','findOne','time','default','2746NhUkRT','toFixed','digest','cramiPackageEntity','trade_order_id','payWeChatAppId','../crami/cramiPackage.entity','WxPay','queryWeChat','Repository','decipher_gcm','object','defineProperty','length','h5_info','name','../../common/utils','mpay','1168465ScVeuJ','payEpayReturnUrl','payWeChatPublicKey','payWeChatMchId','createHash','userBalanceService','errRaw','hash','query','axios','version','../globalConfig/globalConfig.service','param','queryHupi','支付请求失败!','addBalanceToOrder','globalConfigService','update','PayService','payMpayApiPayUrl','sign_type','order_no','71109BvOmQv','md5','getConfigs','event_type','post','total','epay','now','payMpaySecret','支付通知验证失败:\x20','微信支付通知params:\x20','log','typeorm','payWeChatNotifyUrl','getOpenIdByUserId','1289988gfXfdk','crypto','notifyHupi','jsapi支付结果返回值:\x20','attach','MD5','key','366nTgHxx','payPlatform','response','act','payEpay','data','sign','1.1','136OedYur','payHupiAppId','out_trade_order','join','metadata','payEpayNotifyUrl','payer','hex','校验签名','payWeChatH5Url','pay','payMpayPid','resource','userService','unsupported\x20pay\x20type','payEpayApiQueryUrl','sort','error:\x20','type','return_url','wx-native','TRADE_SUCCESS','epay\x20--->\x20res:\x20','校验签名通过','https://api.xunhupay.com/payment/do.html','142450aWEnji','trade_status','notifyWeChat','createRandomNonceStr','get','wechat','InjectRepository','192.168.1.100','../user/user.service','out_trade_no','BAD_REQUEST','alipay','Injectable','getOwnPropertyDescriptor','GlobalConfigService','design:paramtypes','status','套餐不存在!','payMpayReturnUrl','payEpayPid','UserService','success','payHupi','queryMpay','payType:\x20','payHupiGatewayUrl','wxpay','total_fee','payWeChatPrivateKey','pid','transactions_h5','HttpStatus','OrderEntity','goodsId','keys','payMpayApiQueryUrl','function','用户openId:\x20','notify_url','支付请求失败:\x20','scene_info'];_0x280c=function(){return _0x1efd21;};return _0x280c();}var __decorate=this&&this[_0x1b5332(0x1ad)]||function(_0x414e06,_0x4fb41d,_0x4ab33e,_0x3721c2){const _0x2065de=_0x1b5332;var _0x5b6998=arguments['length'],_0x5cdd41=_0x5b6998<0x3?_0x4fb41d:_0x3721c2===null?_0x3721c2=Object[_0x2065de(0x23b)](_0x4fb41d,_0x4ab33e):_0x3721c2,_0xceb2e8;if(typeof Reflect==='object'&&typeof Reflect[_0x2065de(0x1bb)]===_0x2065de(0x252))_0x5cdd41=Reflect['decorate'](_0x414e06,_0x4fb41d,_0x4ab33e,_0x3721c2);else{for(var _0x3aacf6=_0x414e06[_0x2065de(0x1dc)]-0x1;_0x3aacf6>=0x0;_0x3aacf6--)if(_0xceb2e8=_0x414e06[_0x3aacf6])_0x5cdd41=(_0x5b6998<0x3?_0xceb2e8(_0x5cdd41):_0x5b6998>0x3?_0xceb2e8(_0x4fb41d,_0x4ab33e,_0x5cdd41):_0xceb2e8(_0x4fb41d,_0x4ab33e))||_0x5cdd41;}return _0x5b6998>0x3&&_0x5cdd41&&Object[_0x2065de(0x1db)](_0x4fb41d,_0x4ab33e,_0x5cdd41),_0x5cdd41;},__metadata=this&&this[_0x1b5332(0x1b5)]||function(_0x2016b3,_0x5634a7){const _0x156d59=_0x1b5332;if(typeof Reflect===_0x156d59(0x1da)&&typeof Reflect[_0x156d59(0x219)]==='function')return Reflect[_0x156d59(0x219)](_0x2016b3,_0x5634a7);},__param=this&&this['__param']||function(_0x252db2,_0x41e93b){return function(_0x342ebc,_0x208ef2){_0x41e93b(_0x342ebc,_0x208ef2,_0x252db2);};};Object[_0x1b5332(0x1db)](exports,'__esModule',{'value':!![]}),exports[_0x1b5332(0x1f3)]=void 0x0;function _0x4d95(_0x78960b,_0x40ec1f){const _0x280c86=_0x280c();return _0x4d95=function(_0x4d9548,_0x1b1078){_0x4d9548=_0x4d9548-0x1ac;let _0x4b1a4e=_0x280c86[_0x4d9548];return _0x4b1a4e;},_0x4d95(_0x78960b,_0x40ec1f);}const typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x1b5332(0x203)),common_1=require('@nestjs/common'),crypto=require(_0x1b5332(0x207)),axios_1=require(_0x1b5332(0x1ea)),order_entity_1=require(_0x1b5332(0x1b9)),cramiPackage_entity_1=require(_0x1b5332(0x1d5)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require(_0x1b5332(0x1ec)),utils_1=require(_0x1b5332(0x1df)),user_service_1=require(_0x1b5332(0x236));let PayService=class PayService{constructor(_0x2892cb,_0x8bc94,_0x21c8c5,_0x2f711e,_0x121998){const _0x4f4417=_0x1b5332;this['cramiPackageEntity']=_0x2892cb,this['orderEntity']=_0x8bc94,this['userBalanceService']=_0x21c8c5,this[_0x4f4417(0x1f1)]=_0x2f711e,this[_0x4f4417(0x222)]=_0x121998;}async['onModuleInit'](){const _0x28dab6=_0x1b5332,_0xa260f1=await(0x0,utils_1['importDynamic'])(_0x28dab6(0x1bd));this[_0x28dab6(0x1d6)]=(_0xa260f1===null||_0xa260f1===void 0x0?void 0x0:_0xa260f1[_0x28dab6(0x1ce)])?_0xa260f1['default']:_0xa260f1;}async['notify'](_0x471b9f){const _0x441f53=_0x1b5332;if(_0x471b9f['param']==_0x441f53(0x1fd))return this[_0x441f53(0x1ae)](_0x471b9f);if(_0x471b9f['attach']=='hupi')return this[_0x441f53(0x208)](_0x471b9f);if(typeof _0x471b9f['resource']=='object')return this[_0x441f53(0x230)](_0x471b9f);return this['notifyMpay'](_0x471b9f);}async[_0x1b5332(0x21f)](_0x288a40,_0x472639,_0x324fce=_0x1b5332(0x248)){const _0x4e6205=_0x1b5332,_0x4dd879=await this[_0x4e6205(0x1ba)][_0x4e6205(0x1cc)]({'where':{'userId':_0x288a40,'orderId':_0x472639}});if(!_0x4dd879)throw new common_1[(_0x4e6205(0x1cb))]('订单不存在!',common_1['HttpStatus'][_0x4e6205(0x238)]);const _0x1a748e=await this[_0x4e6205(0x1d2)][_0x4e6205(0x1cc)]({'where':{'id':_0x4dd879[_0x4e6205(0x24f)]}});if(!_0x1a748e)throw new common_1[(_0x4e6205(0x1cb))]('套餐不存在!',common_1[_0x4e6205(0x24d)][_0x4e6205(0x238)]);console[_0x4e6205(0x202)](_0x4e6205(0x257),_0x4dd879[_0x4e6205(0x20e)]);try{if(_0x4dd879[_0x4e6205(0x20e)]==_0x4e6205(0x233))return this[_0x4e6205(0x1c7)](_0x288a40,_0x472639,_0x324fce);if(_0x4dd879[_0x4e6205(0x20e)]==_0x4e6205(0x1fd))return this['payEpay'](_0x288a40,_0x472639,_0x324fce);if(_0x4dd879['payPlatform']==_0x4e6205(0x1e0))return this[_0x4e6205(0x1c3)](_0x288a40,_0x472639,_0x324fce);if(_0x4dd879[_0x4e6205(0x20e)]=='hupi')return this[_0x4e6205(0x244)](_0x288a40,_0x472639,_0x324fce);}catch(_0x58a2f6){console[_0x4e6205(0x202)](_0x4e6205(0x255),_0x58a2f6);throw new common_1['HttpException'](_0x4e6205(0x1ef),common_1[_0x4e6205(0x24d)][_0x4e6205(0x238)]);}}async[_0x1b5332(0x1e9)](_0x18cf5b){const _0xa387b5=_0x1b5332,_0x5eac13=await this['orderEntity'][_0xa387b5(0x1cc)]({'where':{'orderId':_0x18cf5b}});if(!_0x5eac13)throw new common_1[(_0xa387b5(0x1cb))](_0xa387b5(0x1b2),common_1['HttpStatus'][_0xa387b5(0x238)]);return _0x5eac13;}async[_0x1b5332(0x208)](_0x3d0a66){const _0x4ef4d2=_0x1b5332,_0x2e33c4=await this[_0x4ef4d2(0x1f1)][_0x4ef4d2(0x1f9)]([_0x4ef4d2(0x1c8)]),_0x40171b=_0x3d0a66[_0x4ef4d2(0x1e8)];delete _0x3d0a66[_0x4ef4d2(0x1e8)];if(this['sign'](_0x3d0a66,_0x2e33c4)!=_0x40171b)return'failed';const _0x4e2757=await this[_0x4ef4d2(0x1ba)][_0x4ef4d2(0x1cc)]({'where':{'orderId':_0x3d0a66['trade_order_id'],'status':0x0}});if(!_0x4e2757)return _0x4ef4d2(0x1ca);await this[_0x4ef4d2(0x1e6)]['addBalanceToOrder'](_0x4e2757);const _0xc2462=await this[_0x4ef4d2(0x1ba)][_0x4ef4d2(0x1f2)]({'orderId':_0x3d0a66[_0x4ef4d2(0x1d3)]},{'status':0x1,'paydAt':new Date()});if(_0xc2462[_0x4ef4d2(0x1b1)]!=0x1)return _0x4ef4d2(0x1ca);return _0x4ef4d2(0x243);}async[_0x1b5332(0x244)](_0x32827f,_0xc3bc12,_0x24c6c0=_0x1b5332(0x248)){const _0x5f5748=_0x1b5332,_0x447742=await this[_0x5f5748(0x1ba)]['findOne']({'where':{'userId':_0x32827f,'orderId':_0xc3bc12}});if(!_0x447742)throw new common_1[(_0x5f5748(0x1cb))](_0x5f5748(0x1b2),common_1['HttpStatus'][_0x5f5748(0x238)]);const _0x1db63f=await this[_0x5f5748(0x1d2)][_0x5f5748(0x1cc)]({'where':{'id':_0x447742[_0x5f5748(0x24f)]}});if(!_0x1db63f)throw new common_1[(_0x5f5748(0x1cb))](_0x5f5748(0x23f),common_1['HttpStatus']['BAD_REQUEST']);const {payHupiAppId:_0x5d30a2,payHupiSecret:_0xbd9da,payHupiNotifyUrl:_0x283fef,payHupiReturnUrl:_0xc45f80,payHupiGatewayUrl:_0x34b96c}=await this[_0x5f5748(0x1f1)][_0x5f5748(0x1f9)](['payHupiAppId',_0x5f5748(0x1c8),_0x5f5748(0x1bc),'payHupiReturnUrl',_0x5f5748(0x247)]),_0x44913d={};_0x44913d[_0x5f5748(0x1eb)]=_0x5f5748(0x214),_0x44913d['appid']=_0x5d30a2,_0x44913d[_0x5f5748(0x1cd)]=(Date[_0x5f5748(0x1fe)]()/0x3e8)[_0x5f5748(0x1d0)](0x0),_0x44913d[_0x5f5748(0x1ac)]=(0x0,utils_1[_0x5f5748(0x231)])(0x20),_0x44913d['trade_order_id']=_0xc3bc12,_0x44913d['title']=_0x1db63f[_0x5f5748(0x1de)],_0x44913d[_0x5f5748(0x249)]=_0x447742['total'],_0x44913d[_0x5f5748(0x254)]=_0x283fef,_0x44913d['return_url']=_0xc45f80,_0x44913d[_0x5f5748(0x20a)]=_0x5f5748(0x1b8),_0x44913d['hash']=this[_0x5f5748(0x213)](_0x44913d,_0xbd9da);const {data:{errcode:_0xca1363,errmsg:_0x4b7395,url_qrcode:_0x3d163e,url:_0x355005}}=await axios_1[_0x5f5748(0x1ce)][_0x5f5748(0x1fb)](_0x34b96c||_0x5f5748(0x22d),_0x44913d);if(_0xca1363!=0x0)throw new common_1[(_0x5f5748(0x1cb))](_0x4b7395,common_1[_0x5f5748(0x24d)][_0x5f5748(0x238)]);return{'url_qrcode':_0x3d163e,'url':_0x355005};}async[_0x1b5332(0x1ee)](_0x2a66d8){const _0x38d84c=_0x1b5332,{payHupiAppId:_0x207a33,payHupiSecret:_0x1839b2}=await this[_0x38d84c(0x1f1)][_0x38d84c(0x1f9)]([_0x38d84c(0x216),'payHupiSecret']),_0x565e84={};_0x565e84[_0x38d84c(0x1eb)]=_0x38d84c(0x214),_0x565e84[_0x38d84c(0x1af)]=_0x207a33,_0x565e84[_0x38d84c(0x1cd)]=(Date[_0x38d84c(0x1fe)]()/0x3e8)[_0x38d84c(0x1d0)](0x0),_0x565e84[_0x38d84c(0x1ac)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x565e84[_0x38d84c(0x217)]=_0x2a66d8,_0x565e84[_0x38d84c(0x1e8)]=this[_0x38d84c(0x213)](_0x565e84,_0x1839b2);const {data:{errcode:_0x460bae,errmsg:_0x816eef,data:_0x113113}}=await axios_1['default']['post']('https://api.xunhupay.com/payment/query.html',_0x565e84);if(_0x460bae!=0x0)throw new common_1[(_0x38d84c(0x1cb))](_0x816eef,common_1[_0x38d84c(0x24d)][_0x38d84c(0x238)]);return _0x113113;}async[_0x1b5332(0x1ae)](_0x2f8e00){const _0x6d2c5f=_0x1b5332,_0x4f2396=_0x2f8e00[_0x6d2c5f(0x213)];delete _0x2f8e00[_0x6d2c5f(0x213)],delete _0x2f8e00[_0x6d2c5f(0x1f5)];const _0x3c9e9d=await this[_0x6d2c5f(0x1f1)][_0x6d2c5f(0x1f9)]([_0x6d2c5f(0x1c6)]);if(this[_0x6d2c5f(0x213)](_0x2f8e00,_0x3c9e9d)!=_0x4f2396)return _0x6d2c5f(0x1ca);console[_0x6d2c5f(0x202)](_0x6d2c5f(0x22c));const _0x2f1ba2=await this['orderEntity'][_0x6d2c5f(0x1cc)]({'where':{'orderId':_0x2f8e00['out_trade_no'],'status':0x0}});if(!_0x2f1ba2)return _0x6d2c5f(0x1ca);const _0x1260b3=_0x2f8e00[_0x6d2c5f(0x22f)]==_0x6d2c5f(0x22a)?0x1:0x2,_0x10185a=await this[_0x6d2c5f(0x1ba)]['update']({'orderId':_0x2f8e00[_0x6d2c5f(0x237)]},{'status':_0x1260b3,'paydAt':new Date()});_0x1260b3===0x1&&await this[_0x6d2c5f(0x1e6)]['addBalanceToOrder'](_0x2f1ba2);if(_0x10185a[_0x6d2c5f(0x1b1)]!=0x1)return _0x6d2c5f(0x1ca);return _0x6d2c5f(0x243);}async[_0x1b5332(0x211)](_0x48803a,_0x59edff,_0x54afa9=_0x1b5332(0x239)){const _0x549151=_0x1b5332,_0x15ed2a=await this[_0x549151(0x1ba)]['findOne']({'where':{'userId':_0x48803a,'orderId':_0x59edff}});if(!_0x15ed2a)throw new common_1[(_0x549151(0x1cb))]('订单不存在!',common_1[_0x549151(0x24d)][_0x549151(0x238)]);const _0x50c632=await this[_0x549151(0x1d2)]['findOne']({'where':{'id':_0x15ed2a[_0x549151(0x24f)]}});if(!_0x50c632)throw new common_1[(_0x549151(0x1cb))]('套餐不存在!',common_1[_0x549151(0x24d)][_0x549151(0x238)]);const {payEpayPid:_0x52c277,payEpaySecret:_0x4f3a70,payEpayNotifyUrl:_0x2c8672,payEpayReturnUrl:_0x3872a5,payEpayApiPayUrl:_0x55607f}=await this[_0x549151(0x1f1)][_0x549151(0x1f9)](['payEpayPid',_0x549151(0x1c6),_0x549151(0x21a),_0x549151(0x1e2),'payEpayApiPayUrl']);let _0x5f41ad;_0x52c277['length']<=0x10?_0x5f41ad=Number(_0x52c277):_0x5f41ad=BigInt(_0x52c277);const _0x523b2d={};_0x523b2d[_0x549151(0x24b)]=_0x5f41ad,_0x523b2d[_0x549151(0x227)]=_0x54afa9,_0x523b2d['out_trade_no']=_0x59edff,_0x523b2d[_0x549151(0x1de)]=_0x50c632['name'],_0x523b2d[_0x549151(0x1c2)]=_0x15ed2a[_0x549151(0x1fc)],_0x523b2d['clientip']=_0x549151(0x235),_0x523b2d[_0x549151(0x1b6)]='pc',_0x523b2d['notify_url']=_0x2c8672,_0x523b2d[_0x549151(0x228)]=_0x3872a5,_0x523b2d[_0x549151(0x1ed)]=_0x549151(0x1fd),_0x523b2d[_0x549151(0x213)]=this[_0x549151(0x213)](_0x523b2d,_0x4f3a70),_0x523b2d[_0x549151(0x1f5)]=_0x549151(0x20b);const _0x4aea80=new URLSearchParams(_0x523b2d)[_0x549151(0x1c4)](),_0x90afa7=_0x55607f+'?'+_0x4aea80;if(_0x55607f[_0x549151(0x1bf)]('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x90afa7,'channel':_0x54afa9,'isRedirect':!![]};else{const _0x4d1814=await axios_1[_0x549151(0x1ce)]['get'](_0x55607f,{'params':_0x523b2d});console['log'](_0x549151(0x22b),_0x4d1814[_0x549151(0x212)]);const {data:{code:_0x2234ce,msg:_0x35b035,qrcode:_0x5e4142}}=_0x4d1814;if(_0x2234ce!=0x1)throw new common_1[(_0x549151(0x1cb))](_0x35b035,common_1[_0x549151(0x24d)]['BAD_REQUEST']);return{'url_qrcode':_0x5e4142,'redirectUrl':null,'channel':_0x54afa9,'isRedirect':![]};}}async['queryEpay'](_0x1edb25){const _0x1985f2=_0x1b5332,{payEpayPid:_0x569a29,payEpaySecret:_0x4e0ef2,payEpayApiQueryUrl:_0x16169a}=await this[_0x1985f2(0x1f1)][_0x1985f2(0x1f9)]([_0x1985f2(0x241),_0x1985f2(0x1c6),_0x1985f2(0x224)]),_0x587de5={};_0x587de5[_0x1985f2(0x210)]='order',_0x587de5[_0x1985f2(0x237)]=_0x1edb25,_0x587de5['pid']=_0x569a29,_0x587de5[_0x1985f2(0x20c)]=_0x4e0ef2;const {data:{code:_0x2ee4c7,msg:_0x1986fe,data:_0x118a45}}=await axios_1['default'][_0x1985f2(0x232)](_0x16169a,{'params':_0x587de5});if(_0x2ee4c7!=0x1)throw new common_1['HttpException'](_0x1986fe,common_1['HttpStatus']['BAD_REQUEST']);return _0x118a45;}async['notifyMpay'](_0x3c1cd0){const _0x5851d6=_0x1b5332,_0x3b3e94=_0x3c1cd0[_0x5851d6(0x213)];delete _0x3c1cd0[_0x5851d6(0x213)],delete _0x3c1cd0['sign_type'];const _0x4e61d6=await this[_0x5851d6(0x1f1)][_0x5851d6(0x1f9)]([_0x5851d6(0x1ff)]);console[_0x5851d6(0x202)](_0x5851d6(0x21d));if(this[_0x5851d6(0x213)](_0x3c1cd0,_0x4e61d6)!=_0x3b3e94)return _0x5851d6(0x1ca);console['log'](_0x5851d6(0x22c));const _0x3f5691=await this[_0x5851d6(0x1ba)][_0x5851d6(0x1cc)]({'where':{'orderId':_0x3c1cd0[_0x5851d6(0x237)],'status':0x0}});if(!_0x3f5691)return _0x5851d6(0x1ca);const _0x456195=_0x3c1cd0[_0x5851d6(0x22f)]=='TRADE_SUCCESS'?0x1:0x2;console[_0x5851d6(0x202)](_0x5851d6(0x1c5),_0x456195);const _0x46be16=await this[_0x5851d6(0x1ba)][_0x5851d6(0x1f2)]({'orderId':_0x3c1cd0[_0x5851d6(0x237)]},{'status':_0x456195,'paydAt':new Date()});_0x456195===0x1&&await this[_0x5851d6(0x1e6)]['addBalanceToOrder'](_0x3f5691);if(_0x46be16[_0x5851d6(0x1b1)]!=0x1)return _0x5851d6(0x1ca);return _0x5851d6(0x243);}async[_0x1b5332(0x1c3)](_0x481b1d,_0x365d42,_0x4aea4b=_0x1b5332(0x248)){const _0x3d97db=_0x1b5332,_0x52eb8a=await this[_0x3d97db(0x1ba)][_0x3d97db(0x1cc)]({'where':{'userId':_0x481b1d,'orderId':_0x365d42}});if(!_0x52eb8a)throw new common_1[(_0x3d97db(0x1cb))](_0x3d97db(0x1b2),common_1[_0x3d97db(0x24d)][_0x3d97db(0x238)]);const _0x170271=await this[_0x3d97db(0x1d2)][_0x3d97db(0x1cc)]({'where':{'id':_0x52eb8a[_0x3d97db(0x24f)]}});if(!_0x170271)throw new common_1[(_0x3d97db(0x1cb))](_0x3d97db(0x23f),common_1[_0x3d97db(0x24d)][_0x3d97db(0x238)]);const {payMpayPid:_0x434679,payMpaySecret:_0x12cb41,payMpayNotifyUrl:_0x138ed5,payMpayReturnUrl:_0x37915e,payMpayApiPayUrl:_0x1ba113}=await this[_0x3d97db(0x1f1)][_0x3d97db(0x1f9)]([_0x3d97db(0x220),_0x3d97db(0x1ff),_0x3d97db(0x1b7),_0x3d97db(0x240),_0x3d97db(0x1f4)]),_0xc9963a={};_0xc9963a['pid']=Number(_0x434679),_0xc9963a['type']=_0x4aea4b,_0xc9963a[_0x3d97db(0x237)]=_0x365d42,_0xc9963a[_0x3d97db(0x1de)]=_0x170271[_0x3d97db(0x1de)],_0xc9963a[_0x3d97db(0x1c2)]=_0x52eb8a[_0x3d97db(0x1fc)],_0xc9963a[_0x3d97db(0x254)]=_0x138ed5,_0xc9963a[_0x3d97db(0x228)]=_0x37915e,_0xc9963a[_0x3d97db(0x213)]=this[_0x3d97db(0x213)](_0xc9963a,_0x12cb41),_0xc9963a[_0x3d97db(0x1f5)]='MD5';const _0x4aba14=new URLSearchParams(_0xc9963a)['toString'](),_0x3cce50=_0x1ba113+'?'+_0x4aba14;return{'url_qrcode':null,'redirectUrl':_0x3cce50,'channel':_0x4aea4b,'isRedirect':!![]};const _0x44b470=await axios_1['default'][_0x3d97db(0x232)](_0x1ba113,{'params':_0xc9963a});}async[_0x1b5332(0x245)](_0x59c92b){const _0x3a9325=_0x1b5332,{payMpayApiQueryUrl:_0x2cff37}=await this['globalConfigService']['getConfigs']([_0x3a9325(0x220),_0x3a9325(0x1ff),_0x3a9325(0x251)]),_0x1c6d16={};_0x1c6d16[_0x3a9325(0x227)]=0x2,_0x1c6d16[_0x3a9325(0x1f6)]=_0x59c92b;const {data:{code:_0x182db8,msg:_0x4d8b07,data:_0x14abef}}=await axios_1[_0x3a9325(0x1ce)][_0x3a9325(0x232)](_0x2cff37,{'params':_0x1c6d16});if(_0x182db8!=0x1)throw new common_1[(_0x3a9325(0x1cb))](_0x4d8b07,common_1['HttpStatus'][_0x3a9325(0x238)]);return _0x14abef;}async[_0x1b5332(0x230)](_0x19dfee){const _0x724e75=_0x1b5332;console[_0x724e75(0x202)](_0x724e75(0x201),_0x19dfee);const {payWeChatAppId:_0x3a3b1f,payWeChatMchId:_0xa20a62,payWeChatSecret:_0xcb505e,payWeChatPublicKey:_0xf10a7a,payWeChatPrivateKey:_0x3a85bc}=await this[_0x724e75(0x1f1)][_0x724e75(0x1f9)]([_0x724e75(0x1d4),'payWeChatMchId',_0x724e75(0x258),_0x724e75(0x1e3),_0x724e75(0x24a)]),_0x18fd18=new this[(_0x724e75(0x1d6))]({'appid':_0x3a3b1f,'mchid':_0xa20a62,'publicKey':_0xf10a7a,'privateKey':_0x3a85bc});try{if(_0x19dfee[_0x724e75(0x1fa)]==_0x724e75(0x1c1)){const {ciphertext:_0x46c029,associated_data:_0xda8bcb,nonce:_0x22e3cf}=_0x19dfee[_0x724e75(0x221)],_0x176ef1=_0x18fd18[_0x724e75(0x1d9)](_0x46c029,_0xda8bcb,_0x22e3cf,_0xcb505e),_0x12bbcf=await this[_0x724e75(0x1ba)][_0x724e75(0x1cc)]({'where':{'orderId':_0x176ef1[_0x724e75(0x237)],'status':0x0}});if(!_0x12bbcf)return _0x724e75(0x1ca);const _0xd9c9b1=_0x176ef1['trade_state']=='SUCCESS'?0x1:0x2,_0x197b03=await this[_0x724e75(0x1ba)]['update']({'orderId':_0x176ef1['out_trade_no']},{'status':_0xd9c9b1,'paydAt':new Date()});_0xd9c9b1===0x1&&await this[_0x724e75(0x1e6)][_0x724e75(0x1f0)](_0x12bbcf);if(_0x197b03[_0x724e75(0x1b1)]!=0x1)return _0x724e75(0x1ca);}return'success';}catch(_0x5af8bc){return console['log'](_0x724e75(0x226),_0x5af8bc),console[_0x724e75(0x202)](_0x724e75(0x200),_0x5af8bc),_0x724e75(0x1ca);}}async['payWeChat'](_0x4d13ac,_0x278f84,_0x39a55a=_0x1b5332(0x1c9)){const _0x5ac679=_0x1b5332;var _0x411715,_0x15ceb4,_0x1aa24f;console[_0x5ac679(0x202)](_0x5ac679(0x246),_0x39a55a);const _0x42115d=await this['orderEntity'][_0x5ac679(0x1cc)]({'where':{'userId':_0x4d13ac,'orderId':_0x278f84}});if(!_0x42115d)throw new common_1['HttpException'](_0x5ac679(0x1b2),common_1[_0x5ac679(0x24d)]['BAD_REQUEST']);const _0x42dda5=await this[_0x5ac679(0x1d2)][_0x5ac679(0x1cc)]({'where':{'id':_0x42115d[_0x5ac679(0x24f)]}});if(!_0x42dda5)throw new common_1['HttpException']('套餐不存在!',common_1[_0x5ac679(0x24d)][_0x5ac679(0x238)]);const {payWeChatAppId:_0x488e57,payWeChatMchId:_0x563670,payWeChatPublicKey:_0x46e19e,payWeChatPrivateKey:_0x4b7998,payWeChatNotifyUrl:_0x1579ee,payWeChatH5Name:_0x175e06,payWeChatH5Url:_0xd20766}=await this[_0x5ac679(0x1f1)][_0x5ac679(0x1f9)]([_0x5ac679(0x1d4),'payWeChatMchId',_0x5ac679(0x1e3),'payWeChatPrivateKey',_0x5ac679(0x204),'payWeChatH5Name',_0x5ac679(0x21e)]),_0x2ee525=new this[(_0x5ac679(0x1d6))]({'appid':_0x488e57,'mchid':_0x563670,'publicKey':_0x46e19e,'privateKey':_0x4b7998}),_0x3c0f1b={'appid':_0x488e57,'mchid':_0x563670,'description':_0x42dda5[_0x5ac679(0x1de)],'out_trade_no':_0x278f84,'notify_url':_0x1579ee,'amount':{'total':Number(_0x42115d[_0x5ac679(0x1fc)]*0x64)},'scene_info':{'payer_client_ip':_0x5ac679(0x235)}};console['log']('wechat-pay:\x20',_0x3c0f1b);if(_0x39a55a=='h5'){_0x3c0f1b[_0x5ac679(0x256)][_0x5ac679(0x1dd)]={'type':'Wap','app_name':_0x175e06,'app_url':_0xd20766};const _0x4e20f1=await _0x2ee525[_0x5ac679(0x24c)](_0x3c0f1b);if(_0x4e20f1[_0x5ac679(0x23e)]===0x193){const _0xb58105=(_0x1aa24f=(_0x15ceb4=(_0x411715=_0x4e20f1===null||_0x4e20f1===void 0x0?void 0x0:_0x4e20f1[_0x5ac679(0x1e7)])===null||_0x411715===void 0x0?void 0x0:_0x411715[_0x5ac679(0x20f)])===null||_0x15ceb4===void 0x0?void 0x0:_0x15ceb4['text'])===null||_0x1aa24f===void 0x0?void 0x0:_0x1aa24f['message'];throw new common_1[(_0x5ac679(0x1cb))]((_0x4e20f1===null||_0x4e20f1===void 0x0?void 0x0:_0x4e20f1['message'])||_0x5ac679(0x1c0),common_1[_0x5ac679(0x24d)][_0x5ac679(0x238)]);}const {h5_url:_0x51171c}=_0x4e20f1;return{'url':_0x51171c};}if(_0x39a55a=='jsapi'){const _0x32f5b1=await this[_0x5ac679(0x222)][_0x5ac679(0x205)](_0x4d13ac);console['log'](_0x5ac679(0x253),_0x32f5b1),_0x3c0f1b[_0x5ac679(0x21b)]={'openid':_0x32f5b1};const _0xef68cb=await _0x2ee525['transactions_jsapi'](_0x3c0f1b);return console[_0x5ac679(0x202)](_0x5ac679(0x209),_0xef68cb),_0xef68cb;}if(_0x39a55a=='native'){const _0x2d0e7f=await _0x2ee525['transactions_native'](_0x3c0f1b),{code_url:_0x43c501}=_0x2d0e7f;return!_0x43c501&&console[_0x5ac679(0x202)](_0x5ac679(0x229),_0x2d0e7f),{'url_qrcode':_0x43c501,'isRedirect':![]};}throw new common_1[(_0x5ac679(0x1cb))](_0x5ac679(0x223),common_1['HttpStatus'][_0x5ac679(0x238)]);}async[_0x1b5332(0x1d7)](_0x33a731){const _0x5a3762=_0x1b5332,{payWeChatAppId:_0x5ba3d8,payWeChatMchId:_0x4e8247,payWeChatPublicKey:_0xa2e40d,payWeChatPrivateKey:_0x5cd9a9,payWeChatNotifyUrl:_0x164402,payWeChatH5Name:_0x3ef08d,payWeChatH5Url:_0x4f5091}=await this[_0x5a3762(0x1f1)][_0x5a3762(0x1f9)]([_0x5a3762(0x1d4),_0x5a3762(0x1e4),_0x5a3762(0x1e3),'payWeChatPrivateKey']),_0x6511b3=new this['WxPay']({'appid':_0x5ba3d8,'mchid':_0x4e8247,'publicKey':_0xa2e40d,'privateKey':_0x5cd9a9}),_0x4516fb=await _0x6511b3[_0x5a3762(0x1e9)]({'out_trade_no':_0x33a731});return _0x4516fb;}['sign'](_0x4031ac,_0x5bd9b7){const _0xcf50c4=_0x1b5332,_0x41e2b9=Object[_0xcf50c4(0x250)](_0x4031ac)[_0xcf50c4(0x225)]()[_0xcf50c4(0x1be)](_0xa696e6=>_0xa696e6+'='+_0x4031ac[_0xa696e6])[_0xcf50c4(0x218)]('&')+_0x5bd9b7;return crypto[_0xcf50c4(0x1e5)](_0xcf50c4(0x1f8))[_0xcf50c4(0x1f2)](_0x41e2b9)[_0xcf50c4(0x1d1)](_0xcf50c4(0x21c));}};PayService=__decorate([(0x0,common_1[_0x1b5332(0x23a)])(),__param(0x0,(0x0,typeorm_1[_0x1b5332(0x234)])(cramiPackage_entity_1[_0x1b5332(0x1b3)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x1b5332(0x24e)])),__metadata(_0x1b5332(0x23d),[typeorm_2[_0x1b5332(0x1d8)],typeorm_2[_0x1b5332(0x1d8)],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x1b5332(0x23c)],user_service_1[_0x1b5332(0x242)]])],PayService),exports[_0x1b5332(0x1f3)]=PayService;