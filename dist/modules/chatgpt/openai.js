'use strict';function _0x57ed(){const _0x745d00=['@nestjs/common','201mZXkJt','../../common/utils','response','slice','Logger','stringify','2110lYtvJl','application/json','choices','defineProperty','stream','length','64683cHaJcV','POST','content','role','get_encoding','preview','log','parse','15yqVAIe','trim','sendMessageFromOpenAi\x20options:\x20','[DONE]','endsWith','parse\x20Error','detail','data','1251357HMoEci','https://api.openai.com','encode','2753574YLnCzV','toString','cl100k_base','24564VmFbry','includes','error','sendMessageFromOpenAi','sendMessageFromOpenAi\x20[DONE]\x20result:\x20','data:','default','removeSpecialCharacters','9862881ViDSys','stop','filter','@dqbd/tiktoken','axios','__esModule','debug','4178536Pipdqo','reduce','Bearer\x20','split','message','getTokenCount','end','1976602JXqVTF','text','string','gpt-4'];_0x57ed=function(){return _0x745d00;};return _0x57ed();}const _0x26cb74=_0x30e6;(function(_0x15452e,_0x27f6cd){const _0x45adc0=_0x30e6,_0x312046=_0x15452e();while(!![]){try{const _0x3f6909=parseInt(_0x45adc0(0xdd))/0x1+parseInt(_0x45adc0(0xbc))/0x2+-parseInt(_0x45adc0(0xc1))/0x3*(parseInt(_0x45adc0(0xe3))/0x4)+parseInt(_0x45adc0(0xd5))/0x5*(parseInt(_0x45adc0(0xe0))/0x6)+-parseInt(_0x45adc0(0xeb))/0x7+parseInt(_0x45adc0(0xf2))/0x8+-parseInt(_0x45adc0(0xcd))/0x9*(parseInt(_0x45adc0(0xc7))/0xa);if(_0x3f6909===_0x27f6cd)break;else _0x312046['push'](_0x312046['shift']());}catch(_0x5253ea){_0x312046['push'](_0x312046['shift']());}}}(_0x57ed,0xc3c53));Object[_0x26cb74(0xca)](exports,_0x26cb74(0xf0),{'value':!![]}),exports[_0x26cb74(0xba)]=exports[_0x26cb74(0xe6)]=void 0x0;const axios_1=require(_0x26cb74(0xef)),tiktoken_1=require(_0x26cb74(0xee)),utils_1=require(_0x26cb74(0xc2)),common_1=require(_0x26cb74(0xc0)),tokenizer=(0x0,tiktoken_1[_0x26cb74(0xd1)])(_0x26cb74(0xe2));function getFullUrl(_0x5c0e08){const _0x335c59=_0x26cb74,_0x2ecc70=_0x5c0e08[_0x335c59(0xd9)]('/')?_0x5c0e08[_0x335c59(0xc4)](0x0,-0x1):_0x5c0e08,_0x5e254c=_0x2ecc70||_0x335c59(0xde);return(''+_0x5e254c)['includes']('/v1/chat/completions')?''+_0x5e254c:_0x5e254c+'/v1/chat/completions';}function sendMessageFromOpenAi(_0x3fbd51,_0x5a6809){const _0x1e9155=_0x26cb74;var _0x75dd45;const {onProgress:_0x4b59f6,maxToken:_0x59ed40,apiKey:_0x23daeb,model:_0xd5a02e,temperature:temperature=0.95,proxyUrl:_0x3e4526}=_0x5a6809,_0x574b94=compilerToken(_0xd5a02e,_0x59ed40),_0x1cc0c9={'method':_0x1e9155(0xce),'url':getFullUrl(_0x3e4526),'responseType':_0x1e9155(0xcb),'headers':{'Content-Type':_0x1e9155(0xc8),'Authorization':_0x1e9155(0xf4)+(0x0,utils_1[_0x1e9155(0xea)])(_0x23daeb),'Accept':'application/json'},'data':{'max_tokens':_0x574b94,'stream':!![],'temperature':temperature,'model':_0xd5a02e,'messages':_0x3fbd51}},_0x213d14=(_0x75dd45=_0x3fbd51[_0x3fbd51['length']-0x1])===null||_0x75dd45===void 0x0?void 0x0:_0x75dd45[_0x1e9155(0xcf)];return common_1[_0x1e9155(0xc5)][_0x1e9155(0xf1)](_0x1e9155(0xd7)+JSON[_0x1e9155(0xc6)](_0x1cc0c9)),new Promise(async(_0x395324,_0x2f61d0)=>{const _0xbf940a=_0x1e9155;var _0x36f34a,_0x52282b;try{const _0x51ce31=await(0x0,axios_1[_0xbf940a(0xe9)])(_0x1cc0c9),_0xf13c2b=_0x51ce31['data'],_0x5d6fd9={'text':''};_0xf13c2b['on'](_0xbf940a(0xdc),_0x32f617=>{const _0x32028a=_0xbf940a;var _0x4a3c54;const _0x428c42=_0x32f617[_0x32028a(0xe1)]()[_0x32028a(0xf5)]('\x0a\x0a')[_0x32028a(0xed)](_0x20ae88=>_0x20ae88[_0x32028a(0xd6)]()!=='');for(const _0x16e174 of _0x428c42){const _0x19b02d=_0x16e174['replace'](_0x32028a(0xe8),'');let _0x442f72=![];try{_0x442f72=JSON['parse'](_0x19b02d)[_0x32028a(0xc9)][0x0]['finish_reason']===_0x32028a(0xec);}catch(_0x54e7e1){_0x442f72=![];}if(_0x19b02d===_0x32028a(0xd8)||_0x442f72)return _0x5d6fd9[_0x32028a(0xbd)]=_0x5d6fd9[_0x32028a(0xbd)][_0x32028a(0xd6)](),common_1[_0x32028a(0xc5)][_0x32028a(0xf1)](_0x32028a(0xe7)+_0x5d6fd9[_0x32028a(0xbd)]),_0x5d6fd9;try{const _0x437c20=JSON[_0x32028a(0xd4)](_0x19b02d);_0x437c20['id']&&(_0x5d6fd9['id']=_0x437c20['id']);if((_0x4a3c54=_0x437c20[_0x32028a(0xc9)])===null||_0x4a3c54===void 0x0?void 0x0:_0x4a3c54[_0x32028a(0xcc)]){const _0x481660=_0x437c20['choices'][0x0]['delta'];_0x5d6fd9['delta']=_0x481660[_0x32028a(0xcf)];if(_0x481660===null||_0x481660===void 0x0?void 0x0:_0x481660['content'])_0x5d6fd9[_0x32028a(0xbd)]+=_0x481660[_0x32028a(0xcf)];_0x481660[_0x32028a(0xd0)]&&(_0x5d6fd9[_0x32028a(0xd0)]=_0x481660[_0x32028a(0xd0)]),_0x5d6fd9[_0x32028a(0xdb)]=_0x437c20;}_0x4b59f6&&_0x4b59f6({'text':_0x5d6fd9['text']});}catch(_0x5570d2){console[_0x32028a(0xd3)](_0x32028a(0xda),_0x5570d2[_0x32028a(0xf6)]||_0x5570d2);}}}),_0xf13c2b['on'](_0xbf940a(0xbb),()=>{const _0x4f0c53=_0xbf940a;if(_0x5d6fd9[_0x4f0c53(0xdb)]&&_0x5d6fd9[_0x4f0c53(0xbd)]){const _0x5314c1=getTokenCount(_0x213d14),_0x1e89d3=getTokenCount(_0x5d6fd9[_0x4f0c53(0xbd)]);_0x5d6fd9['detail']['usage']={'prompt_tokens':_0x5314c1,'completion_tokens':_0x1e89d3,'total_tokens':_0x5314c1+_0x1e89d3,'estimated':!![]};}return _0x395324(_0x5d6fd9);});}catch(_0xab5e49){const _0x227299=((_0x52282b=(_0x36f34a=_0xab5e49[_0xbf940a(0xc3)])===null||_0x36f34a===void 0x0?void 0x0:_0x36f34a[_0xbf940a(0xdc)])===null||_0x52282b===void 0x0?void 0x0:_0x52282b[_0xbf940a(0xe5)])||_0xab5e49['message'];common_1[_0xbf940a(0xc5)]['error']('sendMessageFromOpenAi\x20error:\x20'+_0x227299),_0x2f61d0(_0xab5e49);}});}function _0x30e6(_0x30c94f,_0x492ea7){const _0x57ed99=_0x57ed();return _0x30e6=function(_0x30e6be,_0x59d7f0){_0x30e6be=_0x30e6be-0xba;let _0x32e13c=_0x57ed99[_0x30e6be];return _0x32e13c;},_0x30e6(_0x30c94f,_0x492ea7);}exports['sendMessageFromOpenAi']=sendMessageFromOpenAi;function getTokenCount(_0x1cf076){const _0x83b29b=_0x26cb74;let _0x2c4d3e='';if(Array['isArray'](_0x1cf076))_0x2c4d3e=_0x1cf076[_0x83b29b(0xf3)]((_0x184d65,_0x3b50fd)=>{const _0x39525f=_0x83b29b;return _0x184d65+=_0x3b50fd[_0x39525f(0xcf)];},'');else typeof _0x1cf076===_0x83b29b(0xbe)&&(_0x2c4d3e=_0x1cf076);if(!_0x2c4d3e)return 0x0;return _0x2c4d3e=_0x2c4d3e['replace'](/<\|endoftext\|>/g,''),tokenizer[_0x83b29b(0xdf)](_0x2c4d3e)['length'];}exports['getTokenCount']=getTokenCount;function compilerToken(_0x2be1bc,_0x1cc431){const _0x281d15=_0x26cb74;let _0x207464=0x0;return _0x2be1bc[_0x281d15(0xe4)](3.5)&&(_0x207464=_0x1cc431>0x1000?0x1000:_0x1cc431),_0x2be1bc['includes'](_0x281d15(0xbf))&&(_0x207464=_0x1cc431>0x2000?0x2000:_0x1cc431),_0x2be1bc['includes'](_0x281d15(0xd2))&&(_0x207464=_0x1cc431>0x1000?0x1000:_0x1cc431),_0x2be1bc[_0x281d15(0xe4)]('32k')&&(_0x207464=_0x1cc431>0x8000?0x8000:_0x1cc431),_0x207464;}