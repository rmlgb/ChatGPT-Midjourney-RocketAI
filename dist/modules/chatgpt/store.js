'use strict';function _0x3a63(_0x421aa6,_0x1bce9a){const _0x24b95f=_0x24b9();return _0x3a63=function(_0x3a63b9,_0x3652ea){_0x3a63b9=_0x3a63b9-0x1d2;let _0x198fa8=_0x24b95f[_0x3a63b9];return _0x198fa8;},_0x3a63(_0x421aa6,_0x1bce9a);}function _0x24b9(){const _0x19da5e=['system','max','get_encoding','store','，token长度','namespace','\x20停止','2VTIRec','\x20退出','reduce','concat','32Bdkpid','getData','本次携带上下文的长度','user','formatOptions','没有找到parentMessageId:','超出最大轮次限制','2913okmDGY','length','push','@nestjs/common','17925ebQiVe','398482UjlqAI','cl100k_base','replace','setData','51039ZEnEGP','3640043hqvVrX','expires','min','splice','set','slice','Logger','1080oOEPmy','11813016Cqpxtj','uuid','getUuid','content','debug','140IPIXkv','_recursivePruning','_getTokenCount','generateKey','697019gcOHfl','2180maahDC','RocKetStore'];_0x24b9=function(){return _0x19da5e;};return _0x24b9();}const _0x13ef72=_0x3a63;(function(_0x2bcd3e,_0x215cf9){const _0x5b259c=_0x3a63,_0x49c865=_0x2bcd3e();while(!![]){try{const _0x39e8ea=parseInt(_0x5b259c(0x1f8))/0x1*(-parseInt(_0x5b259c(0x1d2))/0x2)+parseInt(_0x5b259c(0x1dd))/0x3*(-parseInt(_0x5b259c(0x1f9))/0x4)+parseInt(_0x5b259c(0x1e1))/0x5*(parseInt(_0x5b259c(0x1ee))/0x6)+parseInt(_0x5b259c(0x1e2))/0x7*(parseInt(_0x5b259c(0x1d6))/0x8)+parseInt(_0x5b259c(0x1e6))/0x9*(parseInt(_0x5b259c(0x1f4))/0xa)+-parseInt(_0x5b259c(0x1e7))/0xb+parseInt(_0x5b259c(0x1ef))/0xc;if(_0x39e8ea===_0x215cf9)break;else _0x49c865['push'](_0x49c865['shift']());}catch(_0x2fda1){_0x49c865['push'](_0x49c865['shift']());}}}(_0x24b9,0x5cb29));Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x13ef72(0x1fa)]=void 0x0;const uuid_1=require(_0x13ef72(0x1f0)),tiktoken_1=require('@dqbd/tiktoken'),common_1=require(_0x13ef72(0x1e0)),tokenizer=(0x0,tiktoken_1[_0x13ef72(0x1fd)])(_0x13ef72(0x1e3));class RocKetStore{constructor(_0x1bcbca){const _0x303485=_0x13ef72,{store:_0x868caa,namespace:_0x3d95c3,expires:_0x144abe}=this[_0x303485(0x1da)](_0x1bcbca);this[_0x303485(0x1fe)]=_0x868caa,this[_0x303485(0x200)]=_0x3d95c3,this['expires']=_0x144abe;}[_0x13ef72(0x1da)](_0x3fea62){const {store:_0x3eec5c,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace='chat'}=_0x3fea62;return{'store':_0x3eec5c,'namespace':namespace,'expires':expires};}[_0x13ef72(0x1f7)](_0x548bce){const _0x430f2c=_0x13ef72;return this[_0x430f2c(0x200)]?this['namespace']+'-'+_0x548bce:_0x548bce;}async[_0x13ef72(0x1d7)](_0x2be093){const _0x4c5bbd=await this['store']['get'](_0x2be093);return _0x4c5bbd;}async[_0x13ef72(0x1e5)](_0x1ece61,_0x9ad1eb=this[_0x13ef72(0x1e8)]){const _0xe24bdb=_0x13ef72;await this[_0xe24bdb(0x1fe)][_0xe24bdb(0x1eb)](_0x1ece61['id'],_0x1ece61,_0x9ad1eb);}async['buildMessageFromParentMessageId'](_0x95e098,_0x124b18,_0x3b43a2){const _0x33818f=_0x13ef72,{maxRounds:_0x408f46,maxModelToken:_0x1db7c6,maxResponseTokens:_0x322334,systemMessage:systemMessage='',name:_0x2f46a3}=_0x124b18;let {parentMessageId:_0x392f1b}=_0x124b18;const _0x33bf5d=[];let _0x2bba9f=0x0;systemMessage&&_0x33bf5d[_0x33818f(0x1df)]({'role':_0x33818f(0x1fb),'content':systemMessage});const _0x21604f=_0x33bf5d[_0x33818f(0x1de)];let _0x3cc5c1=0x0,_0x2387bd=_0x95e098||_0x3b43a2?_0x33bf5d[_0x33818f(0x1d5)]([{'role':_0x33818f(0x1d9),'content':_0x95e098,'name':_0x2f46a3}]):_0x33bf5d;do{if(!_0x392f1b)break;const _0x3dff19=await this[_0x33818f(0x1d7)](_0x392f1b);if(!_0x3dff19){common_1[_0x33818f(0x1ed)][_0x33818f(0x1f3)](_0x33818f(0x1db)+_0x392f1b+_0x33818f(0x1d3));break;}const {text:_0x2e7da8,name:_0x5cbe03,role:_0x318e3c}=_0x3dff19;_0x2387bd=_0x2387bd[_0x33818f(0x1ec)](0x0,_0x21604f)['concat']([{'role':_0x318e3c,'content':_0x2e7da8,'name':_0x5cbe03},..._0x2387bd[_0x33818f(0x1ec)](_0x21604f)]),_0x3cc5c1++;if(_0x408f46&&_0x3cc5c1>=_0x408f46){common_1[_0x33818f(0x1ed)][_0x33818f(0x1f3)](_0x33818f(0x1dc)+_0x408f46+_0x33818f(0x201));break;}if(_0x1db7c6&&_0x322334){const _0x2f431d=_0x1db7c6-_0x322334;_0x2bba9f=await this[_0x33818f(0x1f6)](_0x2387bd);const _0x29cfb6=_0x2bba9f+0xc8<=_0x2f431d;!_0x29cfb6&&(_0x2387bd=this[_0x33818f(0x1f5)](_0x2387bd,_0x2f431d,systemMessage));}_0x392f1b=_0x3dff19['parentMessageId'];}while(!![]);const _0x190403=Math[_0x33818f(0x1fc)](0x1,Math[_0x33818f(0x1e9)](_0x1db7c6-_0x2bba9f,_0x322334));return common_1[_0x33818f(0x1ed)][_0x33818f(0x1f3)](_0x33818f(0x1d8)+_0x2387bd[_0x33818f(0x1de)]+_0x33818f(0x1ff)+_0x2bba9f),{'context':_0x2387bd,'round':_0x2387bd[_0x33818f(0x1de)],'historyToken':_0x2bba9f};}[_0x13ef72(0x1f6)](_0x2d1247){const _0x20a39b=_0x13ef72;let _0x46c4a9=_0x2d1247[_0x20a39b(0x1d4)]((_0x50408d,_0x2e9d1f)=>{const _0x65416c=_0x20a39b;return _0x50408d+=_0x2e9d1f[_0x65416c(0x1f2)];},'');if(!_0x46c4a9)return 0x0;return _0x46c4a9=_0x46c4a9[_0x20a39b(0x1e4)](/<\|endoftext\|>/g,''),tokenizer['encode'](_0x46c4a9)[_0x20a39b(0x1de)];}[_0x13ef72(0x1f5)](_0x1e1d00,_0x3ef8a0,_0x2aec69){const _0x20f35b=_0x13ef72,_0x556c7d=this['_getTokenCount'](_0x1e1d00);if(_0x556c7d<=_0x3ef8a0)return _0x1e1d00;return _0x1e1d00[_0x20f35b(0x1ea)](_0x2aec69?0x1:0x0,0x1),this[_0x20f35b(0x1f5)](_0x1e1d00,_0x3ef8a0,_0x2aec69);}[_0x13ef72(0x1f1)](){return(0x0,uuid_1['v4'])();}}exports[_0x13ef72(0x1fa)]=RocKetStore;