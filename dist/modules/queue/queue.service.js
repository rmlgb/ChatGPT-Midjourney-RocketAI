'use strict';const _0x12c8c8=_0x87ce;function _0x87ce(_0xc7b01d,_0x356b25){const _0x4d0954=_0x4d09();return _0x87ce=function(_0x87ce8c,_0x4c52b5){_0x87ce8c=_0x87ce8c-0xdd;let _0x800ad5=_0x4d0954[_0x87ce8c];return _0x800ad5;},_0x87ce(_0xc7b01d,_0x356b25);}(function(_0x107461,_0x2e5afd){const _0x35ffe5=_0x87ce,_0x5e5842=_0x107461();while(!![]){try{const _0x2b56cf=parseInt(_0x35ffe5(0x124))/0x1+-parseInt(_0x35ffe5(0xf1))/0x2+parseInt(_0x35ffe5(0xfc))/0x3*(parseInt(_0x35ffe5(0x112))/0x4)+parseInt(_0x35ffe5(0x115))/0x5*(parseInt(_0x35ffe5(0xeb))/0x6)+-parseInt(_0x35ffe5(0x122))/0x7*(-parseInt(_0x35ffe5(0x100))/0x8)+parseInt(_0x35ffe5(0x126))/0x9*(-parseInt(_0x35ffe5(0x108))/0xa)+-parseInt(_0x35ffe5(0xed))/0xb;if(_0x2b56cf===_0x2e5afd)break;else _0x5e5842['push'](_0x5e5842['shift']());}catch(_0x3a5bcd){_0x5e5842['push'](_0x5e5842['shift']());}}}(_0x4d09,0x2c7e7));var __decorate=this&&this[_0x12c8c8(0xf3)]||function(_0x40e9bc,_0x4fcb1f,_0x558252,_0x2cb666){const _0x52530f=_0x12c8c8;var _0xfd5d8f=arguments[_0x52530f(0x12a)],_0xd70175=_0xfd5d8f<0x3?_0x4fcb1f:_0x2cb666===null?_0x2cb666=Object[_0x52530f(0xe7)](_0x4fcb1f,_0x558252):_0x2cb666,_0x3e72b4;if(typeof Reflect===_0x52530f(0x11c)&&typeof Reflect[_0x52530f(0x117)]===_0x52530f(0xe4))_0xd70175=Reflect[_0x52530f(0x117)](_0x40e9bc,_0x4fcb1f,_0x558252,_0x2cb666);else{for(var _0x5c8dfb=_0x40e9bc[_0x52530f(0x12a)]-0x1;_0x5c8dfb>=0x0;_0x5c8dfb--)if(_0x3e72b4=_0x40e9bc[_0x5c8dfb])_0xd70175=(_0xfd5d8f<0x3?_0x3e72b4(_0xd70175):_0xfd5d8f>0x3?_0x3e72b4(_0x4fcb1f,_0x558252,_0xd70175):_0x3e72b4(_0x4fcb1f,_0x558252))||_0xd70175;}return _0xfd5d8f>0x3&&_0xd70175&&Object[_0x52530f(0xf0)](_0x4fcb1f,_0x558252,_0xd70175),_0xd70175;},__metadata=this&&this[_0x12c8c8(0xe2)]||function(_0x159d6d,_0x3cb4a1){const _0x42d2bf=_0x12c8c8;if(typeof Reflect===_0x42d2bf(0x11c)&&typeof Reflect[_0x42d2bf(0xec)]===_0x42d2bf(0xe4))return Reflect['metadata'](_0x159d6d,_0x3cb4a1);},__param=this&&this[_0x12c8c8(0xe6)]||function(_0x48ba87,_0x21007f){return function(_0x2f51a6,_0xb68d87){_0x21007f(_0x2f51a6,_0xb68d87,_0x48ba87);};};Object[_0x12c8c8(0xf0)](exports,_0x12c8c8(0xff),{'value':!![]}),exports['QueueService']=void 0x0;const common_1=require(_0x12c8c8(0x107)),bull_1=require(_0x12c8c8(0x131)),utils_1=require('../../common/utils'),midjourney_service_1=require(_0x12c8c8(0xf2)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require(_0x12c8c8(0xe5)),shared_utils_1=require(_0x12c8c8(0xfe)),typeorm_1=require(_0x12c8c8(0x116)),midjourney_entity_1=require(_0x12c8c8(0x12b)),typeorm_2=require(_0x12c8c8(0xee));function _0x4d09(){const _0x285ad9=['validateBalance','defineProperty','306866cVLljw','../midjourney/midjourney.service','__decorate','Logger','ArrowMjPrice','swap','action','deductFromBalance','MixedGraphMjPrice','getQueue','MidjourneyService','598917FQPaZR','QueueService','@nestjs/common/utils/shared.utils','__esModule','16rdaiBp','InjectRepository','userBalanceService','stringify','midjourneyService','MidjourneyEntity','jobIds','@nestjs/common','17140SjGncR','log','mjDrawQueue','createRandomUid','SUNO','active','SpellParsingMjPrice','push','GlobalConfigService','Queue\x20addMjDrawQueue\x20action:\x20','4pbjaro','debug','VariantsMjPrice','245MRmFZa','@nestjs/typeorm','decorate','getConfigs','checkLimit','addMjDrawQueue','sunoQueue','object','assign','LocalRedrawMjPrice','findOne','onApplicationBootstrap','midjourneyEntity','769685lmmmTc','describe','348032DTTASd','DrawingMjPrice','1323xViMJT','InjectQueue','add','ReMjPrice','length','../midjourney/midjourney.entity','design:paramtypes','globalConfigService','taskId','MjPriceFree','mjDraw','@nestjs/bull','clean','mjTimeoutMs','user','blend','MJDRAW','ZoomMjPrice','__metadata','ZoomInMjPrice','function','../globalConfig/globalConfig.service','__param','getOwnPropertyDescriptor','channelType','type','Queue\x20addMjDrawQueue\x20添加绘图任务\x20data:\x20','44592GirMEM','metadata','5985221MwNbAy','typeorm'];_0x4d09=function(){return _0x285ad9;};return _0x4d09();}let QueueService=class QueueService{constructor(_0x136e19,_0x2217a7,_0x5808c7,_0x12d27d,_0xcab4c7,_0x50be68){const _0x482439=_0x12c8c8;this[_0x482439(0x10a)]=_0x136e19,this[_0x482439(0x11b)]=_0x2217a7,this[_0x482439(0x121)]=_0x5808c7,this[_0x482439(0x104)]=_0x12d27d,this[_0x482439(0x102)]=_0xcab4c7,this[_0x482439(0x12d)]=_0x50be68,this['jobIds']=[];}async[_0x12c8c8(0x120)](){const _0x58fdb4=_0x12c8c8;await this['mjDrawQueue'][_0x58fdb4(0x132)](0x0,_0x58fdb4(0x10d)),await this[_0x58fdb4(0x104)]['cleanQueue']();}async[_0x12c8c8(0x11a)](_0x56d328,_0x229d8f){const _0x5ca76e=_0x12c8c8,{prompt:prompt='',imgUrl:_0x94e484,extraParam:extraParam='',maskBase64:maskBase64='',base64:_0x34d515,sourceBase64:_0x19fb73,targetBase64:_0x1ba1c1,base64Array:_0x45c926,action:_0x3cdfa6,taskId:_0x445857,operation:_0x485352,chinese_prompt:_0xe58438}=_0x56d328;let _0x243c70=_0x56d328[_0x5ca76e(0xe9)];if(_0x485352===_0x5ca76e(0xf7)){const _0x14bd68=await this[_0x5ca76e(0x121)][_0x5ca76e(0x11f)]({'where':{'message_id':_0x56d328[_0x5ca76e(0x12e)]},'select':[_0x5ca76e(0xe8)]});_0x243c70=_0x14bd68[_0x5ca76e(0xe8)];}let _0x1d448f=0x0;common_1[_0x5ca76e(0xf4)][_0x5ca76e(0x113)](_0x5ca76e(0x111)+_0x3cdfa6,_0x5ca76e(0xfd));if(_0x485352===_0x5ca76e(0xf7)){const _0x27ea52=_0x3cdfa6['match'](/(?<=MJ::).*(?=::.*\-)/g),_0x268d84={'JOB::upsample::1':_0x5ca76e(0xe3),'JOB::upsample::2':_0x5ca76e(0xe3),'JOB::upsample::3':'ZoomInMjPrice','JOB::upsample::4':_0x5ca76e(0xe3),'JOB::upsample_v6_2x_creative::1':_0x5ca76e(0xe3),'JOB::reroll::0':_0x5ca76e(0x129),'JOB::variation::1':_0x5ca76e(0x114),'JOB::variation::2':_0x5ca76e(0x114),'JOB::variation::3':_0x5ca76e(0x114),'JOB::variation::4':_0x5ca76e(0x114),'JOB::low_variation::1':_0x5ca76e(0x114),'JOB::high_variation::1':_0x5ca76e(0x114),'JOB::pan_left::1':_0x5ca76e(0xf5),'JOB::pan_right::1':_0x5ca76e(0xf5),'JOB::pan_up::1':'ArrowMjPrice','JOB::pan_down::1':_0x5ca76e(0xf5),'Inpaint::1':_0x5ca76e(0x11e),'CustomZoom':_0x5ca76e(0xe1),'Outpaint::50::1':_0x5ca76e(0xe1),'Outpaint::75::1':_0x5ca76e(0xe1)},_0x518e61=(0x0,shared_utils_1['isUndefined'])(_0x268d84[_0x27ea52[0x0]])?_0x243c70+_0x5ca76e(0x125):''+_0x243c70+_0x268d84[_0x27ea52[0x0]];_0x1d448f=await this[_0x5ca76e(0x12d)][_0x5ca76e(0x118)]([_0x518e61]);}else{const _0x3d2655={'swap':'FaceChangeMjPrice','blend':_0x5ca76e(0xf9),'describe':_0x5ca76e(0x10e)},_0x3ee1b1=(0x0,shared_utils_1['isUndefined'])(_0x3d2655[_0x485352])?_0x243c70+_0x5ca76e(0x125):''+_0x243c70+_0x3d2655[_0x485352];_0x1d448f=await this[_0x5ca76e(0x12d)][_0x5ca76e(0x118)]([_0x3ee1b1]);}await this['midjourneyService'][_0x5ca76e(0x119)](_0x229d8f,_0x243c70+'MjLimitCount');await this['globalConfigService'][_0x5ca76e(0x118)]([_0x243c70+_0x5ca76e(0x12f)])==0x0&&await this['userBalanceService'][_0x5ca76e(0xef)](_0x229d8f,_0x5ca76e(0x130),_0x1d448f);const _0x5218b7=''+(0x0,utils_1[_0x5ca76e(0x10b)])(),_0x145757=Object[_0x5ca76e(0x11d)](Object['assign']({},_0x56d328),{'userId':_0x229d8f[_0x5ca76e(0xde)]['id'],'randomDrawId':_0x5218b7});let _0x514a50;try{const _0x53fbbc=await this[_0x5ca76e(0x104)]['addDrawQueue'](_0x145757),_0x2a201d=await this[_0x5ca76e(0x12d)][_0x5ca76e(0x118)]([_0x5ca76e(0xdd)])*0x3e8||0x30d40;switch(_0x485352){case _0x5ca76e(0xf7):_0x514a50={'id':_0x53fbbc['id'],'action':_0x3cdfa6,'operation':_0x485352,'taskId':_0x445857,'maskBase64':maskBase64,'userId':_0x229d8f[_0x5ca76e(0xde)]['id'],'type':_0x243c70};break;case _0x5ca76e(0xf6):_0x514a50={'id':_0x53fbbc['id'],'operation':_0x485352,'sourceBase64':_0x19fb73,'targetBase64':_0x1ba1c1,'userId':_0x229d8f['user']['id'],'type':_0x243c70};break;case _0x5ca76e(0xdf):_0x514a50={'id':_0x53fbbc['id'],'action':_0x3cdfa6,'operation':_0x485352,'base64Array':_0x45c926,'userId':_0x229d8f[_0x5ca76e(0xde)]['id'],'type':_0x243c70};break;case _0x5ca76e(0x123):_0x514a50={'id':_0x53fbbc['id'],'action':_0x3cdfa6,'operation':_0x485352,'base64':_0x34d515,'userId':_0x229d8f[_0x5ca76e(0xde)]['id'],'type':_0x243c70};break;default:_0x514a50={'id':_0x53fbbc['id'],'action':_0x94e484?0x4:0x1,'userId':_0x229d8f[_0x5ca76e(0xde)]['id'],'type':_0x243c70};break;}common_1[_0x5ca76e(0xf4)][_0x5ca76e(0x113)](_0x5ca76e(0xea)+JSON[_0x5ca76e(0x103)](_0x514a50),_0x5ca76e(0xfd));const _0x1e540d=await this[_0x5ca76e(0x10a)][_0x5ca76e(0x128)]('mjDraw',_0x514a50,{'delay':0x3e8,'timeout':+_0x2a201d});return this[_0x5ca76e(0x106)][_0x5ca76e(0x10f)](_0x1e540d['id']),await this[_0x5ca76e(0x12d)][_0x5ca76e(0x118)]([_0x243c70+_0x5ca76e(0x12f)])==0x0&&await this[_0x5ca76e(0x102)][_0x5ca76e(0xf8)](_0x229d8f[_0x5ca76e(0xde)]['id'],_0x5ca76e(0x130),_0x1d448f,_0x1d448f),!![];}catch(_0x46283b){console[_0x5ca76e(0x109)](_0x46283b);}}async[_0x12c8c8(0xfa)](){const _0x47409e=_0x12c8c8;return{'jobIds':this[_0x47409e(0x106)]};}};QueueService=__decorate([__param(0x0,(0x0,bull_1[_0x12c8c8(0x127)])(_0x12c8c8(0xe0))),__param(0x1,(0x0,bull_1[_0x12c8c8(0x127)])(_0x12c8c8(0x10c))),__param(0x2,(0x0,typeorm_1[_0x12c8c8(0x101)])(midjourney_entity_1[_0x12c8c8(0x105)])),__metadata(_0x12c8c8(0x12c),[Object,Object,typeorm_2['Repository'],midjourney_service_1[_0x12c8c8(0xfb)],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x12c8c8(0x110)]])],QueueService),exports['QueueService']=QueueService;