'use strict';const _0x533400=_0x26e2;(function(_0x26b582,_0x337691){const _0x2d9e6e=_0x26e2,_0x4d778b=_0x26b582();while(!![]){try{const _0x144a1=-parseInt(_0x2d9e6e(0x23e))/0x1+parseInt(_0x2d9e6e(0x22f))/0x2+parseInt(_0x2d9e6e(0x223))/0x3*(-parseInt(_0x2d9e6e(0x20c))/0x4)+parseInt(_0x2d9e6e(0x1ac))/0x5*(-parseInt(_0x2d9e6e(0x1b6))/0x6)+parseInt(_0x2d9e6e(0x237))/0x7*(parseInt(_0x2d9e6e(0x256))/0x8)+parseInt(_0x2d9e6e(0x1e6))/0x9+parseInt(_0x2d9e6e(0x234))/0xa;if(_0x144a1===_0x337691)break;else _0x4d778b['push'](_0x4d778b['shift']());}catch(_0x4c43f2){_0x4d778b['push'](_0x4d778b['shift']());}}}(_0x134a,0xdaf4e));function _0x26e2(_0x48158d,_0x9c3954){const _0x134af6=_0x134a();return _0x26e2=function(_0x26e2a6,_0x5c5a45){_0x26e2a6=_0x26e2a6-0x177;let _0x24a86c=_0x134af6[_0x26e2a6];return _0x24a86c;},_0x26e2(_0x48158d,_0x9c3954);}function _0x134a(){const _0x36e19b=['queryPrompt','lockPrompt','UploadService','9093249VwdRRB','set','__decorate','base64','super','sendDrawBlend','FAILURE','deleteDraw','draw','components','发送绘画指令失败:','删除记录失败！','__metadata','@nestjs/typeorm','chevereto','decorate','mjProxy','__esModule','mjApplicationId','GlobalConfigService','cosUrl','.png','MidjourneyActionEnum','查询绘制结果失败:\x20getMessage','formatCreateOrUpdateDate','ali','midjourney:getList','replace','role','random','proxyImg','userId','status','string','swap','本次绘图指令为','data','email','4913116RCFeTa','object','../upload/upload.service','mjNotSaveImg','个任务','label','fastMjProxyUrl','message','../globalConfig/globalConfig.service','发送绘图指令失败、请联系管理员检测绘画配置！','addDrawQueue','发送操作类型错误','update','发送绘画指令失败','/mj/submit/blend','对图片操作失败:\x20','RedisCacheService','mjId','delete','Repository','charAt','MidjourneyStatusEnum','getOwnPropertyDescriptor','3lEqAKY','sendDrawDescribe','DRAW','attachments','debug','上游错误导致失败！','/mj/submit/describe','\x20次、\x20当前绘画进度为','design:paramtypes','100%','channelType','/image-seed','251916yNlRfc','本次不存图片了\x20原因是配置了不存储图片','originUrl','------>\x20开始上传图片！！！','stringify','14649540lEiQbR','blend','base64Array','126kpvHUl','updateDrawData','MidjourneyService','maskBase64','mjTimeoutMs','then','DRAWTIMEOUT','1613337LPqRJy','default','includes','pollComparisonResultDraw','toUpperCase','开始查询绘画结果','drawFailed','\x20次查询结果为','setPrompt','assign','绘制失败！','formatFileInfo','UserEntity','get','绘画失败，请稍后再试！','WAITING','imageUrl','/q/55','../../common/constants/midjourney.constant','./../user/user.entity','__param','result','getUploadType','count','536024iJhXUB','mjVersion','删除记录成功！','checkLimit','删除成功！','DRAWED','delPrompt','\x20次开始查询','非法操作！','uploadService','checkBadWords','post','height','load','randomDrawId','typeorm','filter','url','局部重绘失败！','bindJobId','affected','sendDrawActions\x20jsonData:\x20','MID_JOURNEY','当前管理员限制单用户同时最多能执行','getMjDefaultParams','getTime','提交任务失败！','UserBalanceService','$1****$2','thumbImg','map','removeEmoji','getConfigs','./prompt.entity','/mj/task/','midjourneyEntity','error:\x20','findAndCount','当前图片不存在！','relaxMjProxyKey','userBalanceService','DESC','round','messageInfo','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','arraybuffer','username','progress','getDrawList','BAD_REQUEST','log','HttpStatus','userInfo','cos','SUCCESS','isGroup','now','sendDrawCommand','user','发送绘画指令失败:\x20','fastMjProxyKey','forEach','/mj/submit/modal','findOne','tencent','绘画超时，请稍后再试！','length','code','axios','response','mjAuthorization','action','addDrawQueue\x20开始添加绘制任务\x20参数:','Logger','getFullPrompt','InjectRepository','DRAWING','68865DrkHLN','HttpException','startsWith','MjProxyUrl','../redisCache/redisCache.service','width','/mj/insight-face/swap','mjProxyImgUrl','咒语解析指令失败\x20','getMessage','30GSYZEk','taskId','.md.png','from','GENERATE','type','存储图片失败','badwordsService','globalConfigService','/mj/submit/imagine','redisCacheService','payloadJson:\x20','/h/','recDraw','error','MjProxyKey','sendDrawActions','绘制中的图片任务、禁止删除！','toString','TODO->error:\x20','floor','generateRandomFileName','parse','../userBalance/userBalance.service','【绘制图片】第\x20','mjPromptsEntity','find','delLog','isUndefined','换脸指令失败\x20','updateDrawStatus','categoryDraw','success','describe','sendDrawSwap','?imageView2/1/w/','metadata','MidjourneyEntity','mjGuildId','userEntity','save','fileInfo','relaxMjProxyUrl','/mj/submit/action','本次图片上传耗时为'];_0x134a=function(){return _0x36e19b;};return _0x134a();}var __decorate=this&&this[_0x533400(0x1e8)]||function(_0x5f2619,_0xb198da,_0x525ab8,_0x2d668c){const _0x1bfc4d=_0x533400;var _0x5117c1=arguments[_0x1bfc4d(0x1a1)],_0x191f50=_0x5117c1<0x3?_0xb198da:_0x2d668c===null?_0x2d668c=Object[_0x1bfc4d(0x222)](_0xb198da,_0x525ab8):_0x2d668c,_0x199669;if(typeof Reflect===_0x1bfc4d(0x20d)&&typeof Reflect[_0x1bfc4d(0x1f5)]==='function')_0x191f50=Reflect[_0x1bfc4d(0x1f5)](_0x5f2619,_0xb198da,_0x525ab8,_0x2d668c);else{for(var _0x4777b9=_0x5f2619[_0x1bfc4d(0x1a1)]-0x1;_0x4777b9>=0x0;_0x4777b9--)if(_0x199669=_0x5f2619[_0x4777b9])_0x191f50=(_0x5117c1<0x3?_0x199669(_0x191f50):_0x5117c1>0x3?_0x199669(_0xb198da,_0x525ab8,_0x191f50):_0x199669(_0xb198da,_0x525ab8))||_0x191f50;}return _0x5117c1>0x3&&_0x191f50&&Object['defineProperty'](_0xb198da,_0x525ab8,_0x191f50),_0x191f50;},__metadata=this&&this[_0x533400(0x1f2)]||function(_0x103601,_0x4adc99){const _0x4553d0=_0x533400;if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect[_0x4553d0(0x1da)](_0x103601,_0x4adc99);},__param=this&&this[_0x533400(0x252)]||function(_0x337f20,_0x559d9b){return function(_0x7f3b34,_0x3503eb){_0x559d9b(_0x7f3b34,_0x3503eb,_0x337f20);};};Object['defineProperty'](exports,_0x533400(0x1f7),{'value':!![]}),exports[_0x533400(0x239)]=void 0x0;const user_entity_1=require(_0x533400(0x251)),common_1=require('@nestjs/common'),typeorm_1=require(_0x533400(0x1f3)),midjourney_entity_1=require('./midjourney.entity'),typeorm_2=require(_0x533400(0x265)),axios_1=require(_0x533400(0x1a3)),image_js_1=require('image-js'),globalConfig_service_1=require(_0x533400(0x214)),midjourney_constant_1=require(_0x533400(0x250)),upload_service_1=require(_0x533400(0x20e)),badwords_service_1=require('../badwords/badwords.service'),userBalance_service_1=require(_0x533400(0x1cd)),utils_1=require('../../common/utils'),redisCache_service_1=require(_0x533400(0x1b0)),prompt_entity_1=require(_0x533400(0x180)),shared_utils_1=require('@nestjs/common/utils/shared.utils');let MidjourneyService=class MidjourneyService{constructor(_0x34df78,_0x146e7e,_0x593e30,_0x45ca52,_0x54772e,_0x1b2ab3,_0x314ef0,_0xb3d3ea){const _0x497127=_0x533400;this[_0x497127(0x182)]=_0x34df78,this['userEntity']=_0x146e7e,this[_0x497127(0x1cf)]=_0x593e30,this[_0x497127(0x1be)]=_0x45ca52,this['uploadService']=_0x54772e,this['badwordsService']=_0x1b2ab3,this[_0x497127(0x187)]=_0x314ef0,this[_0x497127(0x1c0)]=_0xb3d3ea,this[_0x497127(0x1e4)]=[];}async['sleep'](_0x4c1dbc){return new Promise(_0xf4203f=>setTimeout(_0xf4203f,_0x4c1dbc));}async[_0x533400(0x1ee)](_0x2fb502,_0x5c25e9,_0x525914){const _0x299063=_0x533400,{id:_0x9311f8,action:_0x3d7b33,operation:_0x22729c}=_0x2fb502,_0x470e6a=await this['midjourneyEntity']['findOne']({'where':{'id':_0x9311f8}});try{await this[_0x299063(0x269)](_0x9311f8,_0x5c25e9),await this[_0x299063(0x1d4)](_0x9311f8,midjourney_constant_1['MidjourneyStatusEnum'][_0x299063(0x1ab)]);const _0x1f36f0=[_0x299063(0x1a6),_0x299063(0x235),_0x299063(0x208),_0x299063(0x1d7),midjourney_constant_1[_0x299063(0x1fc)][_0x299063(0x1ba)],midjourney_constant_1[_0x299063(0x1fc)][_0x299063(0x225)]];if(!_0x1f36f0[_0x299063(0x240)](_0x22729c)&&!_0x1f36f0[_0x299063(0x240)](_0x3d7b33))throw new Error(_0x299063(0x217));if(_0x3d7b33===midjourney_constant_1['MidjourneyActionEnum'][_0x299063(0x225)]||_0x3d7b33===midjourney_constant_1[_0x299063(0x1fc)][_0x299063(0x1ba)]){const _0xf2eb9=await this[_0x299063(0x198)](_0x470e6a,_0x2fb502),_0x289938=await this[_0x299063(0x241)](_0xf2eb9,_0x2fb502);_0x289938[_0x299063(0x18e)]===_0x299063(0x22c)&&await this[_0x299063(0x238)](_0x2fb502,_0x289938);}if(_0x22729c===_0x299063(0x1a6)){const _0x3d841b=await this[_0x299063(0x1c6)](_0x470e6a,_0x2fb502),_0x4e22ad=await this['pollComparisonResultDraw'](_0x3d841b,_0x2fb502);_0x4e22ad[_0x299063(0x18e)]==='100%'&&await this['updateDrawData'](_0x2fb502,_0x4e22ad);}if(_0x22729c==='blend'){const _0x19e956=await this['sendDrawBlend'](_0x470e6a,_0x2fb502),_0x35e439=await this[_0x299063(0x241)](_0x19e956,_0x2fb502);_0x35e439['progress']==='100%'&&await this['updateDrawData'](_0x2fb502,_0x35e439);}if(_0x22729c===_0x299063(0x208)){const _0x385c78=await this[_0x299063(0x1d8)](_0x470e6a,_0x2fb502),_0x2717cf=await this[_0x299063(0x241)](_0x385c78,_0x2fb502);_0x2717cf[_0x299063(0x18e)]===_0x299063(0x22c)&&await this[_0x299063(0x238)](_0x2fb502,_0x2717cf);}if(_0x22729c==='describe'){const _0x583253=await this[_0x299063(0x224)](_0x470e6a,_0x2fb502),_0x41df3e=await this[_0x299063(0x241)](_0x583253,_0x2fb502);_0x41df3e[_0x299063(0x18e)]==='100%'&&await this['updateDrawData'](_0x2fb502,_0x41df3e);}return!![];}catch(_0x31fcdc){return this[_0x299063(0x1e4)]=this[_0x299063(0x1e4)][_0x299063(0x266)](_0x54be80=>_0x54be80!==_0x470e6a[_0x299063(0x264)]),await this['drawFailed'](_0x2fb502,_0x31fcdc['message']||_0x31fcdc),!![];}}async[_0x533400(0x216)](_0x26a9ea){const _0x58330b=_0x533400;let {prompt:_0x43bab7,type:_0x19a4ce,imgUrl:imgUrl='',extraParam:extraParam='',action:action=0x1,userId:_0x1f0ff0,randomDrawId:_0x439366,orderId:_0x424ccd,custom_id:_0x492284,taskId:_0x4f6982,chinese_prompt:_0x35c690}=_0x26a9ea;common_1[_0x58330b(0x1a8)][_0x58330b(0x227)](_0x58330b(0x1a7)+JSON['stringify'](_0x26a9ea),'MidjourneyService');const _0x24d4e9=imgUrl?imgUrl+'\x20'+_0x43bab7+'\x20'+extraParam:_0x43bab7+'\x20'+extraParam;if((0x0,shared_utils_1[_0x58330b(0x1d2)])(_0x19a4ce)){const _0x2d425a=await this['midjourneyEntity']['findOne']({'where':{'message_id':_0x4f6982},'select':['channelType']});_0x19a4ce=_0x2d425a[_0x58330b(0x22d)];}await this[_0x58330b(0x1bd)][_0x58330b(0x260)](_0x24d4e9,_0x1f0ff0);const _0x34bd49={'userId':_0x1f0ff0,'extraParam':extraParam,'prompt':_0x43bab7,'imgUrl':imgUrl,'fullPrompt':_0x24d4e9,'randomDrawId':_0x439366,'status':midjourney_constant_1[_0x58330b(0x221)][_0x58330b(0x24d)],'action':action,'orderId':_0x424ccd,'custom_id':_0x492284,'channelType':_0x19a4ce,'chinese_prompt':_0x35c690},_0x289dc5=await this['midjourneyEntity'][_0x58330b(0x1de)](_0x34bd49);return _0x289dc5;}async['updateDrawStatus'](_0x1628c4,_0x41b84b){const _0x423500=_0x533400;await this[_0x423500(0x182)][_0x423500(0x218)]({'id':_0x1628c4},{'status':_0x41b84b});}async[_0x533400(0x238)](_0x55d523,_0x30c832){const _0x370648=_0x533400;try{const {id:_0x37e6e5,content:_0x1d61b5,channel_id:_0x1cb104,attachments:attachments=[],timestamp:_0x5a608d,durationSpent:_0x398555}=_0x30c832,_0xc9b30b=_0x30c832[_0x370648(0x24e)],_0x3040e4=await this[_0x370648(0x1be)][_0x370648(0x17f)]([_0x370648(0x20f)]),_0x1bb483=await this[_0x370648(0x25f)][_0x370648(0x254)](),_0x4d6aeb=this[_0x370648(0x1cb)](_0x370648(0x1fb)),_0x1ea1a3={'status':midjourney_constant_1[_0x370648(0x221)][_0x370648(0x25b)],'message_id':_0x37e6e5,'progress':0x64,'fileInfo':JSON['stringify']({'width':0x0,'height':0x0,'cosUrl':_0xc9b30b,'filename':_0x4d6aeb,'cosType':_0x1bb483}),'extend':this[_0x370648(0x17e)](JSON[_0x370648(0x233)](_0x30c832)),'durationSpent':_0x398555,'isSaveImg':!Number(_0x3040e4)||Number(_0x3040e4)===0x0};await this[_0x370648(0x182)][_0x370648(0x218)]({'id':_0x55d523['id']},_0x1ea1a3);const _0x472150=await axios_1[_0x370648(0x23f)][_0x370648(0x24b)](_0xc9b30b,{'responseType':_0x370648(0x18c)})[_0x370648(0x23c)](async _0x4f0716=>{const _0x30ca6c=_0x370648,_0x2bf972=await image_js_1['default'][_0x30ca6c(0x263)](_0x4f0716[_0x30ca6c(0x20a)]),_0x50f843=_0x2bf972[_0x30ca6c(0x262)],_0x1e34f8=_0x2bf972[_0x30ca6c(0x1b1)],_0x319b82=_0x4f0716[_0x30ca6c(0x20a)][_0x30ca6c(0x1a1)];return{'width':_0x1e34f8,'height':_0x50f843,'size':_0x319b82};})[_0x370648(0x23c)](_0x43eabf=>{const _0x5c2d93=JSON['stringify'](_0x43eabf);return _0x5c2d93;});let _0x66f35f='';if(!Number(_0x3040e4)||Number(_0x3040e4)===0x0){common_1[_0x370648(0x1a8)]['debug'](_0x370648(0x232),_0x370648(0x239));const _0x3752d5=new Date();_0x66f35f=await this[_0x370648(0x25f)]['uploadFileFromUrl']({'filename':_0x4d6aeb,'url':_0xc9b30b});const _0x236680=new Date();common_1[_0x370648(0x1a8)]['debug'](_0x370648(0x1e2)+(_0x236680['getTime']()-_0x3752d5[_0x370648(0x178)]())/0x3e8+'秒',_0x370648(0x239));}else common_1[_0x370648(0x1a8)]['debug'](_0x370648(0x230),_0x370648(0x239));const {width:_0x15291e,height:_0x3aac2c,size:_0x4bcbe9}=JSON[_0x370648(0x1cc)](_0x472150);await this[_0x370648(0x182)][_0x370648(0x218)]({'id':_0x55d523['id']},{'fileInfo':JSON[_0x370648(0x233)]({'width':_0x15291e,'height':_0x3aac2c,'size':_0x4bcbe9,'filename':_0x4d6aeb,'cosUrl':_0x66f35f,'cosType':_0x1bb483})});}catch(_0x521285){common_1[_0x370648(0x1a8)][_0x370648(0x227)]('TODO->存储图片失败,\x20',_0x521285[_0x370648(0x213)]||_0x521285,_0x370648(0x239));throw new Error(_0x370648(0x1bc));}}async[_0x533400(0x198)](_0x4505a7,_0x34b4e4){const _0x2809a6=_0x533400,{fullPrompt:_0xc64781,randomDrawId:_0x40a93c,imgUrl:_0x2cc201}=_0x4505a7,_0x18b0b5=''+_0xc64781;common_1[_0x2809a6(0x1a8)][_0x2809a6(0x227)](_0x2809a6(0x209)+_0x18b0b5,_0x2809a6(0x239));const _0xf6e4ba=_0x34b4e4['type']['toUpperCase'](),_0x19944={'base64Array':[],'botType':'MID_JOURNEY','notifyHook':'','prompt':_0x18b0b5,'state':'','accountFilter':{'channelId':'','instanceId':'','modes':[_0xf6e4ba],'remark':''}};common_1[_0x2809a6(0x1a8)][_0x2809a6(0x227)](_0x2809a6(0x1c1)+JSON[_0x2809a6(0x233)](_0x19944),_0x2809a6(0x239));try{let _0x1f21f9=_0x34b4e4[_0x2809a6(0x1bb)]+_0x2809a6(0x1af);const _0x5c3d48=await this['globalConfigService'][_0x2809a6(0x17f)]([_0x1f21f9]);_0x1f21f9=_0x34b4e4[_0x2809a6(0x1bb)]+_0x2809a6(0x1c5);const _0x25fc7=await this[_0x2809a6(0x1be)][_0x2809a6(0x17f)]([_0x1f21f9]),_0x3cf7cf=_0x5c3d48+_0x2809a6(0x1bf),_0xc0ef59={'Mj-Api-Secret':_0x25fc7},_0x4119e0=await axios_1[_0x2809a6(0x23f)][_0x2809a6(0x261)](_0x3cf7cf,_0x19944,{'headers':_0xc0ef59});this[_0x2809a6(0x182)][_0x2809a6(0x218)]({'id':_0x4505a7['id']},{'message_id':_0x4119e0[_0x2809a6(0x20a)][_0x2809a6(0x253)]}),console['log'](_0x4119e0['data']);if(_0x4119e0['data'][_0x2809a6(0x1a2)]!=0x1){common_1[_0x2809a6(0x1a8)][_0x2809a6(0x1c4)](_0x2809a6(0x219),_0x2809a6(0x239));throw new Error('提交任务失败！');}return _0x4119e0[_0x2809a6(0x20a)][_0x2809a6(0x253)];}catch(_0x49efc5){console[_0x2809a6(0x191)](_0x49efc5[_0x2809a6(0x1a4)]),common_1[_0x2809a6(0x1a8)]['error'](_0x2809a6(0x219),_0x2809a6(0x239));throw new Error(_0x2809a6(0x215));}}async[_0x533400(0x1c6)](_0x255ce2,_0x2a0624){const _0x20d760=_0x533400,_0x2353e4=_0x2a0624[_0x20d760(0x1a6)],_0x418725=_0x2a0624[_0x20d760(0x1b7)],_0x5f4390={'customId':_0x2353e4,'taskId':''+_0x418725};common_1[_0x20d760(0x1a8)]['debug'](_0x20d760(0x26b)+JSON[_0x20d760(0x233)](_0x5f4390),_0x20d760(0x239));let _0x350613=_0x255ce2[_0x20d760(0x22d)]+_0x20d760(0x1af);const _0x23f4ec=await this['globalConfigService'][_0x20d760(0x17f)]([_0x350613]);_0x350613=_0x255ce2[_0x20d760(0x22d)]+_0x20d760(0x1c5);const _0x26862b=await this[_0x20d760(0x1be)][_0x20d760(0x17f)]([_0x350613]),_0x48a9b0=_0x23f4ec+_0x20d760(0x1e1),_0x2faa89={'Mj-Api-Secret':_0x26862b};try{if(_0x2a0624[_0x20d760(0x23a)]){const _0x196d09=await axios_1['default'][_0x20d760(0x261)](_0x48a9b0,_0x5f4390,{'headers':_0x2faa89}),_0x586c3a=await axios_1['default'][_0x20d760(0x261)](_0x23f4ec+_0x20d760(0x19d),{'taskId':_0x196d09[_0x20d760(0x20a)]['result'],'maskBase64':_0x2a0624['maskBase64'],'prompt':''},{'headers':_0x2faa89}),{description:_0x56f73a}=_0x586c3a[_0x20d760(0x20a)];if(_0x586c3a[_0x20d760(0x20a)][_0x20d760(0x1a2)]!=0x1){const _0x1b50a8=typeof _0x56f73a=='string'?_0x56f73a:JSON['stringify'](_0x56f73a)||_0x20d760(0x268);common_1[_0x20d760(0x1a8)][_0x20d760(0x1c4)](_0x20d760(0x19a)+_0x1b50a8,'MidjourneyService');throw new Error(_0x1b50a8);}return this[_0x20d760(0x182)]['update']({'id':_0x255ce2['id']},{'message_id':_0x586c3a['data'][_0x20d760(0x253)]}),_0x586c3a['data'][_0x20d760(0x253)];}else{const _0x1f7960=await axios_1['default'][_0x20d760(0x261)](_0x48a9b0,_0x5f4390,{'headers':_0x2faa89}),{description:_0x4f2d4b}=_0x1f7960[_0x20d760(0x20a)];if(_0x1f7960[_0x20d760(0x20a)]['code']!=0x1){const _0x229dab=typeof _0x4f2d4b==_0x20d760(0x207)?_0x4f2d4b:JSON['stringify'](_0x4f2d4b);common_1[_0x20d760(0x1a8)][_0x20d760(0x1c4)](_0x20d760(0x1f0)+_0x229dab,_0x20d760(0x239));throw new Error(_0x229dab);}return this[_0x20d760(0x182)][_0x20d760(0x218)]({'id':_0x255ce2['id']},{'message_id':_0x1f7960['data'][_0x20d760(0x253)]}),_0x1f7960[_0x20d760(0x20a)][_0x20d760(0x253)];}}catch(_0x4d6dd1){const _0x539ad5=_0x20d760(0x21b)+(_0x4d6dd1[_0x20d760(0x213)]||_0x4d6dd1);common_1[_0x20d760(0x1a8)][_0x20d760(0x1c4)](''+_0x539ad5,_0x20d760(0x239));throw new Error(_0x539ad5);}}async[_0x533400(0x1eb)](_0x17bf57,_0x17196f){const _0x165420=_0x533400,_0x390cf4=_0x17196f[_0x165420(0x236)],_0x1210d3=_0x17196f['type']['toUpperCase'](),_0x48e037={'base64Array':_0x390cf4,'botType':_0x165420(0x26c),'dimensions':'SQUARE','accountFilter':{'channelId':'','instanceId':'','modes':[_0x1210d3],'remark':''}};let _0x3e27fe=_0x17196f[_0x165420(0x1bb)]+_0x165420(0x1af);const _0x2ab23d=await this[_0x165420(0x1be)][_0x165420(0x17f)]([_0x3e27fe]);_0x3e27fe=_0x17196f['type']+_0x165420(0x1c5);const _0x3c9b20=await this[_0x165420(0x1be)][_0x165420(0x17f)]([_0x3e27fe]),_0x135ed7=_0x2ab23d+_0x165420(0x21a),_0x498d07={'Mj-Api-Secret':_0x3c9b20};try{const _0x52f0e5=await axios_1[_0x165420(0x23f)][_0x165420(0x261)](_0x135ed7,_0x48e037,{'headers':_0x498d07});if(_0x52f0e5[_0x165420(0x20a)]['code']!=0x1){common_1[_0x165420(0x1a8)][_0x165420(0x1c4)](_0x165420(0x219),'MidjourneyService');throw new Error(_0x165420(0x179));}return this[_0x165420(0x182)][_0x165420(0x218)]({'id':_0x17bf57['id']},{'message_id':_0x52f0e5[_0x165420(0x20a)][_0x165420(0x253)]}),_0x52f0e5[_0x165420(0x20a)][_0x165420(0x253)];}catch(_0x3453bb){const _0x76c853='混图指令失败\x20'+(_0x3453bb[_0x165420(0x213)]||_0x3453bb);common_1['Logger'][_0x165420(0x1c4)](_0x76c853,_0x165420(0x239));throw new Error(_0x76c853);}}async['sendDrawSwap'](_0x145928,_0x362c74){const _0x646b82=_0x533400,{sourceBase64:_0x23a4bc,targetBase64:_0x165808}=_0x362c74,_0x161b8b=_0x362c74[_0x646b82(0x1bb)][_0x646b82(0x242)](),_0x35d105={'sourceBase64':_0x23a4bc,'targetBase64':_0x165808,'accountFilter':{'channelId':'','instanceId':'','modes':[_0x161b8b],'remark':''}};let _0xfe91eb=_0x362c74[_0x646b82(0x1bb)]+_0x646b82(0x1af);const _0x46dc41=await this['globalConfigService'][_0x646b82(0x17f)]([_0xfe91eb]);_0xfe91eb=_0x362c74[_0x646b82(0x1bb)]+'MjProxyKey';const _0x3bc9d9=await this[_0x646b82(0x1be)]['getConfigs']([_0xfe91eb]);console['log'](_0x35d105);const _0x90ed8e=_0x46dc41+_0x646b82(0x1b2),_0x4db509={'Mj-Api-Secret':_0x3bc9d9};try{const _0x35d6ee=await axios_1[_0x646b82(0x23f)][_0x646b82(0x261)](_0x90ed8e,_0x35d105,{'headers':_0x4db509});if(_0x35d6ee[_0x646b82(0x20a)][_0x646b82(0x1a2)]!=0x1)throw new Error(_0x646b82(0x179));return this['midjourneyEntity']['update']({'id':_0x145928['id']},{'message_id':_0x35d6ee[_0x646b82(0x20a)][_0x646b82(0x253)]}),_0x35d6ee[_0x646b82(0x20a)][_0x646b82(0x253)];}catch(_0x601f6a){const _0x32f70f=_0x646b82(0x1d3)+(_0x601f6a[_0x646b82(0x213)]||_0x601f6a);common_1['Logger'][_0x646b82(0x1c4)](_0x32f70f,_0x646b82(0x239));throw new Error(_0x32f70f);}}async[_0x533400(0x224)](_0x2e1451,_0xe963a2){const _0x57abc6=_0x533400,{base64:_0x560511}=_0xe963a2,_0x2caa30=_0xe963a2['type'][_0x57abc6(0x242)](),_0x1dc945={'base64':_0x560511,'accountFilter':{'channelId':'','instanceId':'','modes':[_0x2caa30],'remark':''}};let _0x569825=_0xe963a2[_0x57abc6(0x1bb)]+_0x57abc6(0x1af);const _0x49bddd=await this[_0x57abc6(0x1be)][_0x57abc6(0x17f)]([_0x569825]);_0x569825=_0xe963a2[_0x57abc6(0x1bb)]+_0x57abc6(0x1c5);const _0x5ec97f=await this['globalConfigService'][_0x57abc6(0x17f)]([_0x569825]),_0x5a1dde=_0x49bddd+_0x57abc6(0x229),_0x3183a3={'Mj-Api-Secret':_0x5ec97f};try{const _0x206625=await axios_1[_0x57abc6(0x23f)][_0x57abc6(0x261)](_0x5a1dde,_0x1dc945,{'headers':_0x3183a3});if(_0x206625['data']['code']!=0x1)throw new Error('提交任务失败！');return this[_0x57abc6(0x182)][_0x57abc6(0x218)]({'id':_0x2e1451['id']},{'message_id':_0x206625[_0x57abc6(0x20a)]['result']}),_0x206625[_0x57abc6(0x20a)][_0x57abc6(0x253)];}catch(_0x1f8371){const _0x18a5ba=_0x57abc6(0x1b4)+(_0x1f8371['message']||_0x1f8371);common_1[_0x57abc6(0x1a8)]['error'](_0x18a5ba,_0x57abc6(0x239));throw new Error(_0x18a5ba);}}async[_0x533400(0x241)](_0x45357c,_0x13ebf7){const _0x357673=_0x533400;common_1['Logger']['debug'](_0x357673(0x243),_0x357673(0x239));const _0x3197fc=await this[_0x357673(0x182)][_0x357673(0x19e)]({'where':{'message_id':_0x45357c}}),_0x1aa8f7=Date[_0x357673(0x197)](),_0x45bc29=0x2710,_0x5aff35=0x7530,_0x2e4d84=await this['globalConfigService'][_0x357673(0x17f)]([_0x357673(0x23b)])*0x3e8||0x493e0,_0x22901e=_0x2e4d84;let _0xe9d246=0x0,_0x4758aa=null,_0x3a674c=![];try{while(!_0x3a674c&&Date[_0x357673(0x197)]()-_0x1aa8f7<_0x22901e){let _0x1a0068;Date['now']()-_0x1aa8f7<0x15f90?_0x1a0068=_0x45bc29:_0x1a0068=_0x5aff35;await this['sleep'](_0x1a0068),common_1['Logger'][_0x357673(0x227)](_0x357673(0x1ce)+(_0xe9d246+0x1)+_0x357673(0x25d),_0x357673(0x239)),_0x4758aa=await this[_0x357673(0x1b5)](_0x45357c,_0x13ebf7),common_1[_0x357673(0x1a8)]['debug'](_0x357673(0x1ce)+(_0xe9d246+0x1)+'\x20次查询结果为'+JSON[_0x357673(0x233)](_0x4758aa),'MidjourneyService');if(_0x4758aa&&_0x4758aa[_0x357673(0x206)]!==_0x357673(0x1ec)){const _0x528810=_0x4758aa[_0x357673(0x18e)]!==null&&_0x4758aa[_0x357673(0x18e)]!==''&&_0x4758aa[_0x357673(0x18e)]!==undefined&&typeof _0x4758aa[_0x357673(0x18e)]===_0x357673(0x207)?parseFloat(_0x4758aa[_0x357673(0x18e)][_0x357673(0x201)]('%','')):0x0;let _0x4cdf31=_0x4758aa[_0x357673(0x18e)];_0x4cdf31&&(_0x4cdf31=_0x4cdf31[_0x357673(0x201)]('%',''),_0x4cdf31=isNaN(_0x4cdf31)?0x0:_0x4cdf31),common_1[_0x357673(0x1a8)][_0x357673(0x227)]('【绘制图片】第\x20'+(_0xe9d246+0x1)+_0x357673(0x22a)+_0x528810+'%',_0x357673(0x239)),this[_0x357673(0x182)]['update']({'message_id':_0x45357c},{'messageInfo':JSON[_0x357673(0x233)](_0x4758aa)}),await this[_0x357673(0x182)][_0x357673(0x218)]({'message_id':_0x45357c},{'progress':_0x528810?isNaN(_0x528810)?_0x4cdf31:_0x528810:0x0});}_0x3a674c=_0x4758aa[_0x357673(0x206)]===_0x357673(0x1ec)||_0x4758aa[_0x357673(0x206)]===_0x357673(0x195),_0xe9d246++;}if(!_0x4758aa||_0x4758aa[_0x357673(0x206)]===_0x357673(0x1ec)){common_1[_0x357673(0x1a8)]['error']('【绘制图片】FAILURE\x20第\x20'+(_0xe9d246+0x1)+_0x357673(0x245)+JSON[_0x357673(0x233)](_0x4758aa),_0x357673(0x239)),await this[_0x357673(0x1d4)]({'message_id':_0x45357c},{'status':midjourney_constant_1[_0x357673(0x221)][_0x357673(0x23d)]}),this['drawFailed'](_0x13ebf7);throw new Error(_0x357673(0x1a0));}const _0x492a3e=Date[_0x357673(0x197)]();return Object[_0x357673(0x247)](Object[_0x357673(0x247)]({},_0x4758aa),{'durationSpent':Math[_0x357673(0x1ca)]((_0x492a3e-_0x1aa8f7)/0x3e8)});}catch(_0x49e58f){throw new Error('获取图片结果失败！'+(_0x49e58f[_0x357673(0x213)]||_0x49e58f)+'\x20');}}async[_0x533400(0x177)](){const _0x4151ae=_0x533400,_0x348649=await this[_0x4151ae(0x1be)][_0x4151ae(0x17f)]([_0x4151ae(0x21d),'mjApplicationId','mjGuildId','mjChannelId','mjSessionId',_0x4151ae(0x257),'mjAuthorization','mjRateLimit',_0x4151ae(0x212),_0x4151ae(0x19b),_0x4151ae(0x1e0),_0x4151ae(0x186)]),_0x596245={'application_id':_0x348649[_0x4151ae(0x1f8)],'guild_id':_0x348649[_0x4151ae(0x1dc)],'channel_id':_0x348649['mjChannelId'],'session_id':_0x348649['mjSessionId'],'version':_0x348649[_0x4151ae(0x257)],'id':_0x348649['mjId'],'authorization':_0x348649[_0x4151ae(0x1a5)],'mjRateLimit':_0x348649['mjRateLimit'],'mjProxy':_0x348649[_0x4151ae(0x1f6)]||0x0};return _0x596245;}async[_0x533400(0x1b5)](_0x114786,_0x21b7e9){const _0x40d45e=_0x533400;try{if(_0x114786===null){await this[_0x40d45e(0x1d4)]({'message_id':_0x114786},{'status':midjourney_constant_1[_0x40d45e(0x221)]['DRAWTIMEOUT']}),this['drawFailed'](_0x21b7e9);throw new common_1[(_0x40d45e(0x1ad))](_0x40d45e(0x24c),common_1[_0x40d45e(0x192)][_0x40d45e(0x190)]);}const _0x254e5b=await this['midjourneyEntity'][_0x40d45e(0x19e)]({'where':{'message_id':_0x114786},'select':[_0x40d45e(0x22d)]});((0x0,shared_utils_1[_0x40d45e(0x1d2)])(_0x21b7e9[_0x40d45e(0x1bb)])&&_0x21b7e9[_0x40d45e(0x1bb)]===null||_0x21b7e9['length']==0x0)&&(_0x21b7e9['type']=_0x254e5b[_0x40d45e(0x22d)]);let _0x14732c=_0x21b7e9[_0x40d45e(0x1bb)]+_0x40d45e(0x1af);const _0x5f2948=await this[_0x40d45e(0x1be)][_0x40d45e(0x17f)]([_0x14732c]);let _0x92e6c7=_0x5f2948+'/mj/task/'+_0x114786+'/fetch';_0x21b7e9[_0x40d45e(0x1a1)]===0x0&&(_0x92e6c7=_0x5f2948+_0x40d45e(0x181)+_0x114786+_0x40d45e(0x22e));_0x14732c=_0x21b7e9['type']+'MjProxyKey';const _0x2ce0f6=await this[_0x40d45e(0x1be)][_0x40d45e(0x17f)]([_0x14732c]),_0x52b548={'Mj-Api-Secret':_0x2ce0f6},_0x475843=await axios_1[_0x40d45e(0x23f)][_0x40d45e(0x24b)](_0x92e6c7,{'headers':_0x52b548});return _0x475843[_0x40d45e(0x20a)]['description']===_0x40d45e(0x1d6)&&_0x21b7e9[_0x40d45e(0x1a1)]===0x0&&await this['midjourneyEntity']['update']({'message_id':_0x114786},{'seed_id':_0x475843[_0x40d45e(0x20a)][_0x40d45e(0x253)]}),_0x475843[_0x40d45e(0x20a)];}catch(_0x377b79){return common_1['Logger'][_0x40d45e(0x1c4)](_0x40d45e(0x1fd),_0x377b79,'MidjourneyService'),[];}}[_0x533400(0x17e)](_0x40fd29){const _0x57f2aa=_0x533400,_0x29641c=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x40fd29[_0x57f2aa(0x201)](_0x29641c,'');}async[_0x533400(0x269)](_0x365409,_0x156371){await this['midjourneyEntity']['update']({'id':_0x365409},{'jobId':_0x156371});}async[_0x533400(0x18f)](_0x5123e6,_0x92358b){const _0x2ad862=_0x533400;try{const {page:page=0x1,size:size=0x1e}=_0x92358b,[_0x192162,_0x421ff]=await this[_0x2ad862(0x182)]['findAndCount']({'where':{'userId':_0x5123e6[_0x2ad862(0x199)]['id'],'isDelete':0x0},'order':{'id':_0x2ad862(0x188)},'take':size,'skip':(page-0x1)*size}),_0x1326fd=await this[_0x2ad862(0x1be)]['getConfigs']([_0x2ad862(0x1b3)]);_0x192162['forEach'](_0x3aeaf0=>{const _0x24db78=_0x2ad862;var _0x10b81d,_0x5845b4,_0x5a51a2,_0x15b4ef;try{const {extend:_0x134a1f,isSaveImg:_0x353baf,fileInfo:_0x4e6dee}=_0x3aeaf0,_0x2a9371=(_0x5845b4=(_0x10b81d=JSON[_0x24db78(0x1cc)](_0x134a1f))===null||_0x10b81d===void 0x0?void 0x0:_0x10b81d[_0x24db78(0x226)][0x0])===null||_0x5845b4===void 0x0?void 0x0:_0x5845b4[_0x24db78(0x267)];_0x3aeaf0[_0x24db78(0x196)]=((_0x15b4ef=(_0x5a51a2=JSON[_0x24db78(0x1cc)](_0x134a1f))===null||_0x5a51a2===void 0x0?void 0x0:_0x5a51a2[_0x24db78(0x1ef)][0x0])===null||_0x15b4ef===void 0x0?void 0x0:_0x15b4ef[_0x24db78(0x1ef)][0x0]['label'])==='U1',_0x3aeaf0['originUrl']=_0x2a9371,_0x3aeaf0[_0x24db78(0x1df)]=JSON['parse'](_0x3aeaf0[_0x24db78(0x1df)]),_0x3aeaf0['messageInfo']=JSON[_0x24db78(0x1cc)](_0x3aeaf0[_0x24db78(0x18a)]);}catch(_0x6df4b){}});const _0x48565b=await this[_0x2ad862(0x182)][_0x2ad862(0x255)]({'where':{'isDelete':0x0,'status':(0x0,typeorm_2['In'])([0x1,0x2])}}),_0x2c1c3b={'rows':(0x0,utils_1[_0x2ad862(0x1fe)])(_0x192162),'count':_0x421ff,'countQueue':_0x48565b};return _0x2c1c3b;}catch(_0x353e8c){throw new common_1[(_0x2ad862(0x1ad))]('获取我得绘制列表失败',common_1['HttpStatus'][_0x2ad862(0x190)]);}}[_0x533400(0x249)](_0x8fb075,_0x5d0090,_0x4728c1,_0x1d678a){const _0x598580=_0x533400;if(!_0x8fb075)return{};let _0x139f87=null;try{_0x139f87=JSON[_0x598580(0x1cc)](_0x8fb075);}catch(_0x40e844){_0x139f87=null;}if(!_0x139f87)return;const {url:_0x2f09bb,filename:_0x423f89,size:_0xf4e95,cosUrl:_0xc6b076,width:_0x434eff,height:_0x403d31}=_0x139f87,_0x582b26=0x136,_0x406a35=_0xc6b076[_0x598580(0x240)](_0x598580(0x194))?'tencent':_0xc6b076[_0x598580(0x240)]('oss')?_0x598580(0x1ff):_0x598580(0x1f4);let _0x5e02fb,_0x20e013;if(_0x406a35===_0x598580(0x19f)){const _0x1c9f0c=_0x434eff/_0x403d31,_0x2862a9=Math[_0x598580(0x189)](_0x582b26/_0x1c9f0c);_0x20e013=_0xc6b076+(_0x598580(0x1d9)+_0x582b26+_0x598580(0x1c2)+_0x2862a9+_0x598580(0x24f));}if(_0x406a35===_0x598580(0x1ff)){const _0x368abb=_0x403d31/_0x434eff,_0x28778b=Math[_0x598580(0x189)](_0x582b26/_0x368abb);_0x20e013=_0xc6b076+('?x-oss-process=image/resize,w_'+_0x28778b);}_0x406a35===_0x598580(0x1f4)&&(_0x20e013=_0xc6b076[_0x598580(0x201)](/\.png$/,_0x598580(0x1b8)));_0x139f87['thumbImg']=_0x20e013;if(!_0x5d0090){const _0x4ad92c=_0x4728c1+'/mj/pipe?url='+_0x1d678a;_0x139f87[_0x598580(0x17c)]=_0x4ad92c,_0x139f87[_0x598580(0x1fa)]=_0x4ad92c;}return _0x139f87;}async[_0x533400(0x1ed)](_0x41c0c0,_0x1e6f8f){const _0x22dc1f=_0x533400,_0x5c44e5=await this[_0x22dc1f(0x182)][_0x22dc1f(0x19e)]({'where':{'id':_0x41c0c0,'userId':_0x1e6f8f['user']['id'],'isDelete':0x0}});if(!_0x5c44e5)throw new common_1[(_0x22dc1f(0x1ad))](_0x22dc1f(0x185),common_1[_0x22dc1f(0x192)]['BAD_REQUEST']);if(_0x5c44e5['status']===0x2)throw new common_1[(_0x22dc1f(0x1ad))](_0x22dc1f(0x1c7),common_1[_0x22dc1f(0x192)]['BAD_REQUEST']);const _0x56be10=await this['midjourneyEntity'][_0x22dc1f(0x218)]({'id':_0x41c0c0},{'isDelete':0x1});if(_0x56be10[_0x22dc1f(0x26a)]>0x0)return _0x22dc1f(0x25a);else throw new common_1[(_0x22dc1f(0x1ad))]('删除失败！',common_1['HttpStatus'][_0x22dc1f(0x190)]);}async[_0x533400(0x259)](_0x4de967,_0x147814){const _0x2a2b70=_0x533400,{role:_0x285b54,id:_0x269bb7}=_0x4de967[_0x2a2b70(0x199)],_0x44a8e5=await this['midjourneyEntity'][_0x2a2b70(0x255)]({'where':{'userId':_0x269bb7,'isDelete':0x0,'status':(0x0,typeorm_2['In'])([0x1,0x2])}}),_0xddd906=await this[_0x2a2b70(0x1be)][_0x2a2b70(0x17f)]([_0x147814]),_0x45fce8=_0xddd906?Number(_0xddd906):0x2;if(_0x44a8e5>=_0x45fce8)throw new common_1['HttpException'](_0x2a2b70(0x26d)+_0x45fce8+_0x2a2b70(0x210),common_1[_0x2a2b70(0x192)][_0x2a2b70(0x190)]);}async[_0x533400(0x244)](_0x4ac98a,_0x57577a){const _0x109647=_0x533400,{id:_0x41f75d,userId:_0x333c2f,action:_0x872708,operation:_0x49bb3b,type:_0x4ab7d1}=_0x4ac98a,_0x4ebe63=_0x57577a||_0x109647(0x228);common_1[_0x109647(0x1a8)][_0x109647(0x227)](_0x109647(0x248)+_0x4ebe63,'MidjourneyService'),await this['midjourneyEntity'][_0x109647(0x218)]({'id':_0x41f75d},{'status':0x5,'failedReason':_0x4ebe63});}async['getList'](_0x26cb59){const _0x365f34=_0x533400,{page:page=0x1,size:size=0x14,rec:_0x130b4e,userId:_0x577a3,status:_0x3c7d01,category_id:_0x2df6d1}=_0x26cb59;if(Number(size)===0x3e7){const _0xc6287e=await this[_0x365f34(0x1c0)][_0x365f34(0x24b)]({'key':_0x365f34(0x200)});if(_0xc6287e)try{return JSON[_0x365f34(0x1cc)](_0xc6287e);}catch(_0x59b95c){return[];}}const _0x4de977={'isDelete':0x0};_0x130b4e&&Object['assign'](_0x4de977,{'rec':_0x130b4e}),_0x2df6d1&&Object[_0x365f34(0x247)](_0x4de977,{'category_id':_0x2df6d1}),_0x577a3&&Object[_0x365f34(0x247)](_0x4de977,{'userId':_0x577a3}),_0x3c7d01&&Object[_0x365f34(0x247)](_0x4de977,{'status':_0x3c7d01});const [_0x41c0d3,_0xf8d790]=await this[_0x365f34(0x182)][_0x365f34(0x184)]({'where':_0x4de977,'order':{'id':_0x365f34(0x188)},'take':size,'skip':(page-0x1)*size}),_0x5864a8=await this[_0x365f34(0x1be)][_0x365f34(0x17f)]([_0x365f34(0x1b3)]);_0x41c0d3[_0x365f34(0x19c)](_0x3ac995=>{const _0x5a564a=_0x365f34;var _0x14ba8f,_0x54bf61,_0x3eb9b9,_0x180bd9;try{const {extend:_0x4709c5,isSaveImg:_0x277a64,fileInfo:_0x20cd96}=_0x3ac995,_0x8a3e81=(_0x54bf61=(_0x14ba8f=JSON['parse'](_0x4709c5))===null||_0x14ba8f===void 0x0?void 0x0:_0x14ba8f['attachments'][0x0])===null||_0x54bf61===void 0x0?void 0x0:_0x54bf61[_0x5a564a(0x267)];_0x3ac995[_0x5a564a(0x1df)]=this[_0x5a564a(0x249)](_0x20cd96,_0x277a64,_0x5864a8,_0x8a3e81),_0x3ac995[_0x5a564a(0x196)]=((_0x180bd9=(_0x3eb9b9=JSON[_0x5a564a(0x1cc)](_0x4709c5))===null||_0x3eb9b9===void 0x0?void 0x0:_0x3eb9b9[_0x5a564a(0x1ef)][0x0])===null||_0x180bd9===void 0x0?void 0x0:_0x180bd9[_0x5a564a(0x1ef)][0x0][_0x5a564a(0x211)])==='U1',_0x3ac995[_0x5a564a(0x231)]=_0x8a3e81;}catch(_0xd4a2e3){}});if(Number(size)===0x3e7){const _0x46bc0d={'rows':_0x41c0d3[_0x365f34(0x17d)](_0x50a7db=>{const {fileInfo:_0x16a8b1,prompt:_0x32ad55,createdAt:_0x4cea13,id:_0x3e4d22,fullPrompt:_0x449a15,rec:_0x36b6e0,originUrl:_0x375965}=_0x50a7db;return{'fileInfo':_0x16a8b1,'prompt':_0x32ad55,'createdAt':_0x4cea13,'id':_0x3e4d22,'fullPrompt':_0x449a15,'rec':_0x36b6e0,'originUrl':_0x375965};}),'count':_0xf8d790};return await this[_0x365f34(0x1c0)][_0x365f34(0x1e7)]({'key':_0x365f34(0x200),'val':JSON['stringify'](_0x46bc0d)},0x3c*0x5),_0x46bc0d;}const _0x58ac8b={'rows':_0x41c0d3,'count':_0xf8d790};return _0x58ac8b;}async[_0x533400(0x1a9)](_0x563405){const _0x2a08b0=_0x533400,_0xdb9390=await this[_0x2a08b0(0x182)]['findOne']({'where':{'id':_0x563405}});if(!_0xdb9390)return'';const {fullPrompt:_0x3c0a57}=_0xdb9390;return _0x3c0a57;}async['getAdminDrawList'](_0x11518b,_0x2a3f19){const _0x4c3108=_0x533400;try{const {page:page=0x1,size:size=0xa,rec:_0x3ba343,userId:_0x23ff5a,status:_0x3a4005}=_0x2a3f19,_0x5c3e2c={'isDelete':0x0};_0x3ba343&&Object[_0x4c3108(0x247)](_0x5c3e2c,{'rec':_0x3ba343}),_0x23ff5a&&Object[_0x4c3108(0x247)](_0x5c3e2c,{'userId':_0x23ff5a}),_0x3a4005&&Object[_0x4c3108(0x247)](_0x5c3e2c,{'status':_0x3a4005});const [_0x1d6e0d,_0x41e11a]=await this[_0x4c3108(0x182)][_0x4c3108(0x184)]({'where':_0x5c3e2c,'order':{'id':_0x4c3108(0x188)},'take':size,'skip':(page-0x1)*size}),_0x96d9e5=_0x1d6e0d['map'](_0x5a8119=>_0x5a8119[_0x4c3108(0x205)])[_0x4c3108(0x266)](_0x60bb8d=>_0x60bb8d<0x186a0),_0x424ec2=await this[_0x4c3108(0x1dd)][_0x4c3108(0x1d0)]({'where':{'id':(0x0,typeorm_2['In'])(_0x96d9e5)},'select':['id',_0x4c3108(0x18d),'avatar',_0x4c3108(0x20b)]});_0x1d6e0d[_0x4c3108(0x19c)](_0x5c7aa3=>{const _0x33af3a=_0x4c3108;_0x5c7aa3['userInfo']=_0x424ec2[_0x33af3a(0x1d0)](_0x58eec6=>_0x58eec6['id']===_0x5c7aa3[_0x33af3a(0x205)]);});const _0x59d13b=await this[_0x4c3108(0x1be)]['getConfigs']([_0x4c3108(0x1b3)]);return _0x1d6e0d[_0x4c3108(0x19c)](_0x4a2bb8=>{const _0x30c426=_0x4c3108;var _0x3b29c5,_0x37f1f5,_0x55e92f,_0x492ffe;try{const {extend:_0x310d72,isSaveImg:_0x2ebf8c,fileInfo:_0x31e366}=_0x4a2bb8,_0x31a77a=(_0x37f1f5=(_0x3b29c5=JSON[_0x30c426(0x1cc)](_0x310d72))===null||_0x3b29c5===void 0x0?void 0x0:_0x3b29c5['attachments'][0x0])===null||_0x37f1f5===void 0x0?void 0x0:_0x37f1f5[_0x30c426(0x267)];_0x4a2bb8['fileInfo']=JSON[_0x30c426(0x1cc)](_0x31e366),_0x4a2bb8[_0x30c426(0x196)]=((_0x492ffe=(_0x55e92f=JSON[_0x30c426(0x1cc)](_0x310d72))===null||_0x55e92f===void 0x0?void 0x0:_0x55e92f[_0x30c426(0x1ef)][0x0])===null||_0x492ffe===void 0x0?void 0x0:_0x492ffe[_0x30c426(0x1ef)][0x0]['label'])==='U1',_0x4a2bb8['originUrl']=_0x31a77a;}catch(_0x30b61f){}}),_0x11518b[_0x4c3108(0x199)][_0x4c3108(0x202)]!==_0x4c3108(0x1ea)&&_0x1d6e0d[_0x4c3108(0x19c)](_0x7e515d=>{const _0x48998d=_0x4c3108;_0x7e515d[_0x48998d(0x193)]&&_0x7e515d['userInfo']['email']&&(_0x7e515d[_0x48998d(0x193)][_0x48998d(0x20b)]=_0x7e515d[_0x48998d(0x193)][_0x48998d(0x20b)][_0x48998d(0x201)](/(.{2}).+(.{2}@.+)/,_0x48998d(0x17b)));}),{'rows':_0x1d6e0d,'count':_0x41e11a};}catch(_0x1ce32b){throw new common_1[(_0x4c3108(0x1ad))]('查询失败！',common_1['HttpStatus'][_0x4c3108(0x190)]);}}async[_0x533400(0x1c3)](_0xe13241){const _0x365efa=_0x533400,{id:_0x14e2c3}=_0xe13241,_0x1dae99=await this['midjourneyEntity']['findOne']({'where':{'id':_0x14e2c3,'status':0x3,'isDelete':0x0}});if(!_0x1dae99)throw new common_1[(_0x365efa(0x1ad))](_0x365efa(0x185),common_1[_0x365efa(0x192)]['BAD_REQUEST']);const {rec:_0x3ba698}=_0x1dae99,_0x4dfadf=await this['midjourneyEntity'][_0x365efa(0x218)]({'id':_0x14e2c3},{'rec':_0x3ba698===0x1?0x0:0x1});if(_0x4dfadf['affected']>0x0)return'操作成功！';}async[_0x533400(0x1d5)](_0x5ce6e4){const _0x2ce4ea=_0x533400,{id:_0x15712f,category_id:_0x2a1dcf}=_0x5ce6e4,_0x6ea2dc=await this['midjourneyEntity'][_0x2ce4ea(0x19e)]({'where':{'id':_0x15712f,'status':0x3,'isDelete':0x0}});if(!_0x6ea2dc)throw new common_1[(_0x2ce4ea(0x1ad))]('当前图片不存在！',common_1['HttpStatus'][_0x2ce4ea(0x190)]);const _0x39dba1=await this[_0x2ce4ea(0x182)]['update']({'id':_0x15712f},{'category_id':_0x2a1dcf});if(_0x39dba1[_0x2ce4ea(0x26a)]>0x0)return'操作成功！';}async['cleanQueue'](){const _0x4a402b=_0x533400;try{await this[_0x4a402b(0x182)][_0x4a402b(0x218)]({'status':0x2},{'status':0x4});}catch(_0x1c9503){console[_0x4a402b(0x191)](_0x4a402b(0x1c9),_0x1c9503);}}async[_0x533400(0x1d1)](_0x4b1638,_0x1f0ee5){const _0x102536=_0x533400,{id:_0x572b9a}=_0x1f0ee5;if(!_0x572b9a)throw new common_1['HttpException'](_0x102536(0x25e),common_1[_0x102536(0x192)]['BAD_REQUEST']);const _0x5763f4=await this[_0x102536(0x182)][_0x102536(0x21e)]({'id':_0x572b9a});if(_0x5763f4[_0x102536(0x26a)]>0x0)return _0x102536(0x258);else throw new common_1[(_0x102536(0x1ad))](_0x102536(0x1f1),common_1[_0x102536(0x192)][_0x102536(0x190)]);}async[_0x533400(0x246)](_0x5ae700,_0x1c1bd4){const _0x51e878=_0x533400;try{const {prompt:_0x433b43,status:_0x5839d9,isCarryParams:_0x56d9a2,title:_0x15fbc6,order:_0x59125f,id:_0x6dea07,aspect:_0x3212ad}=_0x1c1bd4;return _0x6dea07?await this[_0x51e878(0x1cf)][_0x51e878(0x218)]({'id':_0x6dea07},{'prompt':_0x433b43,'status':_0x5839d9,'isCarryParams':_0x56d9a2,'order':_0x59125f,'aspect':_0x3212ad}):await this['mjPromptsEntity'][_0x51e878(0x1de)]({'prompt':_0x433b43,'status':_0x5839d9,'isCarryParams':_0x56d9a2,'title':_0x15fbc6,'order':_0x59125f,'aspect':_0x3212ad});}catch(_0x9d48cf){console[_0x51e878(0x191)](_0x51e878(0x183),_0x9d48cf);}}async[_0x533400(0x25c)](_0x5bf1aa,_0x464e33){const _0x1a44fe=_0x533400,{id:_0x2c58e1}=_0x464e33;if(!_0x2c58e1)throw new common_1[(_0x1a44fe(0x1ad))]('非法操作！',common_1[_0x1a44fe(0x192)]['BAD_REQUEST']);return await this[_0x1a44fe(0x1cf)]['delete']({'id':_0x2c58e1});}async[_0x533400(0x1e3)](){const _0x19da07=_0x533400;return await this[_0x19da07(0x1cf)]['find']({'order':{'order':_0x19da07(0x188)}});}async[_0x533400(0x204)](_0x1a2750){const _0x43d1b3=_0x533400,{url:_0x359dc2}=_0x1a2750;if(!_0x359dc2)return;const _0x460fef=await axios_1[_0x43d1b3(0x23f)][_0x43d1b3(0x24b)](_0x359dc2,{'responseType':_0x43d1b3(0x18c)}),_0x4ef284=Buffer[_0x43d1b3(0x1b9)](_0x460fef[_0x43d1b3(0x20a)])[_0x43d1b3(0x1c8)](_0x43d1b3(0x1e9));return _0x4ef284;}[_0x533400(0x1cb)](_0xf58b88){const _0x887889=_0x533400,_0x2ccd3f=_0x887889(0x18b),_0x1ef46d=_0xf58b88[_0x887889(0x1ae)]('.')?_0xf58b88:'.'+_0xf58b88;let _0x3e9b82='';for(let _0x137174=0x0;_0x137174<0xa;_0x137174++){_0x3e9b82+=_0x2ccd3f[_0x887889(0x220)](Math['floor'](Math[_0x887889(0x203)]()*_0x2ccd3f[_0x887889(0x1a1)]));}return''+_0x3e9b82+_0x1ef46d;}};MidjourneyService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x533400(0x1aa)])(midjourney_entity_1[_0x533400(0x1db)])),__param(0x1,(0x0,typeorm_1[_0x533400(0x1aa)])(user_entity_1[_0x533400(0x24a)])),__param(0x2,(0x0,typeorm_1[_0x533400(0x1aa)])(prompt_entity_1['mjPromptEntity'])),__metadata(_0x533400(0x22b),[typeorm_2[_0x533400(0x21f)],typeorm_2[_0x533400(0x21f)],typeorm_2[_0x533400(0x21f)],globalConfig_service_1[_0x533400(0x1f9)],upload_service_1[_0x533400(0x1e5)],badwords_service_1['BadwordsService'],userBalance_service_1[_0x533400(0x17a)],redisCache_service_1[_0x533400(0x21c)]])],MidjourneyService),exports['MidjourneyService']=MidjourneyService;