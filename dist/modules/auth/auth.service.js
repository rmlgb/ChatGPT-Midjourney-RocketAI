'use strict';function _0x47b2(_0x2d8a19,_0x3fcd25){const _0x2f0dcf=_0x2f0d();return _0x47b2=function(_0x47b2e9,_0x178629){_0x47b2e9=_0x47b2e9-0x148;let _0x5608ea=_0x2f0dcf[_0x47b2e9];return _0x5608ea;},_0x47b2(_0x2d8a19,_0x3fcd25);}const _0x10bbc0=_0x47b2;(function(_0x3fc48a,_0x2c5494){const _0x4d6442=_0x47b2,_0x1271ab=_0x3fc48a();while(!![]){try{const _0x501eda=parseInt(_0x4d6442(0x155))/0x1*(parseInt(_0x4d6442(0x1c2))/0x2)+parseInt(_0x4d6442(0x167))/0x3*(parseInt(_0x4d6442(0x1a5))/0x4)+parseInt(_0x4d6442(0x148))/0x5+parseInt(_0x4d6442(0x1d4))/0x6*(-parseInt(_0x4d6442(0x159))/0x7)+-parseInt(_0x4d6442(0x1a6))/0x8+parseInt(_0x4d6442(0x15a))/0x9*(-parseInt(_0x4d6442(0x16a))/0xa)+parseInt(_0x4d6442(0x15c))/0xb*(parseInt(_0x4d6442(0x195))/0xc);if(_0x501eda===_0x2c5494)break;else _0x1271ab['push'](_0x1271ab['shift']());}catch(_0x48babc){_0x1271ab['push'](_0x1271ab['shift']());}}}(_0x2f0d,0xc3bf5));var __decorate=this&&this[_0x10bbc0(0x14c)]||function(_0x177450,_0x445599,_0x5641a1,_0x68baa6){const _0x1d1ff1=_0x10bbc0;var _0xa768a6=arguments[_0x1d1ff1(0x1bc)],_0x511fd7=_0xa768a6<0x3?_0x445599:_0x68baa6===null?_0x68baa6=Object[_0x1d1ff1(0x152)](_0x445599,_0x5641a1):_0x68baa6,_0x1597e7;if(typeof Reflect===_0x1d1ff1(0x1d1)&&typeof Reflect[_0x1d1ff1(0x162)]===_0x1d1ff1(0x1a4))_0x511fd7=Reflect['decorate'](_0x177450,_0x445599,_0x5641a1,_0x68baa6);else{for(var _0x1b479e=_0x177450['length']-0x1;_0x1b479e>=0x0;_0x1b479e--)if(_0x1597e7=_0x177450[_0x1b479e])_0x511fd7=(_0xa768a6<0x3?_0x1597e7(_0x511fd7):_0xa768a6>0x3?_0x1597e7(_0x445599,_0x5641a1,_0x511fd7):_0x1597e7(_0x445599,_0x5641a1))||_0x511fd7;}return _0xa768a6>0x3&&_0x511fd7&&Object['defineProperty'](_0x445599,_0x5641a1,_0x511fd7),_0x511fd7;},__metadata=this&&this['__metadata']||function(_0x13659b,_0xc7dd2b){const _0x143262=_0x10bbc0;if(typeof Reflect==='object'&&typeof Reflect[_0x143262(0x1c9)]===_0x143262(0x1a4))return Reflect['metadata'](_0x13659b,_0xc7dd2b);},__param=this&&this[_0x10bbc0(0x194)]||function(_0x17eecc,_0xae07d7){return function(_0x86ee40,_0x599241){_0xae07d7(_0x86ee40,_0x599241,_0x17eecc);};};function _0x2f0d(){const _0x3f2acf=['avatar','getInfo','activateAccount','updateUserPassword','../../common/constants/verification.constant','forEach','VerificationEnum','address','getClientIp','&registerFailEmailTitle=','hashSync','getNamespace','saveToken','verifyUserCredentials','__param','108WcAJKr','find','loginByPhone','captcha','getConfigs','oldPassword','addBalanceToNewUser','onModuleInit','../globalConfig/config.entity','text','configVal','../../common/constants/user.constant','createRandomCode','toString','verifyUserPassword','function','1396pjUPeD','2778032pXVLGe','reduce','userBalanceService','svg-captcha','globalConfigService','UserStatusEnum','../globalConfig/globalConfig.service','./../verification/verification.service','createMathExpr','无权此操作、请联系管理员！','@nestjs/typeorm','log','../user/user.service','set','ConfigEntity','registerSuccessEmailTitle','registerFailEmailTeamName','sendSMS','smsBaoStatus','registerSuccessEmailTeamName','#fff','../mailer/mailer.service','length','get','/api/auth/registerError?message=','账户已被激活过','getUserStatus','updateUserStatus','521380lRMkdW','user','qureyUserInfoByInviteCode','&registerSuccessEmailTeamName=','&registerSuccessEmailTitle=','createUser','password','metadata','验证码填写错误、请重新输入！','networkInterfaces','验证码类型错误','getIp','Repository','@nestjs/common','queryUserInfoById','object','verifyUserRegisterByPhone',':CAPTCHA:','6LVlFmn','sendPhoneCode','bcryptjs','VerificationService','registerByPhone','5236175XESzDk','InjectRepository','&registerSuccessEmaileAppend=',':PHONECODE:','__decorate','Registration','秒内不得重复发送短信！','RedisCacheService','userService','HttpStatus','getOwnPropertyDescriptor','旧密码错误、请检查提交','&registerFailEmailTeamName=','2oYvMej','redisCacheService','@rocket.com','verificationService','7747607oRNGXK','936LEmlTu','MailerService','2275878WOTwUo','design:paramtypes','family','response','无权此操作！','redirect','decorate','HttpException','updatePassword','error:\x20','typeorm','525VhewHW','jwtService','BAD_REQUEST','118840cOnSJz','configEntity','createUserAndVerifycation','aliPhoneStatus','login','UserService','/api/auth/registerSuccess?id=','client','密码修改成功','mailerService','&username=','非法操作、请联系管理员！','registerFailEmailTitle','updatePassByOther','UserStatusErrMsg','savaLoginIp','ttl','userDefautlAvatar','&email=','verifyCaptcha','../userBalance/userBalance.service','Injectable','createRandomUid','AuthService','UserBalanceService','sign','registerSuccessEmaileAppend','ACTIVE'];_0x2f0d=function(){return _0x3f2acf;};return _0x2f0d();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x10bbc0(0x181)]=void 0x0;const globalConfig_service_1=require(_0x10bbc0(0x1ac)),verification_constant_1=require(_0x10bbc0(0x18a)),verification_service_1=require(_0x10bbc0(0x1ad)),common_1=require(_0x10bbc0(0x1cf)),jwt_1=require('@nestjs/jwt'),user_service_1=require(_0x10bbc0(0x1b2)),mailer_service_1=require(_0x10bbc0(0x1bb)),user_constant_1=require(_0x10bbc0(0x1a0)),userBalance_service_1=require(_0x10bbc0(0x17e)),config_entity_1=require(_0x10bbc0(0x19d)),typeorm_1=require(_0x10bbc0(0x166)),typeorm_2=require(_0x10bbc0(0x1b0)),utils_1=require('../../common/utils'),os=require('os'),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require(_0x10bbc0(0x1a9)),bcrypt=require(_0x10bbc0(0x1d6));let AuthService=class AuthService{constructor(_0x2e4552,_0x48a26c,_0x22986b,_0x5b6372,_0x265b99,_0x276d10,_0x45da16,_0x2d5b72){const _0x1570bf=_0x10bbc0;this[_0x1570bf(0x16b)]=_0x2e4552,this[_0x1570bf(0x150)]=_0x48a26c,this[_0x1570bf(0x168)]=_0x22986b,this[_0x1570bf(0x173)]=_0x5b6372,this[_0x1570bf(0x158)]=_0x265b99,this[_0x1570bf(0x1a8)]=_0x276d10,this['redisCacheService']=_0x45da16,this[_0x1570bf(0x1aa)]=_0x2d5b72;}async[_0x10bbc0(0x19c)](){const _0x4a1e1d=_0x10bbc0;this[_0x4a1e1d(0x1cd)]();}async['register'](_0x8f7c03,_0x258be6){const _0xffadc3=_0x10bbc0;await this[_0xffadc3(0x158)][_0xffadc3(0x17d)](_0x8f7c03);const _0x2df8e1=await this[_0xffadc3(0x150)][_0xffadc3(0x16c)](_0x8f7c03,_0x258be6),{username:_0x418952,email:_0x507766,client:_0x5b9f45,id:_0x564bdc}=_0x2df8e1,_0x741829={'username':_0x418952,'email':_0x507766,'id':_0x564bdc};return _0x5b9f45&&(_0x741829[_0xffadc3(0x171)]=_0x5b9f45),_0x741829;}async[_0x10bbc0(0x1d8)](_0x366657,_0x473ee2){const _0x2f05bd=_0x10bbc0,{username:_0x4f47fe,password:_0x573b4b,phone:_0x40375,phoneCode:_0x50d895,invitedBy:_0x34aed8}=_0x366657;await this['userService'][_0x2f05bd(0x1d2)](_0x366657);const _0x232dd3=await this[_0x2f05bd(0x1aa)][_0x2f05bd(0x191)](),_0x5cd150=_0x232dd3+_0x2f05bd(0x14b)+_0x40375,_0xadeaf4=await this[_0x2f05bd(0x156)][_0x2f05bd(0x1bd)]({'key':_0x5cd150});if(!_0xadeaf4)throw new common_1[(_0x2f05bd(0x163))]('验证码已过期、请重新发送！',common_1[_0x2f05bd(0x151)][_0x2f05bd(0x169)]);if(_0x50d895!==_0xadeaf4)throw new common_1[(_0x2f05bd(0x163))](_0x2f05bd(0x1ca),common_1[_0x2f05bd(0x151)][_0x2f05bd(0x169)]);const _0x300ab9=(0x0,utils_1['createRandomUid'])()+_0x2f05bd(0x157),_0x766a72={'username':_0x4f47fe,'password':_0x573b4b,'phone':_0x40375,'invitedBy':_0x34aed8,'email':_0x300ab9,'status':user_constant_1['UserStatusEnum'][_0x2f05bd(0x185)]},_0xfdff67=await this[_0x2f05bd(0x1aa)][_0x2f05bd(0x199)]([_0x2f05bd(0x17b)]);_0x766a72[_0x2f05bd(0x186)]=_0xfdff67;const _0x13dc90=bcrypt[_0x2f05bd(0x190)](_0x573b4b,0xa);_0x766a72[_0x2f05bd(0x1c8)]=_0x13dc90;const _0x4e8297=await this[_0x2f05bd(0x150)][_0x2f05bd(0x1c7)](_0x766a72);let _0x1f8b12;_0x34aed8&&(_0x1f8b12=await this[_0x2f05bd(0x150)]['qureyUserInfoByInviteCode'](_0x34aed8));await this[_0x2f05bd(0x1a8)][_0x2f05bd(0x19b)](_0x4e8297['id'],_0x1f8b12===null||_0x1f8b12===void 0x0?void 0x0:_0x1f8b12['id']);return;}async[_0x10bbc0(0x16e)](_0x2443b3,_0x335c02){const _0x379a76=_0x10bbc0,_0x1b3e4a=await this[_0x379a76(0x150)][_0x379a76(0x193)](_0x2443b3),{username:_0x1a40b4,id:_0xa2518b,email:_0x4d2c2e,role:_0x4bf272,openId:_0x3f61ed,client:_0x1173b1}=_0x1b3e4a,_0x3e9ccb=(0x0,utils_1[_0x379a76(0x18e)])(_0x335c02);await this[_0x379a76(0x150)]['savaLoginIp'](_0xa2518b,_0x3e9ccb);const _0x2bf7ff=await this['jwtService'][_0x379a76(0x183)]({'username':_0x1a40b4,'id':_0xa2518b,'email':_0x4d2c2e,'role':_0x4bf272,'openId':_0x3f61ed,'client':_0x1173b1});return await this[_0x379a76(0x156)][_0x379a76(0x192)](_0xa2518b,_0x2bf7ff),_0x2bf7ff;}async[_0x10bbc0(0x197)](_0x1a948e,_0x5d0318){const _0x2dfd04=_0x10bbc0,_0x43de96=await this[_0x2dfd04(0x150)][_0x2dfd04(0x193)](_0x1a948e),{username:_0x2a5d27,id:_0x11afdf,email:_0x5d8e98,role:_0x929e73,openId:_0x20c1b4,client:_0x19e696}=_0x43de96,_0x171056=(0x0,utils_1['getClientIp'])(_0x5d0318);await this['userService'][_0x2dfd04(0x179)](_0x11afdf,_0x171056);const {phone:_0x1dd4ae}=_0x1a948e,_0x1fe150=await this[_0x2dfd04(0x168)][_0x2dfd04(0x183)]({'username':_0x2a5d27,'id':_0x11afdf,'email':_0x5d8e98,'role':_0x929e73,'openId':_0x20c1b4,'client':_0x19e696,'phone':_0x1dd4ae});return await this['redisCacheService'][_0x2dfd04(0x192)](_0x11afdf,_0x1fe150),_0x1fe150;}async['loginByOpenId'](_0x578e59,_0xefe969){const _0x463a19=_0x10bbc0,{status:_0x734799}=_0x578e59;if(_0x734799!==user_constant_1[_0x463a19(0x1ab)][_0x463a19(0x185)])throw new common_1[(_0x463a19(0x163))](user_constant_1[_0x463a19(0x178)][_0x734799],common_1[_0x463a19(0x151)][_0x463a19(0x169)]);const {username:_0x3a635b,id:_0x4ecbe8,email:_0x45e7b9,role:_0x2a0a52,openId:_0xa17b24,client:_0x3e84e1}=_0x578e59,_0x1ff969=(0x0,utils_1['getClientIp'])(_0xefe969);await this['userService'][_0x463a19(0x179)](_0x4ecbe8,_0x1ff969);const _0x3ffa8a=await this['jwtService'][_0x463a19(0x183)]({'username':_0x3a635b,'id':_0x4ecbe8,'email':_0x45e7b9,'role':_0x2a0a52,'openId':_0xa17b24,'client':_0x3e84e1});return await this[_0x463a19(0x156)][_0x463a19(0x192)](_0x4ecbe8,_0x3ffa8a),_0x3ffa8a;}async[_0x10bbc0(0x187)](_0x270ce8){const _0x5a7c60=_0x10bbc0,{id:_0x4cee58}=_0x270ce8[_0x5a7c60(0x1c3)];return await this[_0x5a7c60(0x150)]['getUserInfo'](_0x4cee58);}async[_0x10bbc0(0x188)](_0x5bd2ee,_0x4068e7){const _0x1b4ce8=_0x10bbc0,_0x26c727=await this[_0x1b4ce8(0x16b)][_0x1b4ce8(0x196)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x1b4ce8(0x1b5),_0x1b4ce8(0x1b9),'registerSuccessEmaileAppend',_0x1b4ce8(0x176),_0x1b4ce8(0x1b6)])}}),_0x1cdfba=_0x26c727[_0x1b4ce8(0x1a7)]((_0x5ad35b,_0x5c800a)=>{const _0x5a37d1=_0x1b4ce8;return _0x5ad35b[_0x5c800a['configKey']]=_0x5c800a[_0x5a37d1(0x19f)],_0x5ad35b;},{});try{const _0x10cb21=await this[_0x1b4ce8(0x158)]['verifyCode'](_0x5bd2ee,verification_constant_1[_0x1b4ce8(0x18c)][_0x1b4ce8(0x14d)]),{type:_0x263dce,userId:_0x494222}=_0x10cb21;if(_0x263dce!==verification_constant_1[_0x1b4ce8(0x18c)]['Registration'])throw new common_1[(_0x1b4ce8(0x163))](_0x1b4ce8(0x1cc),common_1[_0x1b4ce8(0x151)][_0x1b4ce8(0x169)]);const _0x29a5fc=await this[_0x1b4ce8(0x150)][_0x1b4ce8(0x1c0)](_0x494222);if(_0x29a5fc===user_constant_1[_0x1b4ce8(0x1ab)][_0x1b4ce8(0x185)])throw new common_1['HttpException'](_0x1b4ce8(0x1bf),common_1['HttpStatus']['BAD_REQUEST']);await this[_0x1b4ce8(0x150)][_0x1b4ce8(0x1c1)](_0x10cb21['userId'],user_constant_1['UserStatusEnum'][_0x1b4ce8(0x185)]);const _0x1be99b=await this['userService'][_0x1b4ce8(0x1d0)](_0x10cb21['userId']),{username:_0x3db3da,email:_0x4a1074,id:_0x5482a0,invitedBy:_0x829f7}=_0x1be99b;let _0x307f01;_0x829f7&&(_0x307f01=await this[_0x1b4ce8(0x150)][_0x1b4ce8(0x1c4)](_0x829f7)),await this['userBalanceService'][_0x1b4ce8(0x19b)](_0x5482a0,_0x307f01===null||_0x307f01===void 0x0?void 0x0:_0x307f01['id']),_0x4068e7[_0x1b4ce8(0x161)](_0x1b4ce8(0x170)+_0x5482a0[_0x1b4ce8(0x1a2)]()['padStart'](0x4,'0')+_0x1b4ce8(0x174)+_0x3db3da+_0x1b4ce8(0x17c)+_0x4a1074+_0x1b4ce8(0x1c6)+_0x1cdfba['registerSuccessEmailTitle']+_0x1b4ce8(0x1c5)+_0x1cdfba[_0x1b4ce8(0x1b9)]+_0x1b4ce8(0x14a)+_0x1cdfba[_0x1b4ce8(0x184)]);}catch(_0x53a3da){console[_0x1b4ce8(0x1b1)](_0x1b4ce8(0x165),_0x53a3da);const _0x12a3da=_0x53a3da[_0x1b4ce8(0x15f)];_0x4068e7['redirect'](_0x1b4ce8(0x1be)+_0x12a3da+_0x1b4ce8(0x18f)+_0x1cdfba[_0x1b4ce8(0x176)]+_0x1b4ce8(0x154)+_0x1cdfba[_0x1b4ce8(0x1b6)]);}}async[_0x10bbc0(0x164)](_0x3e5415,_0x53bf8a){const _0x38f0ff=_0x10bbc0,{id:_0xf4c48,client:_0x1106e8,role:_0x362f7b}=_0x3e5415['user'];if(_0x1106e8&&Number(_0x1106e8)>0x0)throw new common_1[(_0x38f0ff(0x163))](_0x38f0ff(0x1af),common_1[_0x38f0ff(0x151)][_0x38f0ff(0x169)]);if(_0x362f7b==='admin')throw new common_1['HttpException'](_0x38f0ff(0x175),common_1['HttpStatus']['BAD_REQUEST']);const _0x283e9a=await this[_0x38f0ff(0x150)][_0x38f0ff(0x1a3)](_0xf4c48,_0x53bf8a[_0x38f0ff(0x19a)]);if(!_0x283e9a)throw new common_1['HttpException'](_0x38f0ff(0x153),common_1[_0x38f0ff(0x151)]['BAD_REQUEST']);return this['userService'][_0x38f0ff(0x189)](_0xf4c48,_0x53bf8a[_0x38f0ff(0x1c8)]),_0x38f0ff(0x172);}async[_0x10bbc0(0x177)](_0x299da7,_0x3dc0ab){const _0x58fbc1=_0x10bbc0,{id:_0x51f683,client:_0x23e23e}=_0x299da7[_0x58fbc1(0x1c3)];if(!_0x23e23e)throw new common_1[(_0x58fbc1(0x163))](_0x58fbc1(0x160),common_1['HttpStatus'][_0x58fbc1(0x169)]);return this[_0x58fbc1(0x150)][_0x58fbc1(0x189)](_0x51f683,_0x3dc0ab[_0x58fbc1(0x1c8)]),_0x58fbc1(0x172);}['getIp'](){const _0x6f1267=_0x10bbc0;let _0x4f289d;const _0x448238=os[_0x6f1267(0x1cb)]();Object['keys'](_0x448238)[_0x6f1267(0x18b)](_0x2d151d=>{const _0x32dea2=_0x6f1267,_0x4f1fb0=_0x448238[_0x2d151d];for(let _0x22f2bc=0x0;_0x22f2bc<_0x4f1fb0['length'];_0x22f2bc++){const _0x120dbb=_0x4f1fb0[_0x22f2bc];if(_0x120dbb[_0x32dea2(0x15e)]==='IPv4'&&_0x120dbb['address']!=='127.0.0.1'&&!_0x120dbb['internal']){_0x4f289d=_0x120dbb[_0x32dea2(0x18d)];break;}}}),this['ipAddress']=_0x4f289d;}async[_0x10bbc0(0x198)](_0x1daaa1){const _0x56be04=_0x10bbc0,_0x3c533b=await this[_0x56be04(0x1aa)][_0x56be04(0x191)](),{color:color=_0x56be04(0x1ba)}=_0x1daaa1,_0x2f7c7f=svgCaptcha[_0x56be04(0x1ae)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x5c9cac=_0x2f7c7f['text'],_0x31f82d=(0x0,utils_1[_0x56be04(0x180)])(),_0xe1c9f0=_0x3c533b+_0x56be04(0x1d3)+_0x31f82d;return await this[_0x56be04(0x156)][_0x56be04(0x1b3)]({'key':_0xe1c9f0,'val':_0x2f7c7f[_0x56be04(0x19e)]},0x5*0x3c),{'svgCode':_0x2f7c7f['data'],'code':_0x31f82d};}async[_0x10bbc0(0x1d5)](_0xbdc5f7){const _0x5ed5c0=_0x10bbc0,{phone:_0x2457f7}=_0xbdc5f7,_0x56ebef=await this[_0x5ed5c0(0x1aa)][_0x5ed5c0(0x191)](),_0x2ca094=_0x56ebef+_0x5ed5c0(0x14b)+_0x2457f7,_0x55bfe9=await this[_0x5ed5c0(0x156)][_0x5ed5c0(0x17a)](_0x2ca094);if(_0x55bfe9&&_0x55bfe9>0x0)throw new common_1[(_0x5ed5c0(0x163))](_0x55bfe9+_0x5ed5c0(0x14e),common_1['HttpStatus'][_0x5ed5c0(0x169)]);const _0x40394c=(0x0,utils_1[_0x5ed5c0(0x1a1)])(),_0x59a198={'phone':_0x2457f7,'code':_0x40394c};if(await this['globalConfigService'][_0x5ed5c0(0x199)]([_0x5ed5c0(0x16d)])==0x1)await this[_0x5ed5c0(0x158)][_0x5ed5c0(0x1d5)](_0x59a198);else await this[_0x5ed5c0(0x1aa)]['getConfigs']([_0x5ed5c0(0x1b8)])==0x1&&await this[_0x5ed5c0(0x158)][_0x5ed5c0(0x1b7)](_0x59a198);return await this[_0x5ed5c0(0x156)][_0x5ed5c0(0x1b3)]({'key':_0x2ca094,'val':_0x40394c},0x1*0x3c),'验证码发送成功、请填写验证码完成注册！';}['createTokenFromFingerprint'](_0x521ebc){const _0x1f618b=_0x10bbc0,_0x34d6ed=this[_0x1f618b(0x168)][_0x1f618b(0x183)]({'username':'游客'+_0x521ebc,'id':_0x521ebc,'email':_0x521ebc+_0x1f618b(0x157),'role':'visitor','openId':null,'client':null});return _0x34d6ed;}};AuthService=__decorate([(0x0,common_1[_0x10bbc0(0x17f)])(),__param(0x0,(0x0,typeorm_2[_0x10bbc0(0x149)])(config_entity_1[_0x10bbc0(0x1b4)])),__metadata(_0x10bbc0(0x15d),[typeorm_1[_0x10bbc0(0x1ce)],user_service_1[_0x10bbc0(0x16f)],jwt_1['JwtService'],mailer_service_1[_0x10bbc0(0x15b)],verification_service_1[_0x10bbc0(0x1d7)],userBalance_service_1[_0x10bbc0(0x182)],redisCache_service_1[_0x10bbc0(0x14f)],globalConfig_service_1['GlobalConfigService']])],AuthService),exports[_0x10bbc0(0x181)]=AuthService;